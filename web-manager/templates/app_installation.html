
    <script>
        // Show/hide GitHub token field based on selected method
        document.addEventListener('DOMContentLoaded', function() {
            const authMethodSelect = document.getElementById('auth-method');
            const githubTokenRow = document.getElementById('github-token-row');
            
            function toggleAuthFields() {
                const method = authMethodSelect.value;
                
                if (method === 'token') {
                    githubTokenRow.style.display = 'block';
                } else {
                    githubTokenRow.style.display = 'none';
                }
            }
            
            // Initial toggle
            toggleAuthFields();
            
            // Add event listener
            authMethodSelect.addEventListener('change', toggleAuthFields);
        });
    </script>
{% extends "base.html" %}

{% block title %}App Installation - Web Docker Manager{% endblock %}

{% block custom_css %}
/* Global Loader Styles */
.global-loader {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.loader-content {
    background: white;
    padding: 2rem;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #007bff;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loader-text {
    color: #333;
    font-weight: 500;
    margin: 0;
}

/* Button loading state */
.btn-loading {
    position: relative;
    pointer-events: none;
    opacity: 0.7;
}

.btn-loading::after {
    content: "";
    position: absolute;
    width: 16px;
    height: 16px;
    margin: auto;
    border: 2px solid transparent;
    border-top-color: #ffffff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    top: 0;
    left: 0;
    bottom: 0;
    right: 0;
}

.app-installation-card {
    margin-bottom: 20px;
    transition: transform 0.2s ease-in-out;
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.app-installation-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.terminal-container {
    background-color: #1a1a1a;
    color: #00ff41;
    font-family: 'Courier New', monospace;
    padding: 0;
    border-radius: 8px;
    height: 600px;
    overflow: hidden;
    margin-bottom: 20px;
    border: 1px solid #333;
}

/* Frappe Cloud-like styling */
.frappe-cloud-card {
    border: 1px solid #e1e5e9;
    border-radius: 8px;
    background: #fff;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    transition: all 0.2s ease;
}

.frappe-cloud-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    border-color: #007bff;
}

.container-card {
    border-left: 4px solid #007bff;
    padding: 1rem;
    margin-bottom: 1rem;
}

.container-card.running {
    border-left-color: #28a745;
}

.container-card.stopped {
    border-left-color: #dc3545;
}

.app-operation-btn {
    margin: 0.25rem;
    min-width: 120px;
}

.status-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

.operation-log {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 1rem;
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
    max-height: 500px;
    overflow-y: auto;
}

.log-success {
    color: #28a745;
}

.log-error {
    color: #dc3545;
}

.log-warning {
    color: #ffc107;
}

.log-info {
    color: #17a2b8;
}

.log-message {
    white-space: pre-wrap; /* Preserve whitespace and line breaks */
    font-family: monospace; /* Use monospace font for better readability */
    margin-top: 2px;
}

.log-entry {
    margin-bottom: 8px;
    padding: 4px 0;
}

/* Include xterm.js CSS */
@import url('https://cdn.jsdelivr.net/npm/xterm@5.1.0/css/xterm.min.css');
<link rel="stylesheet" href="{{ url_for('static', filename='css/frappe-cloud.css') }}">
{% endblock %}

{% block custom_head %}
<!-- XTerm.js dependencies -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.1.0/css/xterm.min.css">
<script src="https://cdn.jsdelivr.net/npm/xterm@5.1.0/lib/xterm.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.7.0/lib/xterm-addon-fit.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links@0.8.0/lib/xterm-addon-web-links.min.js"></script>
<!-- Include XTermWS script -->
<script src="{{ url_for('static', filename='js/xterm-ws.js') }}"></script>
{% endblock %}

{% block content %}
<!-- Global Loader -->
<div class="global-loader" id="globalLoader">
    <div class="loader-content">
        <div class="spinner"></div>
        <p class="loader-text" id="loaderText">Processing...</p>
    </div>
</div>

<div class="container-fluid mt-4">
    <h1 class="h3 mb-4">
        <i class="bi bi-cloud-arrow-up me-2"></i>Frappe App Management
        <small class="text-muted">- Frappe Cloud-like Interface</small>
    </h1>

    <div class="row">
        <div class="col-md-12">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-tools me-2"></i> App Management Tools
                    </h5>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary btn-sm" id="refresh-containers">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs" id="installTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="ui-panel-tab" data-bs-toggle="tab" data-bs-target="#ui-panel" type="button" role="tab" aria-controls="ui-panel" aria-selected="true">
                                <i class="bi bi-window"></i> App Management
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="console-panel-tab" data-bs-toggle="tab" data-bs-target="#console-panel" type="button" role="tab" aria-controls="console-panel" aria-selected="false">
                                <i class="bi bi-terminal"></i> Access To Container
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="backup-restore-tab" data-bs-toggle="tab" data-bs-target="#backup-restore-panel" type="button" role="tab" aria-controls="backup-restore-panel" aria-selected="false">
                                <i class="bi bi-archive"></i> Backup & Restore
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="logs-operations-tab" data-bs-toggle="tab" data-bs-target="#logs-operations-panel" type="button" role="tab" aria-controls="logs-operations-panel" aria-selected="false">
                                <i class="bi bi-journal-text"></i> Logs & Operations
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="new-site-tab" data-bs-toggle="tab" data-bs-target="#new-site-panel" type="button" role="tab" aria-controls="new-site-panel" aria-selected="false">
                                <i class="bi bi-plus-circle"></i> New Site
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link text-danger fw-bold" id="danger-zone-tab" data-bs-toggle="tab" data-bs-target="#danger-zone-panel" type="button" role="tab" aria-controls="danger-zone-panel" aria-selected="false">
                                <i class="bi bi-exclamation-triangle-fill"></i> Danger Zone
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content mt-3" id="installTabsContent">
                        <!-- UI Panel Tab - Frappe Cloud-like Interface -->
                        <div class="tab-pane fade show active" id="ui-panel" role="tabpanel">
                            <div class="row">
                                <!-- Container Selection -->
                                <div class="col-md-4">
                                    <div class="frappe-cloud-card">
                                        <div class="card-header bg-primary text-white">
                                            <h6 class="mb-0">
                                                <i class="bi bi-server"></i> Select Container
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label for="app-container-select" class="form-label fw-bold">
                                                    <i class="bi bi-terminal"></i> App Server Container
                                                </label>
                                                <select class="form-select" id="app-container-select">
                                                    <option value="">-- Choose a container --</option>
                                                    {% for project_name, project_containers in container_groups.items() %}
                                                        {% for container in project_containers %}
                                                            {% if container.service_type == 'App Server' %}
                                                                <option value="{{ container.name }}" 
                                                                        data-status="{{ container.status }}"
                                                                        data-image="{{ container.image }}">
                                                                    {{ container.name }}
                                                                </option>
                                                            {% endif %}
                                                        {% endfor %}
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            
                                            <!-- Container Info -->
                                            <div id="container-info" class="mt-3" style="display: none;">
                                                <div class="alert alert-info">
                                                    <h6><i class="bi bi-info-circle"></i> Container Information</h6>
                                                    <div id="container-details"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Quick Actions -->
                                    <div class="frappe-cloud-card mt-3">
                                        <div class="card-header bg-success text-white">
                                            <h6 class="mb-0">
                                                <i class="bi bi-lightning"></i> Quick Actions
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="d-grid gap-2">
                                                <button class="btn btn-outline-primary app-operation-btn" id="bench-status">
                                                    <i class="bi bi-check-circle"></i> Bench Status
                                                </button>
                                                <button class="btn btn-outline-info app-operation-btn" id="bench-info">
                                                    <i class="bi bi-info-square"></i> Bench Info
                                                </button>
                                                <button class="btn btn-outline-warning app-operation-btn" id="bench-clear-cache">
                                                    <i class="bi bi-trash"></i> Clear Cache
                                                </button>
                                                <button class="btn btn-outline-secondary app-operation-btn" id="bench-migrate">
                                                    <i class="bi bi-arrow-up-circle"></i> Migrate
                                                </button>
                                            </div>
                                        </div>
                                    </div>


                                    <div class="frappe-cloud-card mt-3">
                                        <div class="card-header bg-success text-white">
                                            <h6 class="mb-0">
                                                <i class="bi bi-lightning"></i> App Management
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="d-grid gap-2">
                                                <button class="btn btn-outline-primary w-100 app-operation-btn" id="uninstall-app-btn">
                                                    <i class="bi bi-trash"></i> Uninstall App
                                                </button>
                                            </div>

                                            <div class="d-grid gap-2">
                                                <button class="btn btn-outline-warning w-100 app-operation-btn" id="update-app-btn">
                                                    <i class="bi bi-arrow-up"></i> Update App
                                                </button>
                                            </div>
                                            <div class="d-grid gap-2">
                                                <button class="btn btn-outline-info w-100 app-operation-btn" id="list-apps-btn">
                                                    <i class="bi bi-list"></i> List Apps
                                                </button>
                                            </div>
                                            <div class="d-grid gap-2">
                                                <button class="btn btn-outline-warning w-100 app-operation-btn" id="fix-apps-txt-btn">
                                                    <i class="bi bi-tools"></i> Fix apps.txt
                                                </button>
                                            </div>
                                            <div class="d-grid gap-2">
                                                <button class="btn btn-outline-secondary w-100 app-operation-btn" id="bench-restart-btn">
                                                    <i class="bi bi-arrow-clockwise"></i> Supervisor Bench Restart
                                                </button>
                                            </div>
                                            <div class="d-grid gap-2">
                                                <button class="btn btn-outline-success w-100 app-operation-btn" id="supervisor-status-btn">
                                                    <i class="bi bi-activity"></i> Supervisor Status
                                                </button>
                                            </div>
                                            <div class="d-grid gap-2">
                                                <button class="btn btn-outline-danger w-100 app-operation-btn" id="open-as-admin-btn">
                                                    <i class="bi bi-shield-lock-fill"></i> Open as Administrator
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                                
                                <!-- App Operations -->
                                <div class="col-md-8">
                                    <div class="frappe-cloud-card mb-4">
                                        <div class="col-md-12">
                                            <!-- Card Header -->
                                            <div class="card-header bg-warning text-dark">
                                                <h6 class="mb-0">
                                                    <i class="bi bi-download"></i> Get App
                                                </h6>
                                            </div>
                                        
                                            <!-- Card Body -->
                                            <div class="card-body">
                                                <div class="mb-4">
                                        
                                                    <div class="row">
                                                        <!-- Repository URL -->
                                                        <div class="col-md-12">
                                                            <div class="mb-3">
                                                                <label for="app-repo-url" class="form-label">Repository URL</label>
                                                                <input type="url" class="form-control" id="app-repo-url"
                                                                    placeholder="https://github.com/frappe/app-name">
                                                            </div>
                                                        </div>
                                        
                                                        <!-- Branch -->
                                                        <div class="col-md-3">
                                                            <div class="mb-3">
                                                                <label for="app-branch" class="form-label">Branch (Optional)</label>
                                                                <input type="text" autocomplete="new-password" class="form-control" id="app-branch"
                                                                    placeholder="main, develop, etc." 
                                                                    name="app-branch-field"
                                                                    readonly onfocus="this.removeAttribute('readonly');">
                                                            </div>
                                                        </div>
                                        
                                                        <!-- Auth Method -->
                                                        <div class="col-md-3">
                                                            <div class="mb-3">
                                                                <label for="auth-method" class="form-label">Auth Method</label>
                                                                <select class="form-select" id="auth-method">
                                                                    <option value="none">Public</option>
                                                                    <option value="token">Private (Token)</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                        
                                                        <!-- Overwrite Checkbox -->
                                                        <div class="col-md-2">
                                                            <div class="mb-3">
                                                                <label class="form-label">&nbsp;</label>
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" id="get-app-overwrite">
                                                                    <label class="form-check-label" for="get-app-overwrite">
                                                                        Overwrite
                                                                    </label>
                                                                </div>
                                                            </div>
                                                        </div>
                                        
                                                        <!-- GitHub Token (Only for private repos) -->
                                                        <div id="github-token-row" style="display: none;">
                                                            <div class="col-md-6">
                                                                <div class="mb-3">
                                                                    <label for="github-token" class="form-label">GitHub Personal Access Token</label>
                                                                    <input type="password" class="form-control" id="github-token"
                                                                        placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                                                                    <div class="form-text">Required for private GitHub repositories</div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                        
                                                </div>
                                            </div>

                                            <!-- Get App Button -->
                                            <div class="card-footer">
                                                <div class="col-md-2 ms-auto"> <!-- ms-auto pushes it to the right -->
                                                    <button class="btn btn-primary w-100" id="get-app-btn">
                                                        <i class="bi bi-download"></i> Get App
                                                    </button>
                                                </div>
                                            </div>

                                        </div>
                                    </div>


                                    <div class="frappe-cloud-card mb-4">
                                        <div class="col-md-12">
                                            <!-- Card Header -->
                                            <div class="card-header bg-success text-dark">
                                                <h6 class="mb-0">
                                                    <i class="bi bi-box-arrow-in-down"></i> Install App
                                                </h6>
                                            </div>

                                            <div class="card-body">
                                                <div class="mb-4">
                                                    <div class="row">
                                                        <div class="col-md-4">
                                                            <div class="mb-3">
                                                                <label for="install-app-name" class="form-label">App Name</label>
                                                                <div class="input-group">
                                                                    <select class="form-select" id="install-app-name">
                                                                        <option value="">Select an app...</option>
                                                                    </select>
                                                                    <button class="btn btn-outline-secondary" type="button" id="refresh-apps-btn" title="Refresh Apps">
                                                                        <i class="bi bi-bootstrap-reboot"></i>
                                                                    </button>
                                                                </div>
                                                                <div class="form-text">Apps will be loaded when you select a container</div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="mb-3">
                                                                <label for="install-site-name" class="form-label">Site Name</label>
                                                                <div class="input-group">
                                                                    <select class="form-select" id="install-site-name">
                                                                        <option value="">Select a site...</option>
                                                                    </select>
                                                                    <button class="btn btn-outline-secondary" type="button" id="refresh-sites-btn" title="Refresh Sites">
                                                                        <i class="bi bi-bootstrap-reboot"></i>
                                                                    </button>
                                                                </div>
                                                                <div class="form-text">Sites will be loaded when you select a container</div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="mb-3">
                                                                <label class="form-label">&nbsp;</label>
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" id="install-app-force">
                                                                    <label class="form-check-label" for="install-app-force">
                                                                        Force Install (--force)
                                                                    </label>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="card-footer">


                                                <div class="col-md-2 ms-auto"> 

                                                    <button class="btn btn-success w-100" id="install-app-btn">
                                                        <i class="bi bi-box-arrow-in-down"></i> Install App
                                                    </button>

                                                </div>
                                            </div>
                                        </div>
                                    </div>       

                                    <div class="frappe-cloud-card mb-4">
                                        <div class="col-md-12">
                                            <!-- Card Header -->
                                            <div class="card-header bg-info text-dark">
                                                <h6 class="mb-0">
                                                    <i class="bi bi-hammer"></i> Bench Build
                                                </h6>
                                            </div>

                                            <div class="card-body">
                                            <!-- App Management Section -->
                                                
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label for="build-app-name" class="form-label">App Name (Optional)</label>
                                                            <div class="input-group">
                                                                <select class="form-select" id="build-app-name">
                                                                    <option value="">Build All Apps</option>
                                                                </select>
                                                                <button class="btn btn-outline-secondary" type="button" id="refresh-build-apps-btn" title="Refresh Apps">
                                                                    <i class="bi bi-bootstrap-reboot"></i>
                                                                </button>
                                                            </div>
                                                            <div class="form-text">Leave empty to build all apps, or select specific app</div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="mb-3">
                                                            <label class="form-label">&nbsp;</label>
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="build-force">
                                                                <label class="form-check-label" for="build-force">
                                                                    Force Build
                                                                </label>
                                                            </div>
                                                        </div>
                                                    </div>


                                                </div>                                      
                                            </div>  
                                            <div class="card-footer">

                                                <div class="col-md-2 ms-auto"> 

                                                    <button class="btn btn-secondary w-100" id="install-app-btn">
                                                        <i class="bi bi-hammer"></i> Build
                                                    </button>

                                                </div>
                                            </div>                                    
                                        
                                        </div>
                                    </div>
                                    
                                </div>
                            </div>
                        </div>

                        <!-- Logs & Operations Panel Tab -->
                        <div class="tab-pane fade" id="logs-operations-panel" role="tabpanel">
                            <ul class="nav nav-pills nav-fill mb-3" id="logsOperationsTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="bench-logs-subtab" data-bs-toggle="pill" data-bs-target="#bench-logs-content" type="button" role="tab" aria-controls="bench-logs-content" aria-selected="true">
                                        <i class="bi bi-file-text"></i> Bench Logs
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="operation-log-subtab" data-bs-toggle="pill" data-bs-target="#operation-log-content" type="button" role="tab" aria-controls="operation-log-content" aria-selected="false">
                                        <i class="bi bi-journal-text"></i> Operation Log
                                    </button>
                                </li>
                            </ul>
                            
                            <div class="tab-content" id="logsOperationsTabsContent">
                                <!-- Bench Logs Sub-Tab -->
                                <div class="tab-pane fade show active" id="bench-logs-content" role="tabpanel">
                                    <!-- Container Selection for Logs -->
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <div class="frappe-cloud-card">
                                                <div class="card-header bg-primary text-white">
                                                    <h6 class="mb-0">
                                                        <i class="bi bi-server"></i> Select Container
                                                    </h6>
                                                </div>
                                                <div class="card-body">
                                                    <select class="form-select form-select-lg" id="logs-container-select">
                                                        <option value="">-- Choose a container --</option>
                                                        {% for project_name, project_containers in container_groups.items() %}
                                                            <optgroup label="{{ project_name }}">
                                                                {% for container in project_containers %}
                                                                    {% if container.service_type == 'App Server' %}
                                                                        <option value="{{ container.name }}">{{ container.name }}</option>
                                                                    {% endif %}
                                                                {% endfor %}
                                                            </optgroup>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-5">
                                            <div class="frappe-cloud-card">
                                                <div class="card-header bg-success text-white">
                                                    <h6 class="mb-0">
                                                        <i class="bi bi-file-earmark-text"></i> Select Log File
                                                    </h6>
                                                </div>
                                                <div class="card-body">
                                                    <div class="input-group input-group-lg">
                                                        <select class="form-select" id="bench-log-file-select">
                                                            <option value="">Select a log file...</option>
                                                        </select>
                                                        <button class="btn btn-outline-secondary" type="button" id="refresh-log-files-btn" title="Refresh Log Files">
                                                            <i class="bi bi-bootstrap-reboot"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="frappe-cloud-card">
                                                <div class="card-header bg-warning text-dark">
                                                    <h6 class="mb-0">
                                                        <i class="bi bi-speedometer2"></i> Lines Limit
                                                    </h6>
                                                </div>
                                                <div class="card-body">
                                                    <select class="form-select form-select-lg" id="log-lines-limit">
                                                        <option value="50">Last 50 lines</option>
                                                        <option value="100" selected>Last 100 lines</option>
                                                        <option value="200">Last 200 lines</option>
                                                        <option value="500">Last 500 lines</option>
                                                        <option value="1000">Last 1000 lines</option>
                                                        <option value="all">All lines (slow)</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Log Viewer -->
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="frappe-cloud-card">
                                                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                                                    <h6 class="mb-0">
                                                        <i class="bi bi-file-text"></i> Bench Log Viewer
                                                    </h6>
                                                    <div class="btn-group" role="group">
                                                        <button class="btn btn-sm btn-outline-light" id="view-log-btn">
                                                            <i class="bi bi-eye"></i> View Log
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-light" id="download-log-btn">
                                                            <i class="bi bi-download"></i> Download
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-light" id="clear-log-viewer-btn">
                                                            <i class="bi bi-trash"></i> Clear View
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="card-body p-0">
                                                    <div id="bench-log-content" class="operation-log" style="background-color: #1a1a1a; color: #00ff41; font-family: 'Courier New', monospace; padding: 15px; min-height: 400px; max-height: 600px; overflow-y: auto;">
                                                        <div class="text-muted text-center py-5">
                                                            <i class="bi bi-info-circle"></i> Select a container, log file, and line limit, then click "View Log"
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="card-footer bg-light">
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <small class="text-muted">
                                                                <i class="bi bi-info-circle me-1"></i>
                                                                <span id="log-info">No log loaded</span>
                                                            </small>
                                                        </div>
                                                        <div class="col-md-6 text-end">
                                                            <small class="text-muted">
                                                                <span id="log-lines-count">0 lines</span>
                                                            </small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Operation Log Sub-Tab -->
                                <div class="tab-pane fade" id="operation-log-content" role="tabpanel">
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="frappe-cloud-card">
                                                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                                                    <h6 class="mb-0">
                                                        <i class="bi bi-journal-text"></i> Operation Log
                                                    </h6>
                                                    <div>
                                                        <button class="btn btn-sm btn-outline-light" id="clear-log-btn">
                                                            <i class="bi bi-trash"></i> Clear
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-light" id="refresh-log-btn">
                                                            <i class="bi bi-arrow-clockwise"></i> Refresh
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="card-body p-0">
                                                    <div id="operation-log" class="operation-log">
                                                        <div class="text-muted text-center py-3">
                                                            <i class="bi bi-info-circle"></i> Select a container and perform operations to see logs here
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Access To Container Panel Tab -->
                        <div class="tab-pane fade" id="console-panel" role="tabpanel">
                            <ul class="nav nav-pills nav-fill mb-3" id="terminalTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="terminal-console-tab" data-bs-toggle="pill" data-bs-target="#terminal-console" type="button" role="tab" aria-controls="terminal-console" aria-selected="true">
                                        <i class="bi bi-terminal"></i> Web Terminal
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="ssh-access-tab" data-bs-toggle="pill" data-bs-target="#ssh-access" type="button" role="tab" aria-controls="ssh-access" aria-selected="false">
                                        <i class="bi bi-shield-lock"></i> SSH Access
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="terminal-logs-tab" data-bs-toggle="pill" data-bs-target="#terminal-logs" type="button" role="tab" aria-controls="terminal-logs" aria-selected="false">
                                        <i class="bi bi-journal-text"></i> Terminal Logs
                                    </button>
                                </li>
                            </ul>
                            
                            <div class="tab-content" id="terminalTabsContent">
                                <!-- Web Terminal Tab -->
                                <div class="tab-pane fade show active" id="terminal-console" role="tabpanel">
                                    <div class="container-selector mb-3">
                                        <label for="container-select" class="form-label fw-bold">
                                            <i class="bi bi-terminal"></i> Select Container for Web Terminal
                                        </label>
                                        <select class="form-select form-select-lg" id="container-select">
                                            <option value="">-- Choose a container --</option>
                                            {% for project_name, project_containers in container_groups.items() %}
                                                <optgroup label="{{ project_name }}">
                                                    {% for container in project_containers %}
                                                        {% if container.service_type == 'App Server' %}
                                                            <option value="{{ container.name }}">{{ container.name }}</option>
                                                        {% endif %}
                                                    {% endfor %}
                                                </optgroup>
                                            {% endfor %}
                                        </select>
                                        <div class="form-text">
                                            <i class="bi bi-info-circle"></i> Select a container to access its web terminal for command execution
                                        </div>
                                    </div>
                                    
                                    <div class="card">
                                        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                                            <div>
                                                <i class="bi bi-terminal-fill me-2"></i>
                                                <span id="terminal-title">Web Terminal Console</span>
                                            </div>
                                            <div>
                                                <button class="btn btn-sm btn-outline-light" id="terminal-clear-btn">
                                                    <i class="bi bi-eraser"></i> Clear
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body p-0">
                                            <div id="terminal-container" class="terminal-container"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- SSH Access Tab -->
                                <div class="tab-pane fade" id="ssh-access" role="tabpanel">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="card">
                                                <div class="card-header bg-primary text-white">
                                                    <h6 class="mb-0">
                                                        <i class="bi bi-shield-lock me-2"></i> Temporary SSH Access Setup
                                                    </h6>
                                                </div>
                                                <div class="card-body">
                                                    <form id="temp-ssh-form">
                                                        <div class="mb-3">
                                                            <label for="temp-container-select" class="form-label">
                                                                <i class="bi bi-terminal"></i> Select Container
                                                            </label>
                                                            <select class="form-select" id="temp-container-select">
                                                                <option value="">-- Choose a container --</option>
                                                                {% for project_name, project_containers in container_groups.items() %}
                                                                    <optgroup label="{{ project_name }}">
                                                                        {% for container in project_containers %}
                                                                            {% if container.service_type == 'App Server' %}
                                                                                <option value="{{ container.name }}">{{ container.name }}</option>
                                                                            {% endif %}
                                                                        {% endfor %}
                                                                    </optgroup>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <label for="temp-username" class="form-label">
                                                                <i class="bi bi-person"></i> SSH Username
                                                            </label>
                                                            <input type="text" class="form-control" id="temp-username" value="frappe" placeholder="e.g., frappe, root, ubuntu">
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <label for="temp-duration" class="form-label">
                                                                <i class="bi bi-clock"></i> Access Duration
                                                            </label>
                                                            <select class="form-select" id="temp-duration">
                                                                <option value="1">1 Hour</option>
                                                                <option value="6">6 Hours</option>
                                                                <option value="24" selected>24 Hours</option>
                                                                <option value="72">3 Days</option>
                                                                <option value="168">1 Week</option>
                                                            </select>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <label for="temp-port" class="form-label">
                                                                <i class="bi bi-ethernet"></i> SSH Port (Auto-assigned if empty)
                                                            </label>
                                                            <input type="number" class="form-control" id="temp-port" placeholder="e.g., 2222, 2223">
                                                            <div class="form-text">Leave empty for auto-assignment</div>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <label for="temp-description" class="form-label">
                                                                <i class="bi bi-chat-text"></i> Description (Optional)
                                                            </label>
                                                            <input type="text" class="form-control" id="temp-description" placeholder="e.g., Development access, Debug session">
                                                        </div>
                                                        
                                                        <div class="d-grid gap-2">
                                                            <button type="submit" class="btn btn-success">
                                                                <i class="bi bi-key"></i> Generate Temporary Access
                                                            </button>
                                                            <button type="button" class="btn btn-outline-info" id="check-ssh-status">
                                                                <i class="bi bi-check-circle"></i> Check SSH Status
                                                            </button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <div class="card">
                                                <div class="card-header bg-success text-white">
                                                    <h6 class="mb-0">
                                                        <i class="bi bi-info-circle"></i> SSH Connection Details
                                                    </h6>
                                                </div>
                                                <div class="card-body">
                                                    <div id="access-info" class="alert alert-info">
                                                        <i class="bi bi-info-circle"></i> No active SSH access configured
                                                    </div>
                                                    
                                                    <div id="ssh-connection-details" style="display: none;">
                                                        <h6><i class="bi bi-terminal"></i> SSH Connection Details:</h6>
                                                        <div class="bg-dark text-light p-3 rounded mb-3" style="font-family: monospace;">
                                                            <div id="ssh-host-info"></div>
                                                            <div id="ssh-port-info"></div>
                                                            <div id="ssh-username-info"></div>
                                                            <div id="ssh-key-info"></div>
                                                        </div>
                                                        
                                                        <h6><i class="bi bi-download"></i> Download SSH Key:</h6>
                                                        <div class="d-grid gap-2">
                                                            <button class="btn btn-outline-primary" id="download-private-key">
                                                                <i class="bi bi-download"></i> Download Private Key (.pem)
                                                            </button>
                                                            <button class="btn btn-outline-secondary" id="copy-ssh-command">
                                                                <i class="bi bi-clipboard"></i> Copy SSH Command
                                                            </button>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="mt-3">
                                                        <button class="btn btn-outline-danger btn-sm" id="revoke-access" style="display: none;">
                                                            <i class="bi bi-x-circle"></i> Revoke Access
                                                        </button>
                                                        <button class="btn btn-outline-warning btn-sm" id="extend-access" style="display: none;">
                                                            <i class="bi bi-clock"></i> Extend Access
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <div class="card">
                                                <div class="card-header bg-warning text-dark">
                                                    <h6 class="mb-0">
                                                        <i class="bi bi-list-check"></i> Active SSH Sessions
                                                    </h6>
                                                </div>
                                                <div class="card-body">
                                                    <div class="table-responsive">
                                                        <table class="table table-striped" id="ssh-sessions-table">
                                                            <thead>
                                                                <tr>
                                                                    <th>Container</th>
                                                                    <th>Username</th>
                                                                    <th>Port</th>
                                                                    <th>Created</th>
                                                                    <th>Expires</th>
                                                                    <th>Status</th>
                                                                    <th>Actions</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody id="ssh-sessions-tbody">
                                                                <tr>
                                                                    <td colspan="7" class="text-center text-muted">No active SSH sessions</td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="tab-pane fade" id="terminal-logs" role="tabpanel">
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="card">
                                                <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <i class="bi bi-journal-text me-2"></i>
                                                        <span class="fw-bold">Terminal Access Error Logs</span>
                                                    </div>
                                                    <div>
                                                        <button class="btn btn-sm btn-outline-dark" id="refresh-logs-btn">
                                                            <i class="bi bi-arrow-clockwise"></i> Refresh
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-dark" id="clear-logs-btn">
                                                            <i class="bi bi-trash"></i> Clear
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="card-body p-0">
                                                    <div class="table-responsive">
                                                        <table class="table table-striped table-hover mb-0" id="terminal-logs-table">
                                                            <thead class="table-dark">
                                                                <tr>
                                                                    <th width="5%">
                                                                        <i class="bi bi-hash"></i>
                                                                    </th>
                                                                    <th width="15%">
                                                                        <i class="bi bi-clock"></i> Timestamp
                                                                    </th>
                                                                    <th width="15%">
                                                                        <i class="bi bi-terminal"></i> Container
                                                                    </th>
                                                                    <th width="20%">
                                                                        <i class="bi bi-code-square"></i> Command
                                                                    </th>
                                                                    <th width="25%">
                                                                        <i class="bi bi-exclamation-triangle"></i> Error Message
                                                                    </th>
                                                                    <th width="10%">
                                                                        <i class="bi bi-x-circle"></i> Exit Code
                                                                    </th>
                                                                    <th width="10%">
                                                                        <i class="bi bi-person"></i> User
                                                                    </th>
                                                                </tr>
                                                            </thead>
                                                            <tbody id="terminal-logs-tbody">
                                                                <tr>
                                                                    <td colspan="7" class="text-center text-muted py-4">
                                                                        <i class="bi bi-info-circle me-2"></i>
                                                                        No terminal error logs found. Terminal errors will appear here.
                                                                    </td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                                <div class="card-footer bg-light">
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <small class="text-muted">
                                                                <i class="bi bi-info-circle me-1"></i>
                                                                Showing terminal command errors and failures
                                                            </small>
                                                        </div>
                                                        <div class="col-md-6 text-end">
                                                            <small class="text-muted">
                                                                <span id="logs-count">0</span> error(s) found
                                                            </small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Backup & Restore Panel Tab -->
                        <div class="tab-pane fade" id="backup-restore-panel" role="tabpanel">
                            <!-- Container and Site Selection - Top Section -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="frappe-cloud-card">
                                        <div class="card-header bg-dark text-white">
                                            <h6 class="mb-0">
                                                <i class="bi bi-gear"></i> Select Container & Site
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3 mb-md-0">
                                                        <label for="backup-container-select" class="form-label fw-bold">
                                                            <i class="bi bi-terminal"></i> Container
                                                        </label>
                                                        <select class="form-select form-select-lg" id="backup-container-select">
                                                            <option value="">-- Choose a container --</option>
                                                            {% for project_name, project_containers in container_groups.items() %}
                                                                <optgroup label="{{ project_name }}">
                                                                    {% for container in project_containers %}
                                                                        {% if container.service_type == 'App Server' %}
                                                                            <option value="{{ container.name }}">{{ container.name }}</option>
                                                                        {% endif %}
                                                                    {% endfor %}
                                                                </optgroup>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-0">
                                                        <label for="backup-site-name" class="form-label fw-bold">
                                                            <i class="bi bi-globe"></i> Site Name
                                                        </label>
                                                        <div class="input-group input-group-lg">
                                                            <select class="form-select" id="backup-site-name">
                                                                <option value="">Select a site...</option>
                                                            </select>
                                                            <button class="btn btn-outline-secondary" type="button" id="refresh-backup-sites-btn" title="Refresh Sites">
                                                                <i class="bi bi-bootstrap-reboot"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <!-- Create Backup Card -->
                                    <div class="frappe-cloud-card mb-4">
                                        <div class="card-header bg-primary text-white">
                                            <h6 class="mb-0">
                                                <i class="bi bi-cloud-arrow-up"></i> Create Backup
                                            </h6>
                                        </div>
                                        <div class="card-body">

                                            <div class="mb-3">
                                                <label class="form-label">
                                                    <i class="bi bi-file-earmark-check"></i> Backup Options
                                                </label>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="backup-database" checked>
                                                    <label class="form-check-label" for="backup-database">
                                                        Database (SQL)
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="backup-private-files" checked>
                                                    <label class="form-check-label" for="backup-private-files">
                                                        Private Files
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="backup-public-files" checked>
                                                    <label class="form-check-label" for="backup-public-files">
                                                        Public Files
                                                    </label>
                                                </div>
                                            </div>

                                            <div class="d-grid">
                                                <button class="btn btn-primary" id="create-backup-btn">
                                                    <i class="bi bi-cloud-arrow-up"></i> Create Backup
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <!-- Backup Info Card -->
                                    <div class="frappe-cloud-card mb-4">
                                        <div class="card-header bg-info text-white">
                                            <h6 class="mb-0">
                                                <i class="bi bi-info-circle"></i> Backup Information
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="alert alert-info">
                                                <h6><i class="bi bi-lightbulb"></i> What gets backed up?</h6>
                                                <ul class="mb-0">
                                                    <li><strong>Database:</strong> All your site data (DocTypes, records, configurations)</li>
                                                    <li><strong>Private Files:</strong> Uploaded files not publicly accessible</li>
                                                    <li><strong>Public Files:</strong> Images, CSS, JS, and other public assets</li>
                                                </ul>
                                            </div>

                                            <div class="alert alert-warning">
                                                <h6><i class="bi bi-exclamation-triangle"></i> Important Notes</h6>
                                                <ul class="mb-0">
                                                    <li>Backups are stored in the site's <code>private/backups</code> directory</li>
                                                    <li>Large sites may take several minutes to backup</li>
                                                    <li>Download backups to external storage for safety</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Available Backups Section -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="frappe-cloud-card">
                                        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">
                                                <i class="bi bi-archive-fill"></i> Available Backups
                                            </h6>
                                            <button class="btn btn-sm btn-light" id="refresh-backups-btn">
                                                <i class="bi bi-arrow-clockwise"></i> Refresh
                                            </button>
                                        </div>
                                        <div class="card-body p-0">
                                            <div class="table-responsive">
                                                <table class="table table-hover mb-0" id="backups-table">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th width="5%">
                                                                <i class="bi bi-hash"></i>
                                                            </th>
                                                            <th width="35%">
                                                                <i class="bi bi-file-earmark"></i> Filename
                                                            </th>
                                                            <th width="15%">
                                                                <i class="bi bi-tag"></i> Type
                                                            </th>
                                                            <th width="10%">
                                                                <i class="bi bi-hdd"></i> Size
                                                            </th>
                                                            <th width="20%">
                                                                <i class="bi bi-clock"></i> Date
                                                            </th>
                                                            <th width="20%">
                                                                <i class="bi bi-gear"></i> Actions
                                                            </th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="backups-tbody">
                                                        <tr>
                                                            <td colspan="6" class="text-center text-muted py-4">
                                                                <i class="bi bi-inbox me-2"></i>
                                                                No backups available. Select a container and site, then click "Refresh" to load backups.
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Upload External Backup Section -->
                            <div class="row mt-4">
                                <div class="col-6">
                                    <div class="frappe-cloud-card">
                                        <div class="card-header bg-info text-white">
                                            <h6 class="mb-0">
                                                <i class="bi bi-cloud-upload"></i> Upload External Backup
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="alert alert-info">
                                                <h6><i class="bi bi-info-circle"></i> Upload Backup from Your Computer</h6>
                                                <p class="mb-0">Upload backup files from your local computer or external storage. Supported formats: .sql, .sql.gz for database, .tar for files.</p>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-12">
                                                    <div class="mb-3">
                                                        <label for="upload-backup-type" class="form-label">
                                                            <i class="bi bi-tag"></i> Backup Type
                                                        </label>
                                                        <select class="form-select" id="upload-backup-type">
                                                            <option value="database">Database (.sql, .sql.gz)</option>
                                                            <option value="private_files">Private Files (.tar)</option>
                                                            <option value="public_files">Public Files (.tar)</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-md-12">
                                                    <div class="mb-3">
                                                        <label for="upload-backup-file" class="form-label">
                                                            <i class="bi bi-file-earmark-arrow-up"></i> Select Backup File
                                                        </label>
                                                        <input type="file" class="form-control" id="upload-backup-file" accept=".sql,.sql.gz,.tar,.tar.gz">
                                                        <div class="form-text">
                                                            <span id="upload-file-info" class="text-muted">No file selected</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="progress mb-3" id="upload-progress" style="display: none;">
                                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" id="upload-progress-bar" style="width: 0%"></div>
                                            </div>

                                            <div class="d-grid">
                                                <button class="btn btn-info btn-lg" id="upload-backup-btn">
                                                    <i class="bi bi-cloud-upload"></i> Upload Backup File
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Restore Backup Section -->
                                <div class="col-6">
                                    <div class="frappe-cloud-card">
                                        <div class="card-header bg-warning text-dark">
                                            <h6 class="mb-0">
                                                <i class="bi bi-arrow-counterclockwise"></i> Restore Backup
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="alert alert-danger">
                                                <h6><i class="bi bi-exclamation-octagon"></i> Warning!</h6>
                                                <p class="mb-0">Restoring a backup will <strong>replace all current data</strong> on the selected site. This action cannot be undone. Make sure you have a recent backup before proceeding.</p>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-12">
                                                    <div class="mb-3">
                                                        <label for="restore-database-backup" class="form-label">
                                                            <i class="bi bi-database"></i> Database Backup
                                                        </label>
                                                        <div class="input-group">
                                                            <select class="form-select" id="restore-database-backup">
                                                                <option value="">Select database backup...</option>
                                                            </select>
                                                            <button class="btn btn-outline-secondary" type="button" id="refresh-restore-backups-btn" title="Refresh Backups">
                                                                <i class="bi bi-bootstrap-reboot"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-12">
                                                    <div class="mb-3">
                                                        <label for="restore-private-backup" class="form-label">
                                                            <i class="bi bi-file-lock"></i> Private Files (Optional)
                                                        </label>
                                                        <select class="form-select" id="restore-private-backup">
                                                            <option value="">None</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-md-12">
                                                    <div class="mb-3">
                                                        <label for="restore-public-backup" class="form-label">
                                                            <i class="bi bi-folder-open"></i> Public Files (Optional)
                                                        </label>
                                                        <select class="form-select" id="restore-public-backup">
                                                            <option value="">None</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-12">
                                                    <div class="mb-3">
                                                        <label for="restore-mysql-root-password" class="form-label">
                                                            <i class="bi bi-key"></i> MySQL Root Password
                                                        </label>
                                                        <input type="password" class="form-control" id="restore-mysql-root-password" placeholder="Enter MySQL root password">
                                                        <div class="form-text">Required for database restoration</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-12">
                                                    <div class="mb-3">
                                                        <label for="restore-admin-password" class="form-label">
                                                            <i class="bi bi-shield-lock"></i> Admin Password (Optional)
                                                        </label>
                                                        <input type="password" class="form-control" id="restore-admin-password" placeholder="Set new admin password">
                                                        <div class="form-text">Leave empty to keep existing password</div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="d-grid">
                                                <button class="btn btn-warning btn-lg" id="restore-backup-btn">
                                                    <i class="bi bi-arrow-counterclockwise"></i> Restore Backup
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- New Site Creation Panel Tab -->
                        <div class="tab-pane fade" id="new-site-panel" role="tabpanel">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="frappe-cloud-card">
                                        <div class="card-header bg-primary text-white">
                                            <h5 class="mb-0">
                                                <i class="bi bi-plus-circle-fill"></i> Create New Frappe/ERPNext Site
                                            </h5>
                                        </div>
                                        <div class="card-body">
                                            <form id="new-site-form">
                                                <!-- Environment Selection -->
                                                <div class="row mb-4">
                                                    <div class="col-md-12">
                                                        <label class="form-label fw-bold">
                                                            <i class="bi bi-hdd-stack"></i> Deployment Environment
                                                        </label>
                                                        <div class="btn-group w-100" role="group" aria-label="Environment selection">
                                                            <input type="radio" class="btn-check" name="environment" id="env-local" value="local" checked>
                                                            <label class="btn btn-outline-primary" for="env-local">
                                                                <i class="bi bi-laptop"></i> Docker-Local<br>
                                                                <small>Development & Testing</small>
                                                            </label>
                                                            
                                                            <input type="radio" class="btn-check" name="environment" id="env-vps" value="vps">
                                                            <label class="btn btn-outline-success" for="env-vps">
                                                                <i class="bi bi-cloud-upload"></i> Docker-on-VPS<br>
                                                                <small>Production Deployment</small>
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Domain Name -->
                                                <div class="row mb-3">
                                                    <div class="col-md-12">
                                                        <label for="domain-name" class="form-label fw-bold">
                                                            <i class="bi bi-globe2"></i> Domain Name
                                                        </label>
                                                        <input type="text" class="form-control form-control-lg" id="domain-name" 
                                                               placeholder="e.g., mysite.localhost or erp.yourcompany.com" required>
                                                        <div class="form-text">
                                                            <strong>Local:</strong> Use .localhost domain (e.g., mysite.localhost)<br>
                                                            <strong>VPS:</strong> Use your actual domain (e.g., erp.yourcompany.com)<br>
                                                            <small class="text-muted"><i class="bi bi-info-circle"></i> Site name will be automatically extracted from domain</small>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- ERPNext Version -->
                                                <div class="row mb-3">
                                                    <div class="col-md-12">
                                                        <label for="erpnext-version" class="form-label fw-bold">
                                                            <i class="bi bi-box-seam"></i> ERPNext Version
                                                        </label>
                                                        <div class="input-group input-group-lg">
                                                            <select class="form-select" id="erpnext-version">
                                                                <option value="">Loading versions...</option>
                                                            </select>
                                                            <button class="btn btn-outline-secondary" type="button" id="refresh-versions-btn" title="Refresh Versions">
                                                                <i class="bi bi-arrow-clockwise"></i>
                                                            </button>
                                                        </div>
                                                        <div class="form-text">
                                                            Frappe version will be automatically matched with ERPNext version
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Information Alert -->
                                                <div class="alert alert-info">
                                                    <h6><i class="bi bi-info-circle-fill"></i> What happens when you create a site?</h6>
                                                    <ul class="mb-0">
                                                        <li>Docker Compose configuration will be automatically generated</li>
                                                        <li>Required containers (frappe, db, redis) will be created and started</li>
                                                        <li>Traefik reverse proxy will be configured automatically</li>
                                                        <li>Database and admin passwords will be auto-generated securely</li>
                                                        <li>Site will be accessible via your domain once setup completes (5 minutes)</li>
                                                    </ul>
                                                </div>

                                                <!-- Action Buttons -->
                                                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                                    <button type="button" class="btn btn-secondary btn-lg" id="reset-site-form">
                                                        <i class="bi bi-arrow-counterclockwise"></i> Reset
                                                    </button>
                                                    <button type="submit" class="btn btn-primary btn-lg" id="create-site-btn">
                                                        <i class="bi bi-rocket-takeoff"></i> Create Site
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-8">

                                    <!-- Site Creation Progress -->
                                    <div class="frappe-cloud-card" id="site-creation-progress" style="display: none;">
                                        <div class="card-header bg-success text-white">
                                            <h6 class="mb-0">
                                                <i class="bi bi-gear-fill spin-icon"></i> Site Creation in Progress
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="progress mb-3" style="height: 30px; border-radius: 10px; box-shadow: inset 0 1px 2px rgba(0,0,0,.1);">
                                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                                     role="progressbar" id="creation-progress-bar" 
                                                     style="width: 0%; font-weight: 600; font-size: 14px; transition: width 0.5s ease-in-out;" 
                                                     aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                                    0%
                                                </div>
                                            </div>
                                            <div id="creation-status" class="mb-3 p-3 bg-light rounded">
                                                <div class="d-flex align-items-center">
                                                    <i class="bi bi-info-circle text-primary me-2"></i>
                                                    <strong>Status:</strong> <span id="creation-status-text" class="ms-2 text-muted">Initializing...</span>
                                                </div>
                                            </div>
                                            <div class="operation-log" id="site-creation-log" style="max-height: 400px;">
                                                <div class="text-muted">Waiting for process to start...</div>
                                            </div>
                                        </div>
                                    </div>
                                    <style>
                                        @keyframes spin {
                                            from { transform: rotate(0deg); }
                                            to { transform: rotate(360deg); }
                                        }
                                        .spin-icon {
                                            animation: spin 2s linear infinite;
                                            display: inline-block;
                                        }
                                        .progress {
                                            background-color: #e9ecef;
                                        }
                                        .progress-bar {
                                            display: flex;
                                            align-items: center;
                                            justify-content: center;
                                        }
                                    </style>
                                </div>
                            </div>
                        </div>

                        <!-- Danger Zone Panel Tab -->
                        <div class="tab-pane fade" id="danger-zone-panel" role="tabpanel">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="alert alert-danger border-danger" style="border-width: 3px;">
                                        <h4 class="alert-heading">
                                            <i class="bi bi-exclamation-triangle-fill"></i>  DANGER ZONE 
                                        </h4>
                                        <p class="mb-0">
                                            <strong>Warning:</strong> The operations in this section are <strong>irreversible</strong> and may result in data loss. 
                                            Please proceed with extreme caution and ensure you have backups before performing any actions.
                                        </p>
                                    </div>
                                    
                                    <!-- Site Selection for Danger Operations -->
                                    <div class="frappe-cloud-card mb-4">
                                        <div class="card-header bg-danger text-white">
                                            <h5 class="mb-0">
                                                <i class="bi bi-server"></i> Select Site/Container
                                            </h5>
                                        </div>
                                        <div class="card-body">
                                            <select class="form-select form-select-lg" id="danger-site-select">
                                                <option value="">-- Choose a site --</option>
                                                {% for project_name, project_containers in container_groups.items() %}
                                                    {% if project_containers %}
                                                        {% set actual_name = project_containers[0].name.rsplit('-', 1)[0] %}
                                                        <option value="{{ actual_name }}" data-display-name="{{ project_name }}">{{ project_name }}</option>
                                                    {% endif %}
                                                {% endfor %}
                                            </select>
                                            <div class="form-text text-danger">
                                                <i class="bi bi-exclamation-circle"></i> <strong>Select carefully!</strong> All operations below will affect this site.
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Dangerous Operations -->
                                    <div class="row">
                                        <!-- Rebuild with Custom Apps Preservation -->
                                        <div class="col-md-4">
                                            <div class="card border-warning mb-3">
                                                <div class="card-header bg-warning text-dark">
                                                    <h6 class="mb-0">
                                                        <i class="bi bi-arrow-clockwise"></i> Rebuild with Apps Preservation
                                                    </h6>
                                                </div>
                                                <div class="card-body">
                                                    <p class="card-text">
                                                        <small>
                                                            Rebuild containers while preserving custom apps. This will:
                                                            <ul class="small mt-2">
                                                                <li>Backup custom apps</li>
                                                                <li>Rebuild containers</li>
                                                                <li>Restore custom apps</li>
                                                                <li>Update apps.txt</li>
                                                            </ul>
                                                        </small>
                                                    </p>
                                                    <button class="btn btn-warning w-100" id="rebuild-with-apps-btn">
                                                        <i class="bi bi-hammer"></i> Rebuild with Apps
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Fix Restart Policies -->
                                        <div class="col-md-4">
                                            <div class="card border-info mb-3">
                                                <div class="card-header bg-info text-white">
                                                    <h6 class="mb-0">
                                                        <i class="bi bi-arrow-repeat"></i> Fix Restart Policies
                                                    </h6>
                                                </div>
                                                <div class="card-body">
                                                    <p class="card-text">
                                                        <small>
                                                            Set containers to auto-restart after system reboot:
                                                            <ul class="small mt-2">
                                                                <li>Updates all Frappe containers</li>
                                                                <li>Sets restart=unless-stopped</li>
                                                                <li>Starts stopped containers</li>
                                                            </ul>
                                                        </small>
                                                    </p>
                                                    <button class="btn btn-info w-100" id="fix-restart-policies-btn">
                                                        <i class="bi bi-gear"></i> Fix Restart Policies
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Complete Site Removal -->
                                        <div class="col-md-4">
                                            <div class="card border-danger mb-3">
                                                <div class="card-header bg-danger text-white">
                                                    <h6 class="mb-0">
                                                        <i class="bi bi-trash-fill"></i> Complete Site Removal
                                                    </h6>
                                                </div>
                                                <div class="card-body">
                                                    <p class="card-text">
                                                        <small class="text-danger">
                                                            <strong> IRREVERSIBLE!</strong> This will permanently delete:
                                                            <ul class="small mt-2">
                                                                <li>All containers</li>
                                                                <li>Site folders</li>
                                                                <li>VS Code folders</li>
                                                                <li>Hosts file entries</li>
                                                            </ul>
                                                        </small>
                                                    </p>
                                                    <button class="btn btn-danger w-100" id="complete-site-removal-btn">
                                                        <i class="bi bi-x-octagon"></i> Complete Removal
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Output Display -->
                                    <div class="frappe-cloud-card mt-4">
                                        <div class="card-header bg-dark text-white">
                                            <h6 class="mb-0">
                                                <i class="bi bi-terminal"></i> Operation Output
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="operation-log" id="danger-zone-output" style="min-height: 400px; max-height: 600px; background-color: #1a1a1a; color: #00ff41; font-family: 'Courier New', monospace;">
                                                <div class="text-muted text-center py-5">
                                                    <i class="bi bi-shield-exclamation"></i> Select a site and choose an operation above...
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="confirmationMessage">Are you sure you want to execute this command?</p>
                <p id="confirmationWarning" class="text-warning">This operation may take several minutes to complete.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmActionBtn">Confirm</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
<script src="{{ url_for('static', filename='js/ssh-manager.js') }}"></script>
<script>
  // Global configuration
  const FRAPPE_BASE_DIR = "{{ base_dir }}";
  
  // Global Loader Management
class LoaderManager {
    static show(message = 'Processing...') {
        const loader = document.getElementById('globalLoader');
        const loaderText = document.getElementById('loaderText');
        if (loader && loaderText) {
            loaderText.textContent = message;
            loader.style.display = 'flex';
        }
    }
    
    static hide() {
        const loader = document.getElementById('globalLoader');
        if (loader) {
            loader.style.display = 'none';
        }
    }
    
    static setButtonLoading(button, isLoading) {
        if (isLoading) {
            button.classList.add('btn-loading');
            button.disabled = true;
        } else {
            button.classList.remove('btn-loading');
            button.disabled = false;
        }
    }
}

// Enhanced fetch with loader
async function fetchWithLoader(url, options = {}, loaderMessage = 'Processing...') {
    LoaderManager.show(loaderMessage);
    try {
        const response = await fetch(url, options);
        return response;
    } finally {
        LoaderManager.hide();
    }
}


// Frappe Cloud-like App Management JavaScript
class FrappeAppManager {
    constructor() {
        this.selectedContainer = null;
        this.operationLog = [];
        this.init();
    }
    
    init() {
        this.initializeEventListeners();
        this.initializeTerminal();
        this.initializeSSH();
        this.initializeTerminalLogs();
    }
    
    initializeEventListeners() {
        
        // Container selection
        const containerSelect = document.getElementById('app-container-select');
        if (containerSelect) {
            containerSelect.addEventListener('change', (e) => {
                this.selectedContainer = e.target.value;
                this.updateContainerInfo();
                this.updateOperationButtons();
                
                if (this.selectedContainer) {
                    this.loadAppsForContainer();
                    this.loadSitesForContainer(); // Add this line
                } else {
                    this.clearAppsDropdown();
                    this.clearSitesDropdown(); // Add this line
                }
            });
        }
        
        // App operations
        document.getElementById('get-app-btn')?.addEventListener('click', () => this.getApp());
        const installBtn = document.getElementById('install-app-btn');
        
        if (installBtn) {
            installBtn.addEventListener('click', () => {
                this.installApp();
            });
        }
        
        document.getElementById('uninstall-app-btn')?.addEventListener('click', () => this.uninstallApp());
        document.getElementById('update-app-btn')?.addEventListener('click', () => this.updateApp());
        document.getElementById('list-apps-btn')?.addEventListener('click', () => this.listApps());
        document.getElementById('fix-apps-txt-btn')?.addEventListener('click', () => this.fixAppsTxt());
        document.getElementById('bench-restart-btn')?.addEventListener('click', () => this.restartBench());
        document.getElementById('supervisor-status-btn')?.addEventListener('click', () => this.supervisorStatus());
        document.getElementById('bench-build-btn')?.addEventListener('click', () => this.benchBuild());
        document.getElementById('open-as-admin-btn')?.addEventListener('click', () => this.openAsAdministrator());
        
        
        // Quick actions
        document.getElementById('bench-status')?.addEventListener('click', () => this.benchStatus());
        document.getElementById('bench-info')?.addEventListener('click', () => this.benchInfo());
        document.getElementById('bench-clear-cache')?.addEventListener('click', () => this.clearCache());
        document.getElementById('bench-migrate')?.addEventListener('click', () => this.migrate());
        
        // Log management
        document.getElementById('clear-log-btn')?.addEventListener('click', () => this.clearOperationLog());
        document.getElementById('refresh-log-btn')?.addEventListener('click', () => this.refreshOperationLog());
        document.getElementById('refresh-containers')?.addEventListener('click', () => this.refreshContainers());
        
        // Terminal operations
        const terminalContainerSelect = document.getElementById('container-select');
        if (terminalContainerSelect) {
            terminalContainerSelect.addEventListener('change', function() {
                const selectedContainer = this.value;
                if (selectedContainer && window.terminal) {
                    window.terminal.connectToContainer(selectedContainer);
                    
                    const terminalTitle = document.getElementById('terminal-title');
                    if (terminalTitle) {
                        terminalTitle.textContent = `Terminal: ${selectedContainer}`;
                    }
                }
            });
        }
        
        const clearButton = document.getElementById('terminal-clear-btn');
        if (clearButton) {
            clearButton.addEventListener('click', function() {
                if (window.terminal) {
                    window.terminal.clear();
                }
            });
        }

        // Add a refresh apps button or method
        document.getElementById('refresh-apps-btn')?.addEventListener('click', () => this.refreshApps());
        document.getElementById('refresh-sites-btn')?.addEventListener('click', () => this.refreshSites());
        
        // Backup & Restore event listeners
        document.getElementById('backup-container-select')?.addEventListener('change', (e) => this.onBackupContainerChange(e.target.value));
        document.getElementById('refresh-backup-sites-btn')?.addEventListener('click', () => this.loadBackupSites());
        document.getElementById('create-backup-btn')?.addEventListener('click', () => this.createBackup());
        document.getElementById('refresh-backups-btn')?.addEventListener('click', () => this.loadBackupsList());
        document.getElementById('refresh-restore-backups-btn')?.addEventListener('click', () => this.loadBackupsList());
        document.getElementById('restore-backup-btn')?.addEventListener('click', () => this.restoreBackup());
        document.getElementById('upload-backup-btn')?.addEventListener('click', () => this.uploadBackup());
        
        // File input change listener
        document.getElementById('upload-backup-file')?.addEventListener('change', (e) => {
            const fileInfo = document.getElementById('upload-file-info');
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
                fileInfo.textContent = `Selected: ${file.name} (${sizeMB} MB)`;
                fileInfo.classList.remove('text-muted');
                fileInfo.classList.add('text-success');
            } else {
                fileInfo.textContent = 'No file selected';
                fileInfo.classList.remove('text-success');
                fileInfo.classList.add('text-muted');
            }
        });

        // Bench Logs event listeners
        document.getElementById('logs-container-select')?.addEventListener('change', (e) => this.onLogsContainerChange(e.target.value));
        document.getElementById('refresh-log-files-btn')?.addEventListener('click', () => this.loadLogFiles());
        document.getElementById('view-log-btn')?.addEventListener('click', () => this.viewLog());
        document.getElementById('download-log-btn')?.addEventListener('click', () => this.downloadLog());
        document.getElementById('clear-log-viewer-btn')?.addEventListener('click', () => this.clearLogViewer());
        
        // New Site Creation event listeners
        document.getElementById('new-site-form')?.addEventListener('submit', (e) => this.handleNewSiteCreation(e));
        document.getElementById('reset-site-form')?.addEventListener('click', () => this.resetSiteForm());
        document.getElementById('refresh-versions-btn')?.addEventListener('click', () => this.loadERPNextVersions());
        
        // Load ERPNext versions on tab show
        document.getElementById('new-site-tab')?.addEventListener('shown.bs.tab', () => {
            if (!this.versionsLoaded) {
                this.loadERPNextVersions();
            }
        });
    }
    
    updateContainerInfo() {
        const containerInfo = document.getElementById('container-info');
        const containerDetails = document.getElementById('container-details');
        
        if (!this.selectedContainer) {
            containerInfo.style.display = 'none';
            return;
        }
        
        const option = document.querySelector(`#app-container-select option[value="${this.selectedContainer}"]`);
        if (option) {
            const status = option.dataset.status || 'Unknown';
            const image = option.dataset.image || 'Unknown';
            const isRunning = status.includes('Up');
            
            containerDetails.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <strong>Container:</strong> ${this.selectedContainer}<br>
                        <strong>Status:</strong> 
                        <span class="badge ${isRunning ? 'bg-success' : 'bg-danger'} status-badge">
                            ${isRunning ? 'Running' : 'Stopped'}
                        </span>
                    </div>
                    <div class="col-md-6">
                        <strong>Image:</strong> ${image}<br>
                        <strong>Type:</strong> App Server
                    </div>
                </div>
            `;
            containerInfo.style.display = 'block';
        }
    }
    
    updateOperationButtons() {
        const buttons = document.querySelectorAll('.app-operation-btn');
        const isEnabled = !!this.selectedContainer;
        
        buttons.forEach(btn => {
            btn.disabled = !isEnabled;
            if (isEnabled) {
                btn.classList.remove('disabled');
            } else {
                btn.classList.add('disabled');
            }
        });
    }
    
    async executeCommand(command, description) {
        if (!this.selectedContainer) {
            this.addToLog('error', 'Please select a container first');
            return;
        }
        
        this.addToLog('info', `Executing: ${description}`);
        
        try {
            const response = await fetchWithLoader('/api/frappe/execute-command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({
                    container: this.selectedContainer,
                    command: command
                })
            }, `Executing: ${description}`);
            
            const data = await response.json();
            
            // Check if this is a background task
            if (data.is_background_task && data.task_id) {
                // Show progress modal and track task
                await this.trackBackgroundTask(data.task_id, description);
            } else if (data.error) {
                this.addToLog('error', `Error: ${data.error}`);
                await Swal.fire({
                    title: 'Error',
                    html: `<pre style="text-align: left; max-height: 400px; overflow-y: auto;">${data.error}</pre>`,
                    icon: 'error',
                    width: '600px'
                });
            } else {
                this.addToLog('success', `Success: ${description}`);
                if (data.output) {
                    this.addToLog('info', data.output);
                    await Swal.fire({
                        title: 'Success',
                        html: `<div style="text-align: left;"><strong>${description}</strong><pre style="max-height: 400px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px;">${data.output}</pre></div>`,
                        icon: 'success',
                        width: '700px',
                        confirmButtonText: 'OK'
                    });
                }
            }
        } catch (error) {
            this.addToLog('error', `Network error: ${error.message}`);
            await Swal.fire({
                title: 'Network Error',
                text: error.message,
                icon: 'error'
            });
        }
    }
    
    async trackBackgroundTask(taskId, description) {
        // Show progress modal with SweetAlert
        let timerInterval;
        const swalInstance = Swal.fire({
            title: description,
            html: `
                <div style="text-align: center; padding: 20px;">
                    <div class="progress" style="height: 30px; margin-bottom: 15px;">
                        <div id="task-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%; background-color: #007bff;" 
                             aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            <span id="task-progress-text" style="font-weight: bold; line-height: 30px;">0%</span>
                        </div>
                    </div>
                    <div id="task-status-message" style="margin-bottom: 15px; font-weight: bold; color: #333;">
                        Initializing...
                    </div>
                    <div id="task-output-container" style="max-height: 300px; overflow-y: auto; text-align: left; background: #1e1e1e; color: #00ff00; font-family: 'Courier New', monospace; padding: 10px; border-radius: 5px; font-size: 12px; white-space: pre-wrap;">
                        Waiting for output...
                    </div>
                </div>
            `,
            width: '800px',
            allowOutsideClick: false,
            allowEscapeKey: false,
            showConfirmButton: false,
            showCancelButton: true,
            cancelButtonText: 'Close',
            didOpen: () => {
                // Start polling for task status
                const pollTaskStatus = async () => {
                    try {
                        const response = await fetch(`/api/tasks/status/${taskId}`);
                        const result = await response.json();
                        
                        if (result.success && result.task) {
                            const task = result.task;
                            
                            // Update progress bar
                            const progressBar = document.getElementById('task-progress-bar');
                            const progressText = document.getElementById('task-progress-text');
                            if (progressBar && progressText) {
                                progressBar.style.width = `${task.progress}%`;
                                progressBar.setAttribute('aria-valuenow', task.progress);
                                progressText.textContent = `${task.progress}%`;
                                
                                // Change color based on status
                                if (task.status === 'completed') {
                                    progressBar.style.backgroundColor = '#28a745';
                                } else if (task.status === 'failed') {
                                    progressBar.style.backgroundColor = '#dc3545';
                                }
                            }
                            
                            // Update status message
                            const statusMessage = document.getElementById('task-status-message');
                            if (statusMessage) {
                                statusMessage.textContent = task.message || 'Processing...';
                                
                                // Color based on status
                                if (task.status === 'completed') {
                                    statusMessage.style.color = '#28a745';
                                } else if (task.status === 'failed') {
                                    statusMessage.style.color = '#dc3545';
                                } else if (task.status === 'running') {
                                    statusMessage.style.color = '#007bff';
                                }
                            }
                            
                            // Update output
                            const outputContainer = document.getElementById('task-output-container');
                            if (outputContainer) {
                                // Always update output if task has been fetched
                                if (task.output !== undefined) {
                                    // Show output or appropriate message
                                    const displayText = task.output ? task.output : (task.status === 'pending' ? 'Initializing...' : 'Processing...');
                                    outputContainer.textContent = displayText;
                                    // Auto-scroll to bottom
                                    outputContainer.scrollTop = outputContainer.scrollHeight;
                                }
                            }
                            
                            // Check if task is complete
                            if (task.status === 'completed') {
                                clearInterval(timerInterval);
                                this.addToLog('success', `${description} completed successfully`);
                                
                                // Show completion with clean HTML
                                Swal.update({
                                    title: ' Completed Successfully!',
                                    html: `
                                        <div style="text-align: center; padding: 20px;">
                                            <div class="alert alert-success" style="margin-bottom: 15px;">
                                                <strong>${description}</strong> completed successfully!
                                            </div>
                                            ${task.output ? `
                                                <details style="text-align: left;">
                                                    <summary style="cursor: pointer; padding: 10px; background: #f8f9fa; border-radius: 5px; margin-bottom: 10px;">
                                                        <strong>View Output</strong>
                                                    </summary>
                                                    <div style="max-height: 300px; overflow-y: auto; background: #1e1e1e; color: #00ff00; font-family: 'Courier New', monospace; padding: 10px; border-radius: 5px; font-size: 12px; white-space: pre-wrap;">
                                                        ${task.output}
                                                    </div>
                                                </details>
                                            ` : ''}
                                        </div>
                                    `,
                                    icon: 'success',
                                    showConfirmButton: true,
                                    showCancelButton: false,
                                    confirmButtonText: 'OK'
                                });
                            } else if (task.status === 'failed') {
                                clearInterval(timerInterval);
                                this.addToLog('error', `${description} failed: ${task.error}`);
                                
                                // Show error with clean HTML
                                Swal.update({
                                    title: ' Task Failed',
                                    html: `
                                        <div style="text-align: center; padding: 20px;">
                                            <div class="alert alert-danger" style="margin-bottom: 15px;">
                                                <strong>Error:</strong> ${task.error || 'Unknown error'}
                                            </div>
                                            ${task.output ? `
                                                <details style="text-align: left;">
                                                    <summary style="cursor: pointer; padding: 10px; background: #f8f9fa; border-radius: 5px; margin-bottom: 10px;">
                                                        <strong>View Output</strong>
                                                    </summary>
                                                    <div style="max-height: 300px; overflow-y: auto; background: #1e1e1e; color: #ff4444; font-family: 'Courier New', monospace; padding: 10px; border-radius: 5px; font-size: 12px; white-space: pre-wrap;">
                                                        ${task.output}
                                                    </div>
                                                </details>
                                            ` : ''}
                                        </div>
                                    `,
                                    icon: 'error',
                                    showConfirmButton: true,
                                    showCancelButton: false,
                                    confirmButtonText: 'OK'
                                });
                            }
                        } else {
                            clearInterval(timerInterval);
                            throw new Error('Failed to get task status');
                        }
                    } catch (error) {
                        clearInterval(timerInterval);
                        console.error('Error polling task:', error);
                        this.addToLog('error', `Error tracking task: ${error.message}`);
                    }
                };
                
                // Poll immediately, then every second
                pollTaskStatus();
                timerInterval = setInterval(pollTaskStatus, 1000);
            },
            willClose: () => {
                if (timerInterval) {
                    clearInterval(timerInterval);
                }
            }
        });
        
        return swalInstance;
    }
    
    addToLog(type, message) {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = {
            timestamp,
            type,
            message
        };
        
        this.operationLog.unshift(logEntry);
        if (this.operationLog.length > 100) {
            this.operationLog = this.operationLog.slice(0, 100);
        }
        
        this.updateOperationLogDisplay();
    }
    
    updateOperationLogDisplay() {
        const logContainer = document.getElementById('operation-log');
        
        if (this.operationLog.length === 0) {
            logContainer.innerHTML = `
                <div class="text-muted text-center py-3">
                    <i class="bi bi-info-circle"></i> Select a container and perform operations to see logs here
                </div>
            `;
            return;
        }
        
        const logHTML = this.operationLog.map(entry => {
            const typeClass = `log-${entry.type}`;
            const icon = this.getLogIcon(entry.type);
            
            // Convert line breaks and preserve formatting
            const formattedMessage = entry.message
                .replace(/\r\n/g, '<br>')
                .replace(/\n/g, '<br>')
                .replace(/\r/g, '<br>');
            
            return `
                <div class="log-entry ${typeClass}">
                    <span class="text-muted">[${entry.timestamp}]</span>
                    <i class="${icon}"></i>
                    <div class="log-message">${formattedMessage}</div>
                </div>
            `;
        }).join('');
        
        logContainer.innerHTML = logHTML;
        logContainer.scrollTop = 0;
        
    }
    
    getLogIcon(type) {
        const icons = {
            'success': 'bi bi-check-circle-fill',
            'error': 'bi bi-x-circle-fill',
            'warning': 'bi bi-exclamation-triangle-fill',
            'info': 'bi bi-info-circle-fill'
        };
        return icons[type] || 'bi bi-info-circle-fill';
    }
    
    clearOperationLog() {
        this.operationLog = [];
        this.updateOperationLogDisplay();
    }
    
    refreshOperationLog() {
        // Switch to operation log tab and refresh the display
        this.updateOperationLogDisplay();
    }
    
    getCSRFToken() {
        return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || 
               document.querySelector('input[name="csrf_token"]')?.value || '';
    }
    
    // App Operations
    async getApp() {
        const repoUrl = document.getElementById('app-repo-url').value;
        const branch = document.getElementById('app-branch').value;
        const authMethod = document.getElementById('auth-method').value;
        const githubToken = document.getElementById('github-token').value;
        const overwrite = document.getElementById('get-app-overwrite').checked;
        const getAppBtn = document.getElementById('get-app-btn');
        
        if (!repoUrl) {
            this.addToLog('error', 'Repository URL is required');
            return;
        }
        
        if (!this.selectedContainer) {
            this.addToLog('error', 'Please select a container first');
            return;
        }
        
        // Validate authentication for private repositories
        if (authMethod === 'token' && !githubToken) {
            this.addToLog('error', 'GitHub Personal Access Token is required for private repositories');
            return;
        }
        
        try {
            this.addToLog('info', `Getting app from ${repoUrl} (auth: ${authMethod})...`);
            LoaderManager.setButtonLoading(getAppBtn, true);
            
            let command;
            
            if (authMethod === 'token' && githubToken) {
                // For private repos, modify the URL to include the token
                const repoPath = repoUrl.replace('https://github.com/', '').replace('.git', '');
                const authenticatedUrl = `https://${githubToken}@github.com/${repoPath}.git`;
                command = `bench get-app ${authenticatedUrl}`;
            } else {
                // For public repos, use bench get-app
                command = `bench get-app ${repoUrl}`;
            }
            if (branch) {
                command += ` --branch ${branch}`;
            }
            
            if (overwrite) {
                command += ` --overwrite`;
            }
            
            this.addToLog('info', `Executing command: ${command}`);
            
            const response = await fetchWithLoader('/api/frappe/execute-command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({
                    container: this.selectedContainer,
                    command: command
                })
            }, `Getting app from ${repoUrl}...`);
            
            const result = await response.json();
            
            this.addToLog('info', `Command result: ${JSON.stringify(result)}`);
            
            // Check if this is a background task
            if (result.is_background_task && result.task_id) {
                LoaderManager.setButtonLoading(getAppBtn, false);
                this.addToLog('info', `Heavy command running in background: ${result.task_id}`);
                
                // Track the background task with progress modal
                await this.trackBackgroundTask(result.task_id, `Getting app from ${repoUrl}`);
                
                // Refresh the apps list after completion
                await this.loadAppsForContainer();
            }
            // Check if we have output and no error (streaming responses don't have success field)
            else if (result.output && !result.error) {
                this.addToLog('success', `Successfully got app from ${repoUrl}`);
                if (result.output) {
                    this.addToLog('info', result.output);
                }
                // Refresh the apps list to show the newly installed app
                await this.loadAppsForContainer();
            } else if (result.error) {
                this.addToLog('error', `Failed to get app: ${result.error || 'Unknown error'}`);
                if (result.error) {
                    this.addToLog('error', result.error);
                }
                // Also log the raw result for debugging
                this.addToLog('error', `Raw result: ${JSON.stringify(result)}`);
            }
        } catch (error) {
            this.addToLog('error', `Error getting app: ${error.message}`);
        } finally {
            LoaderManager.setButtonLoading(getAppBtn, false);
        }
    }
    
    async installApp() {
        try {
            const appName = document.getElementById('install-app-name').value;
            const siteName = document.getElementById('install-site-name').value;
            const force = document.getElementById('install-app-force').checked;
            const installAppBtn = document.getElementById('install-app-btn');
            
            if (!appName || !siteName) {
                this.addToLog('error', 'Please select an app and a site');
                return;
            }
            
            if (!this.selectedContainer) {
                this.addToLog('error', 'Please select a container first');
                return;
            }
            
            try {
                this.addToLog('info', `Installing app ${appName} on site ${siteName}...`);
                LoaderManager.setButtonLoading(installAppBtn, true);
                
                // Build the bench install-app command
                let command = `bench --site ${siteName} install-app ${appName}`;
                
                if (force) {
                    command += ` --force`;
                }
                
                this.addToLog('info', `Executing command: ${command}`);
                
                const response = await fetchWithLoader('/api/frappe/execute-command', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCSRFToken()
                    },
                    body: JSON.stringify({
                        container: this.selectedContainer,
                        command: command
                    })
                }, `Installing app ${appName} on site ${siteName}...`);
                
                const result = await response.json();
                
                this.addToLog('info', `Command result: ${JSON.stringify(result)}`);
                
                // Check if this is a background task
                if (result.is_background_task && result.task_id) {
                    LoaderManager.setButtonLoading(installAppBtn, false);
                    this.addToLog('info', `Heavy command running in background: ${result.task_id}`);
                    
                    // Track the background task with progress modal
                    await this.trackBackgroundTask(result.task_id, `Installing ${appName} on ${siteName}`);
                }
                // Check if we have output and no error (streaming responses don't have success field)
                else if (result.output && !result.error) {
                    this.addToLog('success', `Successfully installed app ${appName} on site ${siteName}`);
                    if (result.output) {
                        this.addToLog('info', result.output);
                    }
                } else if (result.error) {
                    this.addToLog('error', `Failed to install app: ${result.error || 'Unknown error'}`);
                    if (result.error) {
                        this.addToLog('error', result.error);
                    }
                    // Also log the raw result for debugging
                    this.addToLog('error', `Raw result: ${JSON.stringify(result)}`);
                }
            } catch (error) {
                this.addToLog('error', `Error installing app: ${error.message}`);
            } finally {
                LoaderManager.setButtonLoading(installAppBtn, false);
            }
        } catch (error) {
            this.addToLog('error', `Error installing app: ${error.message}`);
        }
    }
    
    async uninstallApp() {
        // Get app name using SweetAlert
        const { value: appName } = await Swal.fire({
            title: 'Uninstall App',
            text: 'Enter the app name to uninstall:',
            input: 'text',
            inputPlaceholder: 'Enter app name',
            showCancelButton: true,
            confirmButtonText: 'Next',
            cancelButtonText: 'Cancel',
            inputValidator: (value) => {
                if (!value) {
                    return 'You need to enter an app name!';
                }
            }
        });
        
        if (!appName) return;
        
        // Get site name using SweetAlert
        const { value: siteName } = await Swal.fire({
            title: 'Select Site',
            text: 'Enter the site name:',
            input: 'text',
            inputPlaceholder: 'Enter site name',
            showCancelButton: true,
            confirmButtonText: 'Continue',
            cancelButtonText: 'Cancel',
            inputValidator: (value) => {
                if (!value) {
                    return 'You need to enter a site name!';
                }
            }
        });
        
        if (!siteName) return;
        
        // Confirmation dialog using SweetAlert
        const result = await Swal.fire({
            title: 'Confirm Uninstall',
            text: `Are you sure you want to uninstall "${appName}" from "${siteName}"?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, uninstall it!',
            cancelButtonText: 'Cancel'
        });
        
        if (result.isConfirmed) {
            const command = `bench --site ${siteName} uninstall-app ${appName}`;
            await this.executeCommand(command, `Uninstalling app ${appName} from site ${siteName}`);
        }
    }
    
    async updateApp() {
        // Get app name using SweetAlert
        const { value: appName } = await Swal.fire({
            title: 'Update App',
            text: 'Enter the app name to update:',
            input: 'text',
            inputPlaceholder: 'Enter app name',
            showCancelButton: true,
            confirmButtonText: 'Update',
            cancelButtonText: 'Cancel',
            inputValidator: (value) => {
                if (!value) {
                    return 'You need to enter an app name!';
                }
            }
        });
        
        if (!appName) return;
        
        const command = `bench update --patch`;
        await this.executeCommand(command, `Updating app ${appName}`);
    }
    
    async listApps() {
        // Use safe commands to list apps
        const commands = [
            "cat /home/frappe/frappe-bench/sites/apps.txt",
            "ls -la /home/frappe/frappe-bench/apps/",
            "cat /home/frappe/frappe-bench/sites/apps.json"
        ];
        
        
        for (const cmd of commands) {
            await this.executeCommand(cmd, `Listing apps: ${cmd}`);
        }
        const command = 'bench list-apps';
        await this.executeCommand(command, 'Listing installed apps');
    }
    
    async fixAppsTxt() {
        if (!this.selectedContainer) {
            this.showError('Please select a container first');
            return;
        }
        
        const result = await Swal.fire({
            title: 'Fix apps.txt File',
            html: `
                <div class="text-start">
                    <p>This will fix common issues with apps.txt file:</p>
                    <ul>
                        <li>Fix concatenated app names (e.g., "frappefrappe")</li>
                        <li>Remove duplicate entries</li>
                        <li>Ensure proper line breaks</li>
                        <li>Format file correctly</li>
                    </ul>
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Note:</strong> This will overwrite your apps.txt file.
                        Make sure you have the correct apps installed.
                    </div>
                </div>
            `,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Yes, Fix It',
            cancelButtonText: 'Cancel',
            confirmButtonColor: '#ffc107'
        });
        
        if (!result.isConfirmed) return;
        
        try {
            this.addToLog('info', 'Fixing apps.txt file...');
            
            // Create Python script to fix the file
            const fixScript = `#!/usr/bin/env python3
# Fix apps.txt file
import re
import os
import sys

apps_txt_path = '/home/frappe/frappe-bench/sites/apps.txt'

# Check if file exists
if not os.path.exists(apps_txt_path):
    print(f" Error: apps.txt file not found at {apps_txt_path}")
    sys.exit(1)

# Read current content
try:
    with open(apps_txt_path, 'r') as f:
        content = f.read()
except Exception as e:
    print(f" Error reading apps.txt: {e}")
    sys.exit(1)

print("Current apps.txt content:")
print(content)
print("\\n" + "="*50 + "\\n")

# Known common app names
common_apps = ['frappe', 'erpnext', 'hrms', 'payments', 'wiki', 'helpdesk', 
               'ecommerce', 'insights', 'webshop', 'builder', 'crm', 'lms',
               'healthcare', 'education', 'agriculture', 'non_profit']

# Parse and fix
fixed_apps = []
lines = content.replace('\\r\\n', '\\n').replace('\\r', '\\n').split('\\n')

for line in lines:
    line = line.strip()
    if not line:
        continue
    
    # Check for concatenated apps
    for app in common_apps:
        duplicated = app + app
        if duplicated in line:
            # Found duplication like 'frappefrappe'
            line = line.replace(duplicated, app + '\\n' + app)
    
    # Add fixed line(s)
    for subline in line.split('\\n'):
        subline = subline.strip()
        if subline:
            fixed_apps.append(subline)

# Remove duplicates while preserving order
seen = set()
unique_apps = []
for app in fixed_apps:
    if app and app not in seen:
        seen.add(app)
        unique_apps.append(app)

# Write back with proper formatting
if unique_apps:
    try:
        with open(apps_txt_path, 'w') as f:
            for app in unique_apps:
                f.write(app + '\\n')
        
        print(" Fixed apps.txt successfully!")
        print("\\nFixed apps list:")
        for app in unique_apps:
            print(f"  - {app}")
    except Exception as e:
        print(f" Error writing apps.txt: {e}")
        sys.exit(1)
else:
    print(" No apps found in apps.txt")
    sys.exit(1)
`;

            // Create a temporary file with the script and execute it
            const tempFile = `/tmp/fix_apps_txt_${Date.now()}.py`;
            
            // First, write the script to a file
            const writeCommand = `cat > ${tempFile} << 'EOFPYTHON'
${fixScript}
EOFPYTHON`;
            
            await fetchWithLoader('/api/frappe/execute-command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({
                    container: this.selectedContainer,
                    command: writeCommand
                })
            }, 'Creating fix script...');
            
            // Then execute the script
            const response = await fetchWithLoader('/api/frappe/execute-command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({
                    container: this.selectedContainer,
                    command: `python3 ${tempFile} && rm -f ${tempFile}`
                })
            }, 'Fixing apps.txt...');
            
            const data = await response.json();
            
            if (data.error) {
                this.addToLog('error', `Failed to fix apps.txt: ${data.error}`);
                Swal.fire({
                    title: 'Error',
                    html: `<pre style="text-align: left; max-height: 300px; overflow-y: auto;">${data.error}</pre>`,
                    icon: 'error',
                    confirmButtonColor: '#dc3545'
                });
            } else if (data.output) {
                this.addToLog('success', ' apps.txt file has been fixed!');
                this.addToLog('info', data.output);
                
                // Reload the apps list
                await this.loadAppsForContainer();
                
                Swal.fire({
                    title: 'Success!',
                    html: `<div style="text-align: left;"><strong>apps.txt file has been fixed successfully.</strong><pre style="max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px;">${data.output}</pre></div>`,
                    icon: 'success',
                    width: '700px',
                    confirmButtonColor: '#28a745'
                });
            } else {
                this.addToLog('error', 'No output received from fix operation');
                Swal.fire({
                    title: 'Error',
                    text: 'No output received. The operation may have failed.',
                    icon: 'error',
                    confirmButtonColor: '#dc3545'
                });
            }
        } catch (error) {
            this.addToLog('error', `Error fixing apps.txt: ${error.message}`);
            Swal.fire({
                title: 'Error',
                text: error.message,
                icon: 'error',
                confirmButtonColor: '#dc3545'
            });
        }
    }
    
    async restartBench() {
        if (!this.selectedContainer) {
            this.showError('Please select a container first');
            return;
        }
        const result = await Swal.fire({
            title: 'Restart Bench Services',
            text: 'Are you sure you want to restart the bench? This will restart all services.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, restart it!',
            cancelButtonText: 'Cancel'
        });
        
        if (result.isConfirmed) {
            const command = '/home/frappe/.local/bin/supervisorctl -c /home/frappe/supervisor/supervisord.conf restart all';
            await this.executeCommand(command, 'Restarting bench services via Supervisor');
        }
    }
    
    async supervisorStatus() {
        if (!this.selectedContainer) {
            this.showError('Please select a container first');
            return;
        }
        const command = '/home/frappe/.local/bin/supervisorctl -c /home/frappe/supervisor/supervisord.conf status';
        await this.executeCommand(command, 'Checking Supervisor status');
    }
    
    async openAsAdministrator() {
        if (!this.selectedContainer) {
            await Swal.fire({
                title: 'No Container Selected',
                text: 'Please select a container first',
                icon: 'warning'
            });
            return;
        }

        // Get site name using SweetAlert with dropdown
        const { value: siteName } = await Swal.fire({
            title: 'Open Site as Administrator',
            html: `
                <div class="text-start mb-3">
                    <label for="admin-site-select" class="form-label">Select Site:</label>
                    <select class="form-select" id="admin-site-select">
                        <option value="">Loading sites...</option>
                    </select>
                </div>
                <div class="text-start mb-3">
                    <label for="admin-port-select" class="form-label">Select Port:</label>
                    <select class="form-select" id="admin-port-select">
                        <option value="">Loading ports...</option>
                    </select>
                </div>
                <div class="alert alert-info text-start mb-0">
                    <i class="bi bi-info-circle"></i> This will open the selected site in a new browser tab. Make sure you know the administrator password.
                </div>
            `,
            showCancelButton: true,
            confirmButtonText: 'Open Site',
            cancelButtonText: 'Cancel',
            didOpen: async () => {
                const siteSelect = document.getElementById('admin-site-select');
                const portSelect = document.getElementById('admin-port-select');
                
                try {
                    // Load sites and get default site from config
                    const [sitesResponse, configResponse, portsResponse] = await Promise.all([
                        // Get sites list
                        fetch('/api/frappe/execute-command', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': this.getCSRFToken()
                            },
                            body: JSON.stringify({
                                container: this.selectedContainer,
                            command: 'cat ~/frappe-bench/sites/currentsite.txt'
                            })
                        }),
                        // Get default site from config
                        fetch('/api/frappe/execute-command', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': this.getCSRFToken()
                            },
                            body: JSON.stringify({
                                container: this.selectedContainer,
                                command: 'cat ~/frappe-bench/sites/common_site_config.json 2>/dev/null | grep -o \'"default_site": *"[^"]*"\' | head -1 || echo ""'
                            })
                        }),
                        // Get available ports
                        fetch('/api/frappe/execute-command', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': this.getCSRFToken()
                            },
                            body: JSON.stringify({
                                container: this.selectedContainer,
                                command: "echo ':8080' && echo ':8081' && echo ':8082' && echo ':8083' && echo ':8084' && echo ':8085' && echo ':80' && echo ':443'"
                            })
                        })
                    ]);
                    
                    const [sitesResult, configResult, portsResult] = await Promise.all([
                        sitesResponse.json(),
                        configResponse.json(),
                        portsResponse.json()
                    ]);
                    
                    // Populate sites dropdown
                    if (sitesResult.output && !sitesResult.error) {
                        const sites = sitesResult.output.trim().split('\n').filter(site => site.trim());
                        siteSelect.innerHTML = '<option value="">-- Select a site --</option>';
                        sites.forEach(site => {
                            const siteName = site.trim();
                            if (siteName) {
                                const option = document.createElement('option');
                                option.value = siteName;
                                option.textContent = siteName;
                                siteSelect.appendChild(option);
                            }
                        });
                        
                        // Set default site if found in config
                        if (configResult.output && configResult.output.includes('default_site')) {
                            const defaultSiteMatch = configResult.output.match(/"default_site":\s*"([^"]+)"/);
                            if (defaultSiteMatch && defaultSiteMatch[1]) {
                                const defaultSite = defaultSiteMatch[1];
                                siteSelect.value = defaultSite;
                            }
                        }
                    } else {
                        siteSelect.innerHTML = '<option value="">Failed to load sites</option>';
                    }
                    
                    // Populate ports dropdown
                    
                    if (portsResult.output && !portsResult.error) {
                        const portLines = portsResult.output.trim().split('\n').filter(line => line.trim());
                        
                        const ports = new Set();
                        
                        // Extract ports from netstat/ss output
                        portLines.forEach(line => {
                            const portMatch = line.match(/:(\d+)/);
                            if (portMatch) {
                                ports.add(portMatch[1]);
                            }
                        });
                        
                        
                        // Add common ports if none found
                        if (ports.size === 0) {
                            ['443', '8081', '8080', '8082', '8083', '8084', '8085', '80'].forEach(port => ports.add(port));
                        }
                        
                        portSelect.innerHTML = '<option value="">-- Select a port --</option>';
                        Array.from(ports).sort().forEach(port => {
                            const option = document.createElement('option');
                            option.value = port;
                            option.textContent = `${port} ${port === '443' ? '(HTTPS)' : port === '80' ? '(HTTP)' : ''}`;
                            portSelect.appendChild(option);
                        });
                        
                        // Set default to 8081 if available
                        if (ports.has('8081')) {
                            portSelect.value = '8081';
                        } else if (ports.has('443')) {
                            portSelect.value = '443';
                        }
                        
                    } else {
                        portSelect.innerHTML = '<option value="">Failed to load ports</option>';
                    }
                } catch (error) {
                    siteSelect.innerHTML = '<option value="">Error loading sites</option>';
                    portSelect.innerHTML = '<option value="">Error loading ports</option>';
                }
            },
            preConfirm: () => {
                const siteSelect = document.getElementById('admin-site-select');
                const portSelect = document.getElementById('admin-port-select');
                const site = siteSelect.value;
                const port = portSelect.value;
                
                if (!site) {
                    Swal.showValidationMessage('Please select a site');
                    return false;
                }
                
                if (!port) {
                    Swal.showValidationMessage('Please select a port');
                    return false;
                }
                
                return { site, port };
            }
        });
        
        if (!siteName) return;

        try {
            const { site, port } = siteName;
            const protocol = port === '443' ? 'https' : 'http';
            const siteUrl = `${protocol}://${site}:${port}`;
            
            this.addToLog('info', `Opening site: ${siteUrl}`);
            this.addToLog('info', `Selected site: ${site}`);
            this.addToLog('info', `Selected port: ${port}`);
            this.addToLog('info', `Protocol: ${protocol}`);
            
            // Get the site URL configuration
            const response = await fetchWithLoader('/api/frappe/execute-command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({
                    container: this.selectedContainer,
                    command: `cat ~/frappe-bench/sites/${site}/site_config.json`
                })
            }, `Getting site configuration for ${site}...`);
            
            const result = await response.json();
            
            if (result.output && !result.error) {
                try {
                    const siteConfig = JSON.parse(result.output);
                    let siteUrl = siteConfig.host_name || site;
                    
                    this.addToLog('info', `Site config: ${JSON.stringify(siteConfig)}`);
                    this.addToLog('info', `Site hostname: ${siteUrl}`);
                    
                    // Use the selected port from the dropdown
                    let selectedPort = port;
                    
                    // Build the complete URL with Traefik port
                    if (siteUrl.includes(':')) {
                        // URL already has port or is an IP with port
                        siteUrl = siteUrl;
                    } else {
                        // Add Traefik port to the URL
                        siteUrl = siteUrl + ':' + selectedPort;
                    }
                    
                    // Ensure the URL has a protocol
                    if (!siteUrl.startsWith('http://') && !siteUrl.startsWith('https://')) {
                        siteUrl = 'http://' + siteUrl;
                    }
                    
                    this.addToLog('success', `Opening ${siteName} at ${siteUrl}`);
                    
                    // Force login as Administrator without password
                    // Try multiple auto-login methods
                    const autoLoginMethods = [
                        `${siteUrl}/login?usr=administrator&pwd=admin`, // Default password
                        `${siteUrl}/desk`, // Direct desk access
                        `${siteUrl}/app` // Direct app access
                    ];
                    
                    // Try the first method (most common)
                    const loginUrl = autoLoginMethods[0];
                    window.open(loginUrl, '_blank');
                    
                    await Swal.fire({
                        title: 'Force Login as Administrator',
                        html: `
                            <p>Site opened with force login:</p>
                            <p><strong>${siteUrl}</strong></p>
                            <hr>
                            <div class="alert alert-success text-start">
                                <h6><i class="bi bi-shield-check"></i> Force Login Active</h6>
                                <p class="mb-1"><strong>Username:</strong> Administrator</p>
                                <p class="mb-1"><strong>Method:</strong> Auto-login with default password</p>
                                <p class="mb-0"><strong>Status:</strong> Attempting automatic login...</p>
                            </div>
                            <div class="alert alert-info text-start mb-0">
                                <small><i class="bi bi-info-circle"></i> If this doesn't work, try the Terminal tab to reset the admin password with "bench set-admin-password newpassword".</small>
                            </div>
                        `,
                        icon: 'success'
                    });
                } catch (parseError) {
                    // If we can't parse the config, just try to open the site name with selected port
                    let siteUrl = 'http://' + site + ':' + port;
                    this.addToLog('warning', `Could not parse site config, trying ${siteUrl}`);
                    
                    // Force login as Administrator
                    const loginUrl = `${siteUrl}/login?usr=Administrator&pwd=admin`;
                    window.open(loginUrl, '_blank');
                    
                    await Swal.fire({
                        title: 'Site Opened',
                        html: `
                            <p>Site opened in a new tab:</p>
                            <p><strong>${siteUrl}</strong></p>
                            <div class="alert alert-warning text-start">
                                <i class="bi bi-exclamation-triangle"></i> Could not determine the exact URL. If the site doesn't load, check your Traefik configuration or site settings.
                            </div>
                        `,
                        icon: 'info'
                    });
                }
            } else {
                // Fallback: just try to open with the site name and selected port
                let siteUrl = 'http://' + site + ':' + port;
                this.addToLog('warning', `Could not get site config, trying ${siteUrl}`);
                
                // Force login as Administrator
                const loginUrl = `${siteUrl}/login?usr=Administrator&pwd=admin`;
                window.open(loginUrl, '_blank');
                
                await Swal.fire({
                    title: 'Site Opened',
                    html: `
                        <p>Site opened in a new tab:</p>
                        <p><strong>${siteUrl}</strong></p>
                        <div class="alert alert-warning text-start">
                            <i class="bi bi-exclamation-triangle"></i> Could not read site configuration. If the site doesn't load, check your Traefik configuration.
                        </div>
                    `,
                    icon: 'info'
                });
            }
        } catch (error) {
            this.addToLog('error', `Error opening site: ${error.message}`);
            await Swal.fire({
                title: 'Error',
                text: `Error: ${error.message}`,
                icon: 'error'
            });
        }
    }
    
    async benchBuild() {
        if (!this.selectedContainer) {
            this.showError('Please select a container first');
            return;
        }
        
        const appName = document.getElementById('build-app-name').value;
        const force = document.getElementById('build-force').checked;
        
        let command;
        if (appName) {
            command = `bench build --app ${appName}`;
        } else {
            command = 'bench build';
        }
        
        if (force) {
            command += ` --force`;
        }
        
        const description = appName ? `Building app: ${appName}` : 'Building all apps';
        await this.executeCommand(command, description);
    }
    
    
    // Quick Actions
    async benchStatus() {
        // Use safe version of bench status
        const benchVersionCommand = "bench --version";
        await this.executeCommand(benchVersionCommand, "Checking bench version");
        
        // Also try to get basic info
        const infoCommand = "ls -la /home/frappe/frappe-bench/apps/";
        await this.executeCommand(infoCommand, "Listing installed apps directory");
        
        const sitesCommand = "ls -la /home/frappe/frappe-bench/sites/";
        await this.executeCommand(sitesCommand, "Listing sites directory");
        const benchStatusCommand = 'bench doctor';
        await this.executeCommand(benchStatusCommand, 'Checking bench status');
    }
    
    async benchInfo() {
        // Use safe commands instead of bench info
        const commands = [
            "bench --version",
            "cat /home/frappe/frappe-bench/sites/apps.txt",
            "cat /home/frappe/frappe-bench/sites/currentsite.txt",
            "ls -la /home/frappe/frappe-bench/apps/"
        ];
        
        for (const cmd of commands) {
            await this.executeCommand(cmd, `Getting bench info: ${cmd}`);
        }
        const command = 'bench version';
        await this.executeCommand(command, 'Getting bench information');
    }
    
    async clearCache() {
        const commands = [
            'bench clear-cache',
            'bench clear-website-cache',
        ];
        for (const cmd of commands) {
            await this.executeCommand(cmd, `Clearing cache with website`);
        }
    }
    
    async migrate() {
        const command = 'bench migrate';
        await this.executeCommand(command, 'Running migrations');
    }
    
    async refreshContainers() {
        this.addToLog('info', 'Refreshing container list...');
        window.location.reload();
    }
    
    initializeTerminal() {
        const terminalContainer = document.getElementById('terminal-container');
        if (terminalContainer) {
            try {
                window.terminal = new XTermWS(terminalContainer, {
                    theme: {
                        background: '#1a1a1a',
                        foreground: '#ffffff',
                        cursor: '#ffffff',
                        selection: 'rgba(255, 255, 255, 0.3)',
                        black: '#000000',
                        red: '#cc0000',
                        green: '#4e9a06',
                        yellow: '#c4a000',
                        blue: '#3465a4',
                        magenta: '#75507b',
                        cyan: '#06989a',
                        white: '#d3d7cf',
                        brightBlack: '#555753',
                        brightRed: '#ef2929',
                        brightGreen: '#8ae234',
                        brightYellow: '#fce94f',
                        brightBlue: '#729fcf',
                        brightMagenta: '#ad7fa8',
                        brightCyan: '#34e2e2',
                        brightWhite: '#eeeeec'
                    }
                });
                
                const containerSelect = document.getElementById('container-select');
                if (containerSelect && containerSelect.value) {
                    setTimeout(() => {
                        if (window.terminal) {
                            window.terminal.connectToContainer(containerSelect.value);
                            
                            const terminalTitle = document.getElementById('terminal-title');
                            if (terminalTitle) {
                                terminalTitle.textContent = `Terminal: ${containerSelect.value}`;
                            }
                        }
                    }, 1000);
                }
            } catch (error) {
                console.error('Error initializing terminal:', error);
            }
        }
    }
    
    initializeSSH() {
        if (window.SSHManager) {
            window.SSHManager.initializeSSHEventListeners();
        } else {
            console.error('SSHManager not loaded');
        }
    }
    
    initializeTerminalLogs() {
        const refreshBtn = document.getElementById('refresh-logs-btn');
        const clearBtn = document.getElementById('clear-logs-btn');
        
        if (refreshBtn) {
            refreshBtn.addEventListener('click', loadTerminalLogs);
        }
        
        if (clearBtn) {
            clearBtn.addEventListener('click', clearTerminalLogs);
        }
        
        const terminalLogsTab = document.getElementById('terminal-logs-tab');
        if (terminalLogsTab) {
            terminalLogsTab.addEventListener('shown.bs.tab', function() {
                loadTerminalLogs();
                startPeriodicRefresh();
            });
            
            terminalLogsTab.addEventListener('hidden.bs.tab', function() {
                stopPeriodicRefresh();
            });
        }
        
        loadTerminalLogs();
        setupRealTimeErrorTracking();
    }

    // Updated loadAppsForContainer method:
    async loadAppsForContainer() {
        if (!this.selectedContainer) {
            this.clearAppsDropdown();
            return;
        }
        
        
        try {
            // Show loading state
            this.setAppsDropdownLoading(true);
            
            const response = await fetchWithLoader('/api/frappe/execute-command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({
                    container: this.selectedContainer,
                    command: 'cat ~/frappe-bench/sites/apps.txt'
                })
            }, 'Loading apps...');
            
            const result = await response.json();
            
            // Check if we have output and no error (streaming responses don't have success field)
            if (result.output && !result.error) {
                // Use the raw output directly since it's already in the correct format
                this.populateAppsDropdown(result.output);
            } else {
                this.addToLog('error', `Failed to load apps: ${result.error || 'Unknown error'}`);
                this.clearAppsDropdown();
            }
        } catch (error) {
            this.addToLog('error', `Error loading apps: ${error.message}`);
            this.clearAppsDropdown();
        } finally {
            this.setAppsDropdownLoading(false);
        }
    }

    // Updated populateAppsDropdown method:
    populateAppsDropdown(appsOutput) {
        const appsSelect = document.getElementById('install-app-name');
        const buildAppsSelect = document.getElementById('build-app-name');
        if (!appsSelect) {
            return;
        }
        
        // Clear existing options except the first one
        appsSelect.innerHTML = '<option value="">Select an app...</option>';
        if (buildAppsSelect) {
            buildAppsSelect.innerHTML = '<option value="">Build All Apps</option>';
        }
        
        if (!appsOutput || appsOutput.trim() === '') {
            return;
        }
        
        // Parse the apps output - bench list-apps shows: "appname version status"
        const lines = appsOutput.trim().split('\n').filter(line => line.trim() !== '');
        
        const apps = [];
        
        lines.forEach(line => {
            const trimmed = line.trim();
            if (trimmed) {
                // Extract just the app name (first word before spaces)
                const appName = trimmed.split(/\s+/)[0];
                if (appName && !apps.includes(appName)) {
                    apps.push(appName);
                }
            }
        });
        
        apps.forEach(app => {
            const option = document.createElement('option');
            option.value = app;
            option.textContent = app;
            appsSelect.appendChild(option);
            
            // Also add to build apps dropdown
            const buildAppsSelect = document.getElementById('build-app-name');
            if (buildAppsSelect) {
                const buildOption = document.createElement('option');
                buildOption.value = app;
                buildOption.textContent = app;
                buildAppsSelect.appendChild(buildOption);
            }
        });
    }

    // Method to clear the apps dropdown
    clearAppsDropdown() {
        const appsSelect = document.getElementById('install-app-name');
        const buildAppsSelect = document.getElementById('build-app-name');
        if (appsSelect) {
            appsSelect.innerHTML = '<option value="">Select an app...</option>';
        if (buildAppsSelect) {
            buildAppsSelect.innerHTML = '<option value="">Build All Apps</option>';
        }
        }
    }

    // Method to set loading state for apps dropdown
    setAppsDropdownLoading(isLoading) {
        const appsSelect = document.getElementById('install-app-name');
        const buildAppsSelect = document.getElementById('build-app-name');
        if (!appsSelect) return;
        
        if (isLoading) {
            appsSelect.innerHTML = '<option value="">Loading apps...</option>';
            if (buildAppsSelect) buildAppsSelect.innerHTML = '<option value="">Loading apps...</option>';
            if (buildAppsSelect) buildAppsSelect.disabled = true;
            appsSelect.disabled = true;
        } else {
            appsSelect.disabled = false;
            if (buildAppsSelect) buildAppsSelect.disabled = false;
        }
    }

    // Add a refresh apps button or method
    async refreshApps() {
        if (!this.selectedContainer) {
            this.addToLog('error', 'Please select a container first');
            return;
        }
        
        await this.loadAppsForContainer();
        await this.loadSitesForContainer(); // Also refresh sites
        this.addToLog('info', 'Apps and sites list refreshed');
    }

    // Add method to load sites for the selected container
    async loadSitesForContainer() {
        if (!this.selectedContainer) {
            this.clearSitesDropdown();
            return;
        }
        
        try {
            // Show loading state
            this.setSitesDropdownLoading(true);
            
            const response = await fetchWithLoader('/api/frappe/execute-command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({
                    container: this.selectedContainer,
                    command: 'cat ~/frappe-bench/sites/currentsite.txt'
                })
            }, 'Loading sites...');
            
            const result = await response.json();
            
            // Check if we have output and no error (streaming responses don't have success field)
            if (result.output && !result.error) {
                // Use the raw output directly since it's already in the correct format
                this.populateSitesDropdown(result.output);
            } else {
                this.addToLog('error', `Failed to load sites: ${result.error || 'Unknown error'}`);
                this.clearSitesDropdown();
            }
        } catch (error) {
            this.addToLog('error', `Error loading sites: ${error.message}`);
            this.clearSitesDropdown();
        } finally {
            this.setSitesDropdownLoading(false);
        }
    }

    // Method to populate the sites dropdown
    populateSitesDropdown(sitesOutput) {
        const sitesSelect = document.getElementById('install-site-name');
        if (!sitesSelect) {
            return;
        }
        
        // Clear existing options except the first one
        sitesSelect.innerHTML = '<option value="">Select a site...</option>';
        
        if (!sitesOutput || sitesOutput.trim() === '') {
            return;
        }
        
        // Parse the sites output - remove leading/trailing whitespace and split by newlines
        const allItems = sitesOutput.trim().split('\n').filter(item => item.trim() !== '');
        
        // Filter out non-site files and directories
        const sites = allItems.filter(item => {
            const trimmed = item.trim();
            // Include files that look like site names (contain dots or are typical site names)
            return trimmed && 
                   !trimmed.includes('common_site_config.json') && 
                   !trimmed.includes('currentsite.txt') &&
                   !trimmed.startsWith('.') &&
                   (trimmed.includes('.') || trimmed.match(/^[a-zA-Z0-9_-]+$/));
        });
        
        sites.forEach(site => {
            const siteName = site.trim();
            if (siteName) {
                const option = document.createElement('option');
                option.value = siteName;
                option.textContent = siteName;
                sitesSelect.appendChild(option);
            }
        });
    }

    // Method to clear the sites dropdown
    clearSitesDropdown() {
        const sitesSelect = document.getElementById('install-site-name');
        if (sitesSelect) {
            sitesSelect.innerHTML = '<option value="">Select a site...</option>';
        }
    }

    // Method to set loading state for sites dropdown
    setSitesDropdownLoading(isLoading) {
        const sitesSelect = document.getElementById('install-site-name');
        if (!sitesSelect) return;
        
        if (isLoading) {
            sitesSelect.innerHTML = '<option value="">Loading sites...</option>';
            sitesSelect.disabled = true;
        } else {
            sitesSelect.disabled = false;
        }
    }

    // Method to refresh sites
    async refreshSites() {
        if (!this.selectedContainer) {
            this.addToLog('error', 'Please select a container first');
            return;
        }
        
        await this.loadSitesForContainer();
        this.addToLog('info', 'Sites list refreshed');
    }

    // Add this debug method to test the endpoint:
    async testListAppsEndpoint() {
        
        try {
            const response = await fetch('/api/frappe/list-apps', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({
                    container: this.selectedContainer
                })
            });
            
            if (response.status === 404) {
                this.addToLog('error', 'API endpoint /api/frappe/list-apps not found');
                return false;
            }
            
            const result = await response.json();
            
            return result;
        } catch (error) {
            this.addToLog('error', `Error testing endpoint: ${error.message}`);
            return false;
        }
    }

    // Backup & Restore Methods
    onBackupContainerChange(containerName) {
        this.backupContainer = containerName;
        if (containerName) {
            this.loadBackupSites();
        } else {
            this.clearBackupSites();
        }
    }

    async loadBackupSites() {
        if (!this.backupContainer) {
            this.addToLog('error', 'Please select a container first');
            return;
        }

        try {
            const response = await fetchWithLoader('/api/frappe/execute-command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({
                    container: this.backupContainer,
                    command: 'ls -d ~/frappe-bench/sites/*/ | grep -v "assets\\|common" | xargs -n 1 basename'
                })
            }, 'Loading sites...');

            const result = await response.json();

            if (result.output && !result.error) {
                this.populateBackupSites(result.output);
            } else {
                this.addToLog('error', `Failed to load sites: ${result.error || 'Unknown error'}`);
                this.clearBackupSites();
            }
        } catch (error) {
            this.addToLog('error', `Error loading sites: ${error.message}`);
            this.clearBackupSites();
        }
    }

    populateBackupSites(sitesOutput) {
        const sitesSelect = document.getElementById('backup-site-name');
        if (!sitesSelect) return;

        sitesSelect.innerHTML = '<option value="">Select a site...</option>';

        if (!sitesOutput || sitesOutput.trim() === '') return;

        const sites = sitesOutput.trim().split('\n').filter(site => site.trim() !== '');

        sites.forEach(site => {
            const siteName = site.trim();
            if (siteName) {
                const option = document.createElement('option');
                option.value = siteName;
                option.textContent = siteName;
                sitesSelect.appendChild(option);
            }
        });
    }

    clearBackupSites() {
        const sitesSelect = document.getElementById('backup-site-name');
        if (sitesSelect) {
            sitesSelect.innerHTML = '<option value="">Select a site...</option>';
        }
    }

    async createBackup() {
        const container = document.getElementById('backup-container-select').value;
        const siteName = document.getElementById('backup-site-name').value;
        const includePrivateFiles = document.getElementById('backup-private-files').checked;
        const includePublicFiles = document.getElementById('backup-public-files').checked;

        if (!container || !siteName) {
            await Swal.fire({
                title: 'Missing Information',
                text: 'Please select a container and site name',
                icon: 'warning'
            });
            return;
        }

        const result = await Swal.fire({
            title: 'Create Backup',
            html: `
                <p>Create backup for site: <strong>${siteName}</strong></p>
                <p>This may take several minutes for large sites.</p>
            `,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Create Backup',
            cancelButtonText: 'Cancel',
            confirmButtonColor: '#007bff'
        });

        if (!result.isConfirmed) return;

        try {
            this.addToLog('info', `Creating backup for ${siteName}...`);

            const response = await fetchWithLoader('/api/frappe/backup/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({
                    container: container,
                    site_name: siteName,
                    include_files: includePrivateFiles || includePublicFiles,
                    include_private_files: includePrivateFiles,
                    include_public_files: includePublicFiles
                })
            }, `Creating backup for ${siteName}...`);

            const data = await response.json();

            if (data.success && data.task_id) {
                // Show progress modal and track task
                await this.trackBackgroundTask(data.task_id, `Creating Backup: ${siteName}`);
                
                // Refresh backups list after completion
                this.loadBackupsList();
            } else if (data.error) {
                this.addToLog('error', `Failed to create backup: ${data.error}`);
                await Swal.fire({
                    title: 'Error',
                    text: data.error || 'Failed to create backup',
                    icon: 'error'
                });
            }
        } catch (error) {
            this.addToLog('error', `Error creating backup: ${error.message}`);
            await Swal.fire({
                title: 'Error',
                text: `Error: ${error.message}`,
                icon: 'error'
            });
        }
    }

    async loadBackupsList() {
        const container = document.getElementById('backup-container-select').value;
        const siteName = document.getElementById('backup-site-name').value;

        if (!container || !siteName) {
            await Swal.fire({
                title: 'Missing Information',
                text: 'Please select a container and site name',
                icon: 'warning'
            });
            return;
        }

        try {
            const response = await fetchWithLoader('/api/frappe/backup/list', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({
                    container: container,
                    site_name: siteName
                })
            }, 'Loading backups...');

            const data = await response.json();

            if (data.success) {
                this.displayBackupsList(data.backups);
                this.populateRestoreDropdowns(data.backups);
                this.addToLog('info', `Loaded ${data.count} backup(s)`);
            } else {
                this.addToLog('error', `Failed to load backups: ${data.error}`);
                this.clearBackupsList();
            }
        } catch (error) {
            this.addToLog('error', `Error loading backups: ${error.message}`);
            this.clearBackupsList();
        }
    }

    displayBackupsList(backups) {
        const tbody = document.getElementById('backups-tbody');
        if (!tbody) return;

        if (!backups || backups.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted py-4">
                        <i class="bi bi-inbox me-2"></i>
                        No backups found for this site.
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = backups.map((backup, index) => {
            const typeBadge = backup.type === 'database' ? 'bg-primary' :
                            backup.type === 'private_files' ? 'bg-warning' :
                            backup.type === 'public_files' ? 'bg-info' : 'bg-secondary';

            return `
                <tr>
                    <td>${index + 1}</td>
                    <td><code>${backup.filename}</code></td>
                    <td><span class="badge ${typeBadge}">${backup.type.replace('_', ' ')}</span></td>
                    <td>${backup.size}</td>
                    <td>${backup.date}</td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-primary" onclick="window.frappeAppManager.downloadBackup('${backup.path}', '${backup.filename}')" title="Download">
                                <i class="bi bi-download"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="window.frappeAppManager.deleteBackup('${backup.path}', '${backup.filename}')" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    populateRestoreDropdowns(backups) {
        const databaseSelect = document.getElementById('restore-database-backup');
        const privateSelect = document.getElementById('restore-private-backup');
        const publicSelect = document.getElementById('restore-public-backup');

        if (databaseSelect) {
            databaseSelect.innerHTML = '<option value="">Select database backup...</option>';
            backups.filter(b => b.type === 'database').forEach(backup => {
                const option = document.createElement('option');
                option.value = backup.path;
                option.textContent = `${backup.filename} (${backup.size})`;
                databaseSelect.appendChild(option);
            });
        }

        if (privateSelect) {
            privateSelect.innerHTML = '<option value="">None</option>';
            backups.filter(b => b.type === 'private_files').forEach(backup => {
                const option = document.createElement('option');
                option.value = backup.path;
                option.textContent = `${backup.filename} (${backup.size})`;
                privateSelect.appendChild(option);
            });
        }

        if (publicSelect) {
            publicSelect.innerHTML = '<option value="">None</option>';
            backups.filter(b => b.type === 'public_files').forEach(backup => {
                const option = document.createElement('option');
                option.value = backup.path;
                option.textContent = `${backup.filename} (${backup.size})`;
                publicSelect.appendChild(option);
            });
        }
    }

    clearBackupsList() {
        const tbody = document.getElementById('backups-tbody');
        if (tbody) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted py-4">
                        <i class="bi bi-inbox me-2"></i>
                        No backups available. Select a container and site, then click "Refresh" to load backups.
                    </td>
                </tr>
            `;
        }
    }

    async deleteBackup(backupPath, filename) {
        const container = document.getElementById('backup-container-select').value;

        const result = await Swal.fire({
            title: 'Delete Backup',
            html: `<p>Are you sure you want to delete:</p><p><code>${filename}</code></p><p>This action cannot be undone.</p>`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Delete',
            cancelButtonText: 'Cancel',
            confirmButtonColor: '#dc3545'
        });

        if (!result.isConfirmed) return;

        try {
            const response = await fetchWithLoader('/api/frappe/backup/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({
                    container: container,
                    backup_path: backupPath
                })
            }, `Deleting backup ${filename}...`);

            const data = await response.json();

            if (data.success) {
                this.addToLog('success', `Backup deleted: ${filename}`);
                await Swal.fire({
                    title: 'Deleted!',
                    text: 'Backup has been deleted.',
                    icon: 'success',
                    timer: 2000
                });
                this.loadBackupsList();
            } else {
                this.addToLog('error', `Failed to delete backup: ${data.error}`);
                await Swal.fire({
                    title: 'Error',
                    text: data.error || 'Failed to delete backup',
                    icon: 'error'
                });
            }
        } catch (error) {
            this.addToLog('error', `Error deleting backup: ${error.message}`);
            await Swal.fire({
                title: 'Error',
                text: `Error: ${error.message}`,
                icon: 'error'
            });
        }
    }

    async restoreBackup() {
        const container = document.getElementById('backup-container-select').value;
        const siteName = document.getElementById('backup-site-name').value;
        const databaseBackup = document.getElementById('restore-database-backup').value;
        const privateBackup = document.getElementById('restore-private-backup').value;
        const publicBackup = document.getElementById('restore-public-backup').value;
        const mysqlPassword = document.getElementById('restore-mysql-root-password').value;
        const adminPassword = document.getElementById('restore-admin-password').value;

        if (!container || !siteName || !databaseBackup) {
            await Swal.fire({
                title: 'Missing Information',
                text: 'Please select a container, site, and database backup',
                icon: 'warning'
            });
            return;
        }

        if (!mysqlPassword) {
            await Swal.fire({
                title: 'MySQL Password Required',
                text: 'Please enter the MySQL root password for database restoration',
                icon: 'warning'
            });
            return;
        }

        const result = await Swal.fire({
            title: 'Restore Backup?',
            html: `
                <div class="alert alert-danger text-start">
                    <h6> WARNING</h6>
                    <p>This will <strong>REPLACE ALL DATA</strong> on site: <strong>${siteName}</strong></p>
                    <p class="mb-0">This action cannot be undone!</p>
                </div>
                <p class="text-start">Files to restore:</p>
                <ul class="text-start">
                    <li>Database: <code>${databaseBackup.split('/').pop()}</code></li>
                    ${privateBackup ? `<li>Private Files: <code>${privateBackup.split('/').pop()}</code></li>` : ''}
                    ${publicBackup ? `<li>Public Files: <code>${publicBackup.split('/').pop()}</code></li>` : ''}
                </ul>
            `,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, Restore',
            cancelButtonText: 'Cancel',
            confirmButtonColor: '#dc3545'
        });

        if (!result.isConfirmed) return;

        try {
            this.addToLog('info', `Restoring backup for ${siteName}...`);

            const response = await fetchWithLoader('/api/frappe/backup/restore', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({
                    container: container,
                    site_name: siteName,
                    backup_path: databaseBackup,
                    private_files_path: privateBackup || null,
                    public_files_path: publicBackup || null,
                    mysql_root_password: mysqlPassword,
                    admin_password: adminPassword || null
                })
            }, `Restoring backup for ${siteName}...`);

            const data = await response.json();

            if (data.success && data.task_id) {
                // Show progress modal and track task
                await this.trackBackgroundTask(data.task_id, `Restoring Backup: ${siteName}`);
            } else if (data.error) {
                this.addToLog('error', `Failed to restore backup: ${data.error}`);
                await Swal.fire({
                    title: 'Error',
                    text: data.error || 'Failed to restore backup',
                    icon: 'error'
                });
            }
        } catch (error) {
            this.addToLog('error', `Error restoring backup: ${error.message}`);
            await Swal.fire({
                title: 'Error',
                text: `Error: ${error.message}`,
                icon: 'error'
            });
        }
    }

    async downloadBackup(backupPath, filename) {
        const container = document.getElementById('backup-container-select').value;

        if (!container) {
            await Swal.fire({
                title: 'Error',
                text: 'No container selected',
                icon: 'error'
            });
            return;
        }

        try {
            this.addToLog('info', `Preparing download for ${filename}...`);

            // First, prepare the backup for download (copy from container to host)
            const response = await fetchWithLoader('/api/frappe/backup/prepare-download', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({
                    container: container,
                    backup_path: backupPath
                })
            }, `Preparing ${filename} for download...`);

            const data = await response.json();

            if (data.success) {
                this.addToLog('success', `Download ready: ${filename}`);

                // Create a temporary link and trigger download
                const downloadLink = document.createElement('a');
                downloadLink.href = data.download_url;
                downloadLink.download = data.filename;
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);

                await Swal.fire({
                    title: 'Download Started',
                    text: `Downloading ${filename}...`,
                    icon: 'success',
                    timer: 2000
                });
            } else {
                this.addToLog('error', `Failed to prepare download: ${data.error}`);
                await Swal.fire({
                    title: 'Error',
                    text: data.error || 'Failed to prepare download',
                    icon: 'error'
                });
            }
        } catch (error) {
            this.addToLog('error', `Error downloading backup: ${error.message}`);
            await Swal.fire({
                title: 'Error',
                text: `Error: ${error.message}`,
                icon: 'error'
            });
        }
    }

    async uploadBackup() {
        const container = document.getElementById('backup-container-select').value;
        const siteName = document.getElementById('backup-site-name').value;
        const backupType = document.getElementById('upload-backup-type').value;
        const fileInput = document.getElementById('upload-backup-file');
        
        if (!container || !siteName) {
            await Swal.fire({
                title: 'Missing Information',
                text: 'Please select a container and site name first',
                icon: 'warning'
            });
            return;
        }

        if (!fileInput.files || fileInput.files.length === 0) {
            await Swal.fire({
                title: 'No File Selected',
                text: 'Please select a backup file to upload',
                icon: 'warning'
            });
            return;
        }

        const file = fileInput.files[0];
        
        // Validate file type
        const validExtensions = {
            'database': ['.sql', '.sql.gz'],
            'private_files': ['.tar', '.tar.gz'],
            'public_files': ['.tar', '.tar.gz']
        };

        const fileExt = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
        const isValidType = validExtensions[backupType].some(ext => file.name.endsWith(ext));

        if (!isValidType) {
            await Swal.fire({
                title: 'Invalid File Type',
                text: `Please select a valid ${backupType.replace('_', ' ')} file (${validExtensions[backupType].join(', ')})`,
                icon: 'error'
            });
            return;
        }

        const result = await Swal.fire({
            title: 'Upload Backup',
            html: `
                <p>Upload backup file:</p>
                <p><strong>${file.name}</strong></p>
                <p>Size: ${(file.size / (1024 * 1024)).toFixed(2)} MB</p>
                <p>Type: ${backupType.replace('_', ' ')}</p>
                <p>To: ${siteName}</p>
            `,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Upload',
            cancelButtonText: 'Cancel',
            confirmButtonColor: '#17a2b8'
        });

        if (!result.isConfirmed) return;

        try {
            this.addToLog('info', `Uploading ${file.name}...`);

            // Show progress bar
            const progressBar = document.getElementById('upload-progress');
            const progressBarInner = document.getElementById('upload-progress-bar');
            progressBar.style.display = 'block';
            progressBarInner.style.width = '0%';

            // Create FormData
            const formData = new FormData();
            formData.append('file', file);
            formData.append('container', container);
            formData.append('site_name', siteName);
            formData.append('backup_type', backupType);

            // Upload with progress
            const xhr = new XMLHttpRequest();

            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    progressBarInner.style.width = percentComplete + '%';
                    progressBarInner.textContent = Math.round(percentComplete) + '%';
                }
            });

            xhr.addEventListener('load', async () => {
                progressBar.style.display = 'none';
                
                if (xhr.status === 200) {
                    const data = JSON.parse(xhr.responseText);
                    
                    if (data.success) {
                        this.addToLog('success', `Backup uploaded successfully: ${file.name}`);
                        
                        await Swal.fire({
                            title: 'Success!',
                            text: `Backup file uploaded successfully to ${siteName}`,
                            icon: 'success'
                        });

                        // Clear file input
                        fileInput.value = '';
                        document.getElementById('upload-file-info').textContent = 'No file selected';
                        document.getElementById('upload-file-info').classList.remove('text-success');
                        document.getElementById('upload-file-info').classList.add('text-muted');

                        // Refresh backups list
                        this.loadBackupsList();
                    } else {
                        this.addToLog('error', `Upload failed: ${data.error}`);
                        await Swal.fire({
                            title: 'Error',
                            text: data.error || 'Upload failed',
                            icon: 'error'
                        });
                    }
                } else {
                    const errorText = xhr.responseText || 'Upload failed';
                    this.addToLog('error', `Upload failed: ${errorText}`);
                    await Swal.fire({
                        title: 'Error',
                        text: errorText,
                        icon: 'error'
                    });
                }
            });

            xhr.addEventListener('error', async () => {
                progressBar.style.display = 'none';
                this.addToLog('error', 'Network error during upload');
                await Swal.fire({
                    title: 'Error',
                    text: 'Network error occurred during upload',
                    icon: 'error'
                });
            });

            xhr.open('POST', '/api/frappe/backup/upload', true);
            xhr.send(formData);

        } catch (error) {
            this.addToLog('error', `Error uploading backup: ${error.message}`);
            await Swal.fire({
                title: 'Error',
                text: `Error: ${error.message}`,
                icon: 'error'
            });
        }
    }

    // Bench Logs Methods
    onLogsContainerChange(containerName) {
        this.logsContainer = containerName;
        if (containerName) {
            this.loadLogFiles();
        } else {
            this.clearLogFiles();
        }
    }

    async loadLogFiles() {
        if (!this.logsContainer) {
            this.addToLog('error', 'Please select a container first');
            return;
        }

        try {
            const response = await fetchWithLoader('/api/frappe/execute-command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({
                    container: this.logsContainer,
                    command: 'ls -1 ~/frappe-bench/logs/'
                })
            }, 'Loading log files...');

            const result = await response.json();

            if (result.output && !result.error) {
                this.populateLogFiles(result.output);
                this.addToLog('info', 'Log files loaded successfully');
            } else {
                this.addToLog('error', `Failed to load log files: ${result.error || 'Unknown error'}`);
                this.clearLogFiles();
            }
        } catch (error) {
            this.addToLog('error', `Error loading log files: ${error.message}`);
            this.clearLogFiles();
        }
    }

    populateLogFiles(logOutput) {
        const logSelect = document.getElementById('bench-log-file-select');
        if (!logSelect) return;

        logSelect.innerHTML = '<option value="">Select a log file...</option>';

        if (!logOutput || logOutput.trim() === '') return;

        const logFiles = logOutput.trim().split('\n').filter(file => file.trim() !== '');

        logFiles.forEach(file => {
            const fileName = file.trim();
            if (fileName) {
                const option = document.createElement('option');
                option.value = fileName;
                option.textContent = fileName;
                logSelect.appendChild(option);
            }
        });
    }

    clearLogFiles() {
        const logSelect = document.getElementById('bench-log-file-select');
        if (logSelect) {
            logSelect.innerHTML = '<option value="">Select a log file...</option>';
        }
    }

    async viewLog() {
        const container = this.logsContainer || document.getElementById('logs-container-select').value;
        const logFile = document.getElementById('bench-log-file-select').value;
        const linesLimit = document.getElementById('log-lines-limit').value;

        if (!container) {
            await Swal.fire({
                title: 'No Container Selected',
                text: 'Please select a container first',
                icon: 'warning'
            });
            return;
        }

        if (!logFile) {
            await Swal.fire({
                title: 'No Log File Selected',
                text: 'Please select a log file to view',
                icon: 'warning'
            });
            return;
        }

        try {
            // Build command based on line limit
            let command;
            let loadingMessage;
            
            if (linesLimit === 'all') {
                command = `cat ~/frappe-bench/logs/${logFile}`;
                loadingMessage = `Loading entire ${logFile}... (this may take time)`;
            } else {
                command = `tail -${linesLimit} ~/frappe-bench/logs/${logFile}`;
                loadingMessage = `Loading last ${linesLimit} lines of ${logFile}...`;
            }

            const response = await fetchWithLoader('/api/frappe/execute-command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({
                    container: container,
                    command: command
                })
            }, loadingMessage);

            const result = await response.json();

            if (result.output && !result.error) {
                const displayInfo = linesLimit === 'all' ? 'all lines' : `last ${linesLimit} lines`;
                this.displayLogContent(result.output, logFile, displayInfo);
                this.addToLog('success', `Loaded ${logFile} (${displayInfo})`);
            } else {
                this.addToLog('error', `Failed to load log: ${result.error || 'Unknown error'}`);
                await Swal.fire({
                    title: 'Error',
                    text: result.error || 'Failed to load log file',
                    icon: 'error'
                });
            }
        } catch (error) {
            this.addToLog('error', `Error loading log: ${error.message}`);
            await Swal.fire({
                title: 'Error',
                text: `Error: ${error.message}`,
                icon: 'error'
            });
        }
    }

    displayLogContent(content, logFile, displayInfo = '') {
        const logContent = document.getElementById('bench-log-content');
        const logInfo = document.getElementById('log-info');
        const logLinesCount = document.getElementById('log-lines-count');

        if (!logContent) return;

        // Format log content with line numbers and syntax highlighting
        const lines = content.split('\n');
        const formattedLines = lines.map((line, index) => {
            let lineClass = '';
            if (line.toLowerCase().includes('error') || line.toLowerCase().includes('exception')) {
                lineClass = 'style="color: #ff6b6b;"';
            } else if (line.toLowerCase().includes('warning') || line.toLowerCase().includes('warn')) {
                lineClass = 'style="color: #ffa500;"';
            } else if (line.toLowerCase().includes('info')) {
                lineClass = 'style="color: #4dabf7;"';
            } else if (line.toLowerCase().includes('success')) {
                lineClass = 'style="color: #51cf66;"';
            }
            
            return `<div ${lineClass}>${this.escapeHtml(line)}</div>`;
        }).join('');

        logContent.innerHTML = formattedLines || '<div class="text-muted text-center py-3">Log file is empty</div>';
        logContent.scrollTop = logContent.scrollHeight; // Scroll to bottom

        // Update info
        if (logInfo) {
            logInfo.textContent = `${logFile}${displayInfo ? ` (${displayInfo})` : ''}`;
        }
        if (logLinesCount) {
            logLinesCount.textContent = `${lines.length} lines`;
        }
    }

    escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }

    clearLogViewer() {
        const logContent = document.getElementById('bench-log-content');
        const logInfo = document.getElementById('log-info');
        const logLinesCount = document.getElementById('log-lines-count');

        if (logContent) {
            logContent.innerHTML = '<div class="text-muted text-center py-5"><i class="bi bi-info-circle"></i> Select a container, log file, and line limit, then click "View Log"</div>';
        }
        if (logInfo) {
            logInfo.textContent = 'No log loaded';
        }
        if (logLinesCount) {
            logLinesCount.textContent = '0 lines';
        }
    }

    async downloadLog() {
        const container = this.logsContainer || document.getElementById('logs-container-select').value;
        const logFile = document.getElementById('bench-log-file-select').value;

        if (!container || !logFile) {
            await Swal.fire({
                title: 'Missing Information',
                text: 'Please select a container and log file',
                icon: 'warning'
            });
            return;
        }

        try {
            this.addToLog('info', `Preparing ${logFile} for download...`);

            // Copy log file from container to host
            const logPath = `/home/frappe/frappe-bench/logs/${logFile}`;
            const tempPath = `/tmp/${logFile}`;
            
            const response = await fetchWithLoader('/api/frappe/backup/prepare-download', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({
                    container: container,
                    backup_path: logPath
                })
            }, `Preparing ${logFile} for download...`);

            const data = await response.json();

            if (data.success) {
                this.addToLog('success', `Download ready: ${logFile}`);

                // Trigger download
                const downloadLink = document.createElement('a');
                downloadLink.href = data.download_url;
                downloadLink.download = logFile;
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);

                await Swal.fire({
                    title: 'Download Started',
                    text: `Downloading ${logFile}...`,
                    icon: 'success',
                    timer: 2000
                });
            } else {
                this.addToLog('error', `Failed to prepare download: ${data.error}`);
                await Swal.fire({
                    title: 'Error',
                    text: data.error || 'Failed to prepare download',
                    icon: 'error'
                });
            }
        } catch (error) {
            this.addToLog('error', `Error downloading log: ${error.message}`);
            await Swal.fire({
                title: 'Error',
                text: `Error: ${error.message}`,
                icon: 'error'
            });
        }
    }

    // New Site Creation Methods
    versionsLoaded = false;

    async loadERPNextVersions() {
        const versionSelect = document.getElementById('erpnext-version');
        if (!versionSelect) return;

        try {
            versionSelect.innerHTML = '<option value="">Loading versions...</option>';
            versionSelect.disabled = true;

            const response = await fetchWithLoader('/api/frappe/get-erpnext-versions', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            }, 'Fetching ERPNext versions...');

            const data = await response.json();

            if (data.success && data.versions && data.versions.length > 0) {
                versionSelect.innerHTML = '<option value="">-- Select ERPNext Version --</option>';
                
                data.versions.forEach((version, index) => {
                    const option = document.createElement('option');
                    option.value = version;
                    option.textContent = version;
                    
                    if (index === 0) {
                        option.textContent += ' (Latest - Recommended)';
                        option.selected = true;  // Auto-select latest version
                    }
                    
                    versionSelect.appendChild(option);
                });
                
                // Also set the select value to ensure it's selected
                if (data.versions.length > 0) {
                    versionSelect.value = data.versions[0];
                }

                this.versionsLoaded = true;
                this.addToLog('success', `Loaded ${data.versions.length} ERPNext versions (latest auto-selected)`);
            } else {
                // Fallback to hardcoded versions
                this.loadFallbackVersions(versionSelect);
            }
        } catch (error) {
            this.addToLog('error', `Error loading versions: ${error.message}`);
            this.loadFallbackVersions(versionSelect);
        } finally {
            versionSelect.disabled = false;
        }
    }

    loadFallbackVersions(versionSelect) {
        const fallbackVersions = [
            'v15.80.1', 'v15.80.0', 'v15.79.2', 'v15.79.1', 'v15.79.0',
            'v15.78.1', 'v15.78.0', 'v15.77.0', 'v15.76.0', 'v15.75.1',
            'v14.73.0', 'v14.72.0', 'v14.71.0', 'v13.54.0'
        ];

        versionSelect.innerHTML = '<option value="">-- Select ERPNext Version --</option>';
        fallbackVersions.forEach((version, index) => {
            const option = document.createElement('option');
            option.value = version;
            option.textContent = version;
            
            if (index === 0) {
                option.textContent += ' (Latest - Recommended)';
                option.selected = true;  // Auto-select latest version
            }
            
            versionSelect.appendChild(option);
        });
        
        // Also set the select value to ensure it's selected
        if (fallbackVersions.length > 0) {
            versionSelect.value = fallbackVersions[0];
        }

        this.versionsLoaded = true;
        this.addToLog('warning', 'Using fallback version list (latest auto-selected)');
    }

    resetSiteForm() {
        const form = document.getElementById('new-site-form');
        if (form) {
            form.reset();
            
            // Hide progress section
            const progressSection = document.getElementById('site-creation-progress');
            if (progressSection) {
                progressSection.style.display = 'none';
            }
        }
        this.addToLog('info', 'Site creation form reset');
    }

    async handleNewSiteCreation(event) {
        event.preventDefault();

        const domainName = document.getElementById('domain-name').value.trim();
        const erpnextVersion = document.getElementById('erpnext-version').value;
        const environment = document.querySelector('input[name="environment"]:checked').value;

        // Validate domain name
        if (!domainName) {
            await Swal.fire({
                title: 'Domain Required',
                text: 'Please enter a domain name',
                icon: 'warning'
            });
            return;
        }

        if (!erpnextVersion) {
            await Swal.fire({
                title: 'Version Required',
                text: 'Please select an ERPNext version',
                icon: 'warning'
            });
            return;
        }

        // Extract site name from domain (first part before dot)
        const siteName = domainName.split('.')[0];

        // Prepare parameters - script handles all other configuration
        const params = {
            domain_name: domainName,
            erpnext_version: erpnextVersion,
            environment: environment
        };

        // Confirmation dialog
        const result = await Swal.fire({
            title: 'Create New Site?',
            html: `
                <div class="text-start">
                    <p><strong>Domain:</strong> ${domainName}</p>
                    <p><strong>Site Name:</strong> ${siteName} <small class="text-muted">(auto-extracted)</small></p>
                    <p><strong>Environment:</strong> ${environment === 'local' ? 'Docker-Local (Development)' : 'Docker-on-VPS (Production)'}</p>
                    <p><strong>ERPNext Version:</strong> ${erpnextVersion}</p>
                    <hr>
                    <div class="alert alert-info mb-0">
                        <i class="bi bi-info-circle"></i> 
                        The generation script will automatically:<br>
                         Generate secure passwords<br>
                         Assign available ports<br>
                         Configure Traefik routing<br>
                         Create and start containers
                    </div>
                    <hr>
                    <p class="text-warning mb-0">
                        <i class="bi bi-exclamation-triangle"></i> 
                        This process may take 5 minutes. Please do not close this page.
                    </p>
                </div>
            `,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Yes, Create Site',
            cancelButtonText: 'Cancel',
            confirmButtonColor: '#007bff'
        });

        if (!result.isConfirmed) return;

        // Show progress section
        const progressSection = document.getElementById('site-creation-progress');
        const progressBar = document.getElementById('creation-progress-bar');
        const statusText = document.getElementById('creation-status-text');
        const creationLog = document.getElementById('site-creation-log');
        
        if (progressSection) {
            progressSection.style.display = 'block';
            progressBar.style.width = '10%';
            progressBar.setAttribute('aria-valuenow', 10);
            progressBar.textContent = '10%';
            progressBar.classList.add('bg-info');
            statusText.textContent = 'Starting site creation...';
            creationLog.innerHTML = '<div class="text-info"><i class="bi bi-hourglass-split"></i> Initializing site creation process...</div>';
        }

        try {
            this.addToLog('info', `Starting site creation: ${siteName} (${environment})`);

            // Start the site creation task
            const response = await fetch('/api/frappe/create-site', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify(params)
            });

            const data = await response.json();

            if (data.success && data.task_id) {
                // Task started successfully, now poll for status
                const taskId = data.task_id;
                this.addToLog('info', `Task ID: ${taskId}`);
                
                // Poll for status every 2 seconds
                const pollInterval = setInterval(async () => {
                    try {
                        const statusResponse = await fetch(`/api/frappe/create-site/status/${taskId}`, {
                            headers: {
                                'X-CSRFToken': this.getCSRFToken()
                            }
                        });
                        
                        const statusData = await statusResponse.json();
                        
                        if (statusData.success && statusData.task) {
                            const task = statusData.task;
                            
                            // Update progress bar with validation
                            const progress = Math.min(100, Math.max(0, parseInt(task.progress) || 0));
                            progressBar.style.width = `${progress}%`;
                            progressBar.setAttribute('aria-valuenow', progress);
                            progressBar.textContent = `${progress}%`;
                            
                            // Update progress bar color based on completion
                            if (progress < 33) {
                                progressBar.classList.remove('bg-warning', 'bg-success');
                                progressBar.classList.add('bg-info');
                            } else if (progress < 75) {
                                progressBar.classList.remove('bg-info', 'bg-success');
                                progressBar.classList.add('bg-warning');
                            } else {
                                progressBar.classList.remove('bg-info', 'bg-warning');
                                progressBar.classList.add('bg-success');
                            }
                            
                            // Update status text
                            statusText.textContent = task.message || 'Processing...';
                            
                            // Update log with real-time output
                            if (creationLog) {
                                if (task.output && task.output.trim()) {
                                    // Format output with ANSI color codes removed and proper line breaks
                                    const formattedOutput = task.output
                                        // Remove all ANSI escape sequences (multiple patterns)
                                        .replace(/\\u001b\[[0-9;]*m/g, '') // Unicode escaped ANSI
                                        .replace(/\x1b\[[0-9;]*m/g, '') // Standard ANSI codes
                                        .replace(/\[[0-9;]*m/g, '') // Bracket-only codes
                                        .replace(/\[0m/g, '') // Reset codes
                                        .replace(/\[0;[0-9]+m/g, '') // Color codes
                                        .replace(/\\033\[[0-9;]*m/g, '') // Octal ANSI codes
                                        .replace(/\x1b\[([0-9]{1,2}(;[0-9]{1,2})?)?[mGK]/g, '') // Extended ANSI
                                        .replace(/\[([0-9]{1,2}(;[0-9]{1,2})?)m/g, '') // Generic color
                                        .replace(/\[\d+[ABCD]/g, '') // Cursor movement codes
                                        .replace(/\[2K/g, '') // Clear line codes
                                        .replace(/\[1A/g, '') // Move cursor up
                                        .replace(/\[2A/g, '') // Move cursor up 2
                                        .replace(/\[1B/g, '') // Move cursor down
                                        .replace(/\[2B/g, '') // Move cursor down 2
                                        .replace(/\\r\\n/g, '\n') // Escaped line endings
                                        .replace(/\r\n/g, '\n') // Normalize line endings
                                        .replace(/\\n/g, '\n') // Escaped newlines
                                        .replace(/\r/g, '') // Remove carriage returns
                                        .split('\n')
                                        .filter(line => line.trim()) // Remove empty lines
                                        .map(line => {
                                            // First handle Unicode escape sequences for emoji
                                            let processedLine = line
                                                .replace(/\\ud83d\\udca1/g, '')
                                                .replace(/\\ud83d\\udce6/g, '')
                                                .replace(/\\u2705/g, '')
                                                .replace(/\\u274c/g, '')
                                                .replace(/\\u26a0/g, '')
                                                .replace(/\\ud83d\\udd0d/g, '')
                                                .replace(/\\ud83d\\ude80/g, '')
                                                .replace(/\\ud83d\\udc33/g, '')
                                                .replace(/\\ud83d\\udd27/g, '')
                                                .replace(/\\ud83c\\udf10/g, '')
                                                .replace(/\\ud83d\\udccb/g, '')
                                                .replace(/\\ud83d\\udcdd/g, '')
                                                .replace(/\\ud83d\\udcc1/g, '')
                                                .replace(/\\ud83d\\udc64/g, '')
                                                .replace(/\\ud83d\\udd11/g, '')
                                                .replace(/\\ud83d\\udd10/g, '')
                                                .replace(/\\u23f3/g, '')
                                                .replace(/\\ud83c\\udf89/g, '')
                                                .replace(/\\ud83d\\udcbe/g, '')
                                                .replace(/\\ud83d\\udcc2/g, '')
                                                .replace(/\\u2b50/g, '')
                                                .replace(/\\ud83c\\udfaf/g, '')
                                                .replace(/\\ud83d\\udd25/g, '')
                                                .replace(/\\u2022/g, ''); // Bullet point
                                            
                                            // Escape HTML
                                            let formattedLine = this.escapeHtml(processedLine);
                                            
                                            // Replace emoji with Bootstrap icons
                                            formattedLine = formattedLine
                                                .replace(//g, '<i class="bi bi-box-seam text-primary"></i>')
                                                .replace(//g, '<i class="bi bi-check-circle-fill text-success"></i>')
                                                .replace(//g, '<i class="bi bi-x-circle-fill text-danger"></i>')
                                                .replace(/|/g, '<i class="bi bi-exclamation-triangle-fill text-warning"></i>')
                                                .replace(//g, '<i class="bi bi-search text-info"></i>')
                                                .replace(//g, '<i class="bi bi-rocket-takeoff text-success"></i>')
                                                .replace(//g, '<i class="bi bi-code-square text-info"></i>')
                                                .replace(//g, '<i class="bi bi-tools text-secondary"></i>')
                                                .replace(//g, '<i class="bi bi-lightbulb-fill text-warning"></i>')
                                                .replace(//g, '<i class="bi bi-globe text-primary"></i>')
                                                .replace(//g, '<i class="bi bi-bar-chart-fill text-info"></i>')
                                                .replace(//g, '<i class="bi bi-clipboard-fill text-info"></i>')
                                                .replace(//g, '<i class="bi bi-pencil-square text-primary"></i>')
                                                .replace(//g, '<i class="bi bi-folder-fill text-warning"></i>')
                                                .replace(//g, '<i class="bi bi-trophy-fill text-warning"></i>')
                                                .replace(//g, '<i class="bi bi-hourglass-split text-muted"></i>')
                                                .replace(//g, '<i class="bi bi-person-circle text-primary"></i>')
                                                .replace(//g, '<i class="bi bi-key-fill text-warning"></i>')
                                                .replace(//g, '<i class="bi bi-shield-lock-fill text-success"></i>')
                                                .replace(//g, '<i class="bi bi-database-fill text-info"></i>')
                                                .replace(/|/g, '<i class="bi bi-folder2-open text-warning"></i>')
                                                .replace(//g, '<i class="bi bi-bullseye text-danger"></i>')
                                                .replace(//g, '<i class="bi bi-star-fill text-warning"></i>')
                                                .replace(//g, '<i class="bi bi-brightness-high-fill text-danger"></i>');
                                            
                                            return formattedLine;
                                        })
                                        .join('<br>');
                                    
                                    creationLog.innerHTML = `
                                        <div class="text-info mb-2">
                                            <i class="bi bi-activity"></i> <strong>Status:</strong> ${this.escapeHtml(task.message)}
                                        </div>
                                        <div class="text-muted" style="font-family: monospace; font-size: 0.85rem; white-space: pre-wrap;">
                                            ${formattedOutput}
                                        </div>
                                    `;
                                    
                                    // Auto-scroll to bottom
                                    creationLog.scrollTop = creationLog.scrollHeight;
                                } else {
                                    creationLog.innerHTML = `<div class="text-info"><i class="bi bi-info-circle"></i> ${this.escapeHtml(task.message)}</div>`;
                                }
                            }
                            
                            // Check if completed
                            if (task.status === 'completed' && task.result) {
                                clearInterval(pollInterval);
                                
                                progressBar.classList.remove('progress-bar-animated');
                                progressBar.classList.add('bg-success');
                                
                                // Show final output with success styling
                                if (creationLog && task.result.output) {
                                    const formattedOutput = task.result.output
                                        // Remove all ANSI escape sequences (multiple patterns)
                                        .replace(/\\u001b\[[0-9;]*m/g, '')
                                        .replace(/\x1b\[[0-9;]*m/g, '')
                                        .replace(/\[[0-9;]*m/g, '')
                                        .replace(/\[0m/g, '')
                                        .replace(/\[0;[0-9]+m/g, '')
                                        .replace(/\\033\[[0-9;]*m/g, '')
                                        .replace(/\x1b\[([0-9]{1,2}(;[0-9]{1,2})?)?[mGK]/g, '')
                                        .replace(/\[([0-9]{1,2}(;[0-9]{1,2})?)m/g, '')
                                        .replace(/\[\d+[ABCD]/g, '')
                                        .replace(/\[2K/g, '')
                                        .replace(/\[1A/g, '')
                                        .replace(/\[2A/g, '')
                                        .replace(/\[1B/g, '')
                                        .replace(/\[2B/g, '')
                                        .replace(/\\r\\n/g, '\n')
                                        .replace(/\r\n/g, '\n')
                                        .replace(/\\n/g, '\n')
                                        .replace(/\r/g, '')
                                        .split('\n')
                                        .filter(line => line.trim())
                                        .map(line => {
                                            // First handle Unicode escape sequences for emoji
                                            let processedLine = line
                                                .replace(/\\ud83d\\udca1/g, '')
                                                .replace(/\\ud83d\\udce6/g, '')
                                                .replace(/\\u2705/g, '')
                                                .replace(/\\u274c/g, '')
                                                .replace(/\\u26a0/g, '')
                                                .replace(/\\ud83d\\udd0d/g, '')
                                                .replace(/\\ud83d\\ude80/g, '')
                                                .replace(/\\ud83d\\udc33/g, '')
                                                .replace(/\\ud83d\\udd27/g, '')
                                                .replace(/\\ud83c\\udf10/g, '')
                                                .replace(/\\ud83d\\udccb/g, '')
                                                .replace(/\\ud83d\\udcdd/g, '')
                                                .replace(/\\ud83d\\udcc1/g, '')
                                                .replace(/\\ud83d\\udc64/g, '')
                                                .replace(/\\ud83d\\udd11/g, '')
                                                .replace(/\\ud83d\\udd10/g, '')
                                                .replace(/\\u23f3/g, '')
                                                .replace(/\\ud83c\\udf89/g, '')
                                                .replace(/\\ud83d\\udcbe/g, '')
                                                .replace(/\\ud83d\\udcc2/g, '')
                                                .replace(/\\u2b50/g, '')
                                                .replace(/\\ud83c\\udfaf/g, '')
                                                .replace(/\\ud83d\\udd25/g, '')
                                                .replace(/\\u2022/g, '');
                                            
                                            let formattedLine = this.escapeHtml(processedLine);
                                            // Convert emoji to Bootstrap icons
                                            return formattedLine
                                                .replace(//g, '<i class="bi bi-box-seam text-primary"></i>')
                                                .replace(//g, '<i class="bi bi-check-circle-fill text-success"></i>')
                                                .replace(//g, '<i class="bi bi-x-circle-fill text-danger"></i>')
                                                .replace(/|/g, '<i class="bi bi-exclamation-triangle-fill text-warning"></i>')
                                                .replace(//g, '<i class="bi bi-search text-info"></i>')
                                                .replace(//g, '<i class="bi bi-rocket-takeoff-fill text-success"></i>')
                                                .replace(//g, '<i class="bi bi-badge-docker text-info"></i>')
                                                .replace(//g, '<i class="bi bi-tools text-secondary"></i>')
                                                .replace(//g, '<i class="bi bi-lightbulb-fill text-warning"></i>')
                                                .replace(//g, '<i class="bi bi-globe text-primary"></i>')
                                                .replace(//g, '<i class="bi bi-bar-chart-fill text-info"></i>')
                                                .replace(//g, '<i class="bi bi-clipboard-fill text-info"></i>')
                                                .replace(//g, '<i class="bi bi-pencil-square text-primary"></i>')
                                                .replace(//g, '<i class="bi bi-folder-fill text-warning"></i>')
                                                .replace(//g, '<i class="bi bi-trophy-fill text-warning"></i>')
                                                .replace(//g, '<i class="bi bi-hourglass-split text-muted"></i>')
                                                .replace(//g, '<i class="bi bi-person-circle text-primary"></i>')
                                                .replace(//g, '<i class="bi bi-key-fill text-warning"></i>')
                                                .replace(//g, '<i class="bi bi-shield-lock-fill text-success"></i>')
                                                .replace(//g, '<i class="bi bi-save-fill text-info"></i>')
                                                .replace(/|/g, '<i class="bi bi-folder-fill text-warning"></i>')
                                                .replace(//g, '<i class="bi bi-bullseye text-danger"></i>')
                                                .replace(//g, '<i class="bi bi-star-fill text-warning"></i>')
                                                .replace(//g, '<i class="bi bi-fire text-danger"></i>');
                                        })
                                        .join('<br>');
                                    
                                    creationLog.innerHTML = `
                                        <div class="alert alert-success mb-2">
                                            <i class="bi bi-check-circle-fill"></i> <strong>Site Created Successfully!</strong>
                                        </div>
                                        <div class="text-muted" style="font-family: monospace; font-size: 0.85rem; white-space: pre-wrap; max-height: 400px; overflow-y: auto;">
                                            ${formattedOutput}
                                        </div>
                                    `;
                                }
                                
                                this.addToLog('success', `Site ${task.result.site_name} created successfully`);
                                
                                // Format credentials with icons
                                let formattedCredentials = '';
                                let rawCredentials = '';
                                if (task.result.credentials) {
                                    rawCredentials = task.result.credentials;
                                    formattedCredentials = task.result.credentials
                                        .split('\n')
                                        .map(line => {
                                            let formattedLine = this.escapeHtml(line);
                                            return formattedLine
                                                .replace(//g, '<i class="bi bi-person-circle text-primary"></i>')
                                                .replace(//g, '<i class="bi bi-key-fill text-warning"></i>')
                                                .replace(//g, '<i class="bi bi-database-fill text-info"></i>');
                                        })
                                        .join('<br>');
                                }
                                
                                await Swal.fire({
                                    title: 'Success!',
                                    html: `
                                        <div class="text-center mb-3">
                                            <h5>Site <strong class="text-primary">${task.result.domain_name}</strong> created successfully!</h5>
                                        </div>
                                        ${task.result.access_url ? `
                                            <div class="alert alert-success text-start">
                                                <i class="bi bi-globe"></i> <strong>Access URL:</strong><br>
                                                <a href="${task.result.access_url}" target="_blank" class="text-decoration-none">
                                                    <i class="bi bi-box-arrow-up-right"></i> ${task.result.access_url}
                                                </a>
                                            </div>
                                        ` : ''}
                                        ${formattedCredentials ? `
                                            <div class="alert alert-info text-start position-relative">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <h6 class="mb-0"><i class="bi bi-shield-lock"></i> Credentials:</h6>
                                                    <button class="btn btn-sm btn-outline-primary copy-credentials-btn" 
                                                            onclick="window.copyCredentialsToClipboard()"
                                                            title="Copy credentials to clipboard">
                                                        <i class="bi bi-clipboard"></i> Copy
                                                    </button>
                                                </div>
                                                <div id="credentials-text" style="font-family: monospace; line-height: 1.8;" data-raw-credentials="${this.escapeHtml(rawCredentials)}">
                                                    ${formattedCredentials}
                                                </div>
                                            </div>
                                        ` : ''}
                                    `,
                                    icon: 'success',
                                    width: '600px',
                                    didOpen: () => {
                                        // Setup copy functionality
                                        window.copyCredentialsToClipboard = () => {
                                            const credentialsDiv = document.getElementById('credentials-text');
                                            const rawText = credentialsDiv.getAttribute('data-raw-credentials');
                                            
                                            // Copy to clipboard
                                            navigator.clipboard.writeText(rawText).then(() => {
                                                // Visual feedback
                                                const copyBtn = document.querySelector('.copy-credentials-btn');
                                                const originalHTML = copyBtn.innerHTML;
                                                copyBtn.innerHTML = '<i class="bi bi-check-circle-fill text-success"></i> Copied!';
                                                copyBtn.classList.remove('btn-outline-primary');
                                                copyBtn.classList.add('btn-success');
                                                
                                                
                                            }).catch(err => {
                                                console.error('Failed to copy:', err);
                                            });
                                        };
                                    }
                                });
                                
                                // Reset form
                                this.resetSiteForm();
                                
                                // Refresh containers
                                setTimeout(() => this.refreshContainers(), 2000);
                                
                            } else if (task.status === 'failed') {
                                clearInterval(pollInterval);
                                
                                progressBar.classList.remove('progress-bar-animated');
                                progressBar.classList.add('bg-danger');
                                
                                const errorMsg = task.result?.error || task.message;
                                
                                // Show error with output
                                if (creationLog) {
                                    let logContent = `
                                        <div class="alert alert-danger mb-2">
                                            <i class="bi bi-x-circle-fill"></i> <strong>Site Creation Failed</strong><br>
                                            <small>${this.escapeHtml(errorMsg)}</small>
                                        </div>
                                    `;
                                    
                                    // Add output if available
                                    if (task.output && task.output.trim()) {
                                        const formattedOutput = task.output
                                            // Remove all ANSI escape sequences
                                            .replace(/\x1b\[[0-9;]*m/g, '')
                                            .replace(/\[[0-9;]*m/g, '')
                                            .replace(/\[0m/g, '')
                                            .replace(/\[0;[0-9]+m/g, '')
                                            .replace(/\x1b\[([0-9]{1,2}(;[0-9]{1,2})?)?[mGK]/g, '')
                                            .replace(/\[\d+[ABCD]/g, '')
                                            .replace(/\[2K/g, '')
                                            .replace(/\[1A/g, '')
                                            .replace(/\r\n/g, '\n')
                                            .replace(/\r/g, '')
                                            .split('\n')
                                            .filter(line => line.trim())
                                            .map(line => {
                                                let formattedLine = this.escapeHtml(line);
                                                // Convert emoji to Bootstrap icons
                                                return formattedLine
                                                    .replace(//g, '<i class="bi bi-box-seam text-primary"></i>')
                                                    .replace(//g, '<i class="bi bi-check-circle-fill text-success"></i>')
                                                    .replace(//g, '<i class="bi bi-x-circle-fill text-danger"></i>')
                                                    .replace(/|/g, '<i class="bi bi-exclamation-triangle-fill text-warning"></i>')
                                                    .replace(//g, '<i class="bi bi-search text-info"></i>')
                                                    .replace(//g, '<i class="bi bi-rocket-takeoff text-success"></i>')
                                                    .replace(//g, '<i class="bi bi-code-square text-info"></i>')
                                                    .replace(//g, '<i class="bi bi-tools text-secondary"></i>')
                                                    .replace(//g, '<i class="bi bi-lightbulb-fill text-warning"></i>')
                                                    .replace(//g, '<i class="bi bi-globe text-primary"></i>')
                                                    .replace(//g, '<i class="bi bi-bar-chart-fill text-info"></i>')
                                                    .replace(//g, '<i class="bi bi-trophy-fill text-warning"></i>')
                                                    .replace(//g, '<i class="bi bi-hourglass-split text-muted"></i>')
                                                    .replace(//g, '<i class="bi bi-person-circle text-primary"></i>')
                                                    .replace(//g, '<i class="bi bi-key-fill text-warning"></i>')
                                                    .replace(//g, '<i class="bi bi-shield-lock-fill text-success"></i>')
                                                    .replace(//g, '<i class="bi bi-database-fill text-info"></i>')
                                                    .replace(/|/g, '<i class="bi bi-folder2-open text-warning"></i>')
                                                    .replace(//g, '<i class="bi bi-bullseye text-danger"></i>')
                                                    .replace(//g, '<i class="bi bi-star-fill text-warning"></i>')
                                                    .replace(//g, '<i class="bi bi-brightness-high-fill text-danger"></i>')
                                                    .replace(//g, '<i class="bi bi-clipboard-fill text-info"></i>')
                                                    .replace(//g, '<i class="bi bi-pencil-square text-primary"></i>')
                                                    .replace(//g, '<i class="bi bi-folder-fill text-warning"></i>');
                                            })
                                            .join('<br>');
                                        
                                        logContent += `
                                            <div class="text-muted" style="font-family: monospace; font-size: 0.85rem; white-space: pre-wrap; max-height: 400px; overflow-y: auto;">
                                                ${formattedOutput}
                                            </div>
                                        `;
                                    }
                                    
                                    creationLog.innerHTML = logContent;
                                }
                                
                                this.addToLog('error', `Failed: ${errorMsg}`);
                                
                                await Swal.fire({
                                    title: 'Error',
                                    text: errorMsg,
                                    icon: 'error'
                                });
                            }
                        }
                    } catch (pollError) {
                        console.error('Polling error:', pollError);
                    }
                }, 2000); // Poll every 2 seconds
                
            } else {
                // Failed to start task
                progressBar.classList.remove('progress-bar-animated');
                progressBar.classList.add('bg-danger');
                statusText.textContent = 'Failed to start site creation';
                
                this.addToLog('error', `Failed to start: ${data.error}`);
                
                await Swal.fire({
                    title: 'Error',
                    text: data.error || 'Failed to start site creation',
                    icon: 'error'
                });
            }
        } catch (error) {
            progressBar.classList.remove('progress-bar-animated');
            progressBar.classList.add('bg-danger');
            statusText.textContent = 'Error occurred';
            
            if (creationLog) {
                creationLog.innerHTML = `<div class="text-danger">Error: ${this.escapeHtml(error.message)}</div>`;
            }

            this.addToLog('error', `Error: ${error.message}`);
            
            await Swal.fire({
                title: 'Error',
                text: `Error: ${error.message}`,
                icon: 'error'
            });
        }
    }
}

// Global variables for terminal logs
let lastErrorCount = 0;
let logsRefreshInterval = null;

// Initialize the app manager when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    if (typeof window === 'undefined' || typeof document === 'undefined') {
        console.error('Not in a browser environment');
        return;
    }
    
    
    // Wait a bit to ensure all DOM elements are ready
    setTimeout(() => {
        try {
            window.frappeAppManager = new FrappeAppManager();
        } catch (error) {
            console.error('Error initializing FrappeAppManager:', error);
        }
    }, 100);
});

// Terminal logs functions (keeping existing functionality)
function loadTerminalLogs() {
    fetchWithLoader('/api/frappe/terminal-logs', {}, 'Loading terminal logs...')
        .then(response => response.json())
        .then(data => {
            const logs = data.logs || [];
            updateTerminalLogsTable(logs);
            updateLogsCount(logs.length);
            checkForNewErrors(logs.length);
        })
        .catch(error => {
            console.error('Error loading terminal logs:', error);
            showToast('Failed to load terminal logs', 'error');
        });
}

function updateTerminalLogsTable(logs) {
    const tbody = document.getElementById("terminal-logs-tbody");
    
    if (logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">No logs available</td></tr>';
        return;
    }
    
    tbody.innerHTML = logs.map((log, index) => `
        <tr>
            <td>${index + 1}</td>
            <td>${log.timestamp || ""}</td>
            <td>${log.container || ""}</td>
            <td><code>${log.command || ""}</code></td>
            <td>${log.full_error || ""}</td>
            <td>${log.exit_code}</td>
            <td>${log.username || ""}</td>
        </tr>
        <tr>
            <td colspan="7" style="white-space:pre-wrap; font-family:monospace; background:#f8f9fa; padding:5px;">
                ${log.full_error || log.error || ""}
            </td>
        </tr>
    `).join("");
}

function updateLogsCount(count) {
    const countElement = document.getElementById('logs-count');
    if (countElement) {
        countElement.textContent = count;
    }
}

async function clearTerminalLogs() {
    const result = await Swal.fire({
        title: 'Clear Terminal Logs',
        text: 'Are you sure you want to clear all terminal error logs?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Yes, clear them!',
        cancelButtonText: 'Cancel'
    });
    
    if (result.isConfirmed) {
        fetchWithLoader('/api/frappe/clear-terminal-logs', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        }, 'Clearing terminal logs...')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Terminal logs cleared successfully', 'success');
                loadTerminalLogs();
            } else {
                showToast('Failed to clear terminal logs', 'error');
            }
        })
        .catch(error => {
            console.error('Error clearing terminal logs:', error);
            showToast('Failed to clear terminal logs', 'error');
        });
    }
}

function startPeriodicRefresh() {
    logsRefreshInterval = setInterval(() => {
        loadTerminalLogs();
    }, 50000);
}

function stopPeriodicRefresh() {
    if (logsRefreshInterval) {
        clearInterval(logsRefreshInterval);
        logsRefreshInterval = null;
    }
}

function setupRealTimeErrorTracking() {
    
    const originalFetch = window.fetch;
    window.fetch = function(...args) {
        return originalFetch.apply(this, args).then(response => {
            if (args[0] && args[0].includes('/api/frappe/execute-command')) {
                return response.clone().json().then(data => {
                    
                    if (data && (data.success === false || data.error || data.exit_code > 0)) {
                        loadTerminalLogs();
                    }
                    return response;
                }).catch(() => response);
            }
            return response;
        });
    };
}

function checkForNewErrors(currentCount) {
    
    if (currentCount > lastErrorCount && lastErrorCount > 0) {
        const newErrors = currentCount - lastErrorCount;
        showErrorNotification(newErrors);
        
        const terminalLogsTab = document.getElementById('terminal-logs-tab');
        const terminalConsoleTab = document.getElementById('terminal-console-tab');
        
        if (terminalConsoleTab && terminalConsoleTab.classList.contains('active')) {
            showToast(' ' + newErrors + ' new error(s) detected! Click Terminal Logs tab to view.', 'warning');
        }
    }
    lastErrorCount = currentCount;
}

function showErrorNotification(errorCount) {
    
    const terminalLogsTab = document.getElementById('terminal-logs-tab');
    if (terminalLogsTab) {
        const existingBadge = terminalLogsTab.querySelector('.badge');
        if (existingBadge) {
            existingBadge.remove();
        }
        
        const badge = document.createElement('span');
        badge.className = 'badge bg-danger ms-2';
        badge.textContent = errorCount;
        badge.style.fontSize = '0.7em';
        terminalLogsTab.appendChild(badge);
        
        terminalLogsTab.addEventListener('click', function() {
            setTimeout(() => {
                if (badge.parentNode) {
                    badge.remove();
                }
            }, 100);
        });
    }
}

function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toastContainer') || createToastContainer();
    
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'primary'} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toastContainer';
    container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
    container.style.zIndex = '11';
    document.body.appendChild(container);
    return container;
}

// ==================== DANGER ZONE OPERATIONS ====================
{% raw %}
// 1. Rebuild with Custom Apps Preservation
document.getElementById('rebuild-with-apps-btn')?.addEventListener('click', async function() {
    const siteName = document.getElementById('danger-site-select').value;
    
    if (!siteName) {
        showToast('Please select a site first', 'error');
        return;
    }
    
    const result = await Swal.fire({
        title: 'Rebuild with Apps Preservation?',
        html: `
            <div class="text-start">
                <p>This will rebuild <strong>${siteName}</strong> while preserving custom apps:</p>
                <div class="alert alert-info">
                    <h6>Process Steps:</h6>
                    <ol>
                        <li>Backup all custom apps (except frappe & erpnext)</li>
                        <li>Stop all containers</li>
                        <li>Rebuild containers</li>
                        <li>Wait for containers to be ready</li>
                        <li>Reinstall all custom apps</li>
                        <li>Update apps.txt</li>
                    </ol>
                </div>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> <strong>Note:</strong> This process may take 5-15 minutes depending on the number of apps.
                </div>
            </div>
        `,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ffc107',
        confirmButtonText: 'Yes, Rebuild with Apps',
        cancelButtonText: 'Cancel'
    });
    
    if (result.isConfirmed) {
        // Use threading + polling (like site creation)
        const outputElement = document.getElementById('danger-zone-output');
        outputElement.innerHTML = '<div class="text-info"><i class="bi bi-arrow-repeat spin"></i> Starting rebuild process...</div>';
        LoaderManager.show('Rebuilding containers...');
        
        // Start rebuild task
        fetch('/api/frappe/rebuild-with-apps', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({ site_name: siteName })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.task_id) {
                // Start polling for status
                pollDangerZoneStatus(data.task_id, 'rebuild', outputElement);
            } else {
                LoaderManager.hide();
                outputElement.innerHTML = `<div class="text-danger"> Error: ${data.error || 'Failed to start rebuild'}</div>`;
                showToast('Failed to start rebuild', 'error');
            }
        })
        .catch(error => {
            LoaderManager.hide();
            outputElement.innerHTML = `<div class="text-danger"> Error: ${error.message}</div>`;
            showToast('Failed to start rebuild', 'error');
        });
    }
});

function getCSRFToken() {
    const csrfInput = document.querySelector('input[name="csrf_token"]');
    return csrfInput ? csrfInput.value : '';
}

// Universal Danger Zone polling function
function pollDangerZoneStatus(taskId, operationType, outputElement, siteName = null) {
    const endpoints = {
        'rebuild': '/api/frappe/rebuild-with-apps/status/',
        'restart-policy': '/api/frappe/fix-restart-policies/status/',
        'site-removal': '/api/frappe/remove-site/status/'
    };
    
    const endpoint = endpoints[operationType] + taskId;
    
    const pollInterval = setInterval(() => {
        fetch(endpoint)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.task) {
                    const task = data.task;
                    
                    // Update output
                    if ('output' in task) {
                        const safeOutput = (task.output || 'Starting...').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        outputElement.innerHTML = '<pre style="white-space: pre-wrap; word-wrap: break-word;">' + 
                            safeOutput + 
                            '</pre>';
                        outputElement.scrollTop = outputElement.scrollHeight;
                    }
                    
                    // Check if completed
                    if (task.status === 'completed') {
                        clearInterval(pollInterval);
                        LoaderManager.hide();
                        
                        if (operationType === 'rebuild') {
                            showToast('Rebuild completed successfully!', 'success');
                            Swal.fire({
                                title: 'Success!',
                                text: `Rebuild completed successfully for ${task.site_name}`,
                                icon: 'success',
                                confirmButtonText: 'OK'
                            }).then(() => {
                                location.reload();
                            });
                        } else if (operationType === 'restart-policy') {
                            showToast('Restart policies fixed successfully!', 'success');
                            Swal.fire({
                                title: 'Success!',
                                text: 'All restart policies have been fixed',
                                icon: 'success',
                                confirmButtonText: 'OK'
                            });
                        } else if (operationType === 'site-removal') {
                            showToast('Site removed successfully!', 'success');
                            Swal.fire({
                                title: 'Site Removed',
                                html: `
                                    <div class="alert alert-success">
                                        <h5><i class="bi bi-check-circle-fill"></i> Complete Removal Successful</h5>
                                        <p>Site <strong>${siteName}</strong> has been completely removed from the system.</p>
                                    </div>
                                    <p>All containers, folders, and configuration have been deleted.</p>
                                `,
                                icon: 'success',
                                confirmButtonColor: '#28a745'
                            }).then(() => {
                                location.reload();
                            });
                        }
                    } else if (task.status === 'failed') {
                        clearInterval(pollInterval);
                        LoaderManager.hide();
                        const errorMsg = task.error || 'Unknown error';
                        outputElement.innerHTML += `<br><div class="text-danger"><strong> Error:</strong> ${errorMsg}</div>`;
                        showToast(`${operationType.replace('-', ' ')} failed`, 'error');
                    }
                }
            })
            .catch(error => {
                console.error('Polling error:', error);
            });
    }, 2000); // Poll every 2 seconds
}

// 2. Fix Restart Policies (with threading + polling)
document.getElementById('fix-restart-policies-btn')?.addEventListener('click', async function() {
    const result = await Swal.fire({
        title: 'Fix Restart Policies?',
        html: `
            <div class="text-start">
                <p>This will fix restart policies for <strong>ALL Frappe containers</strong>:</p>
                <div class="alert alert-info">
                    <h6>What will happen:</h6>
                    <ul>
                        <li>Find all containers ending with -db, -redis, -app</li>
                        <li>Update restart policy to "unless-stopped"</li>
                        <li>Start any stopped containers</li>
                        <li>Containers will auto-start after system reboot</li>
                    </ul>
                </div>
            </div>
        `,
        icon: 'info',
        showCancelButton: true,
        confirmButtonColor: '#17a2b8',
        confirmButtonText: 'Yes, Fix Policies',
        cancelButtonText: 'Cancel'
    });
    
    if (result.isConfirmed) {
        const outputElement = document.getElementById('danger-zone-output');
        outputElement.innerHTML = '<div class="text-info"><i class="bi bi-gear-fill spin"></i> Starting restart policy fix...</div>';
        LoaderManager.show('Fixing restart policies...');
        
        // Start fix task
        fetch('/api/frappe/fix-restart-policies', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.task_id) {
                // Start polling for status
                pollDangerZoneStatus(data.task_id, 'restart-policy', outputElement);
            } else {
                LoaderManager.hide();
                outputElement.innerHTML = `<div class="text-danger"> Error: ${data.error || 'Failed to start task'}</div>`;
                showToast('Failed to start restart policy fix', 'error');
            }
        })
        .catch(error => {
            LoaderManager.hide();
            outputElement.innerHTML = `<div class="text-danger"> Error: ${error.message}</div>`;
            showToast('Failed to start restart policy fix', 'error');
        });
    }
});

// 3. Complete Site Removal (with double confirmation)
document.getElementById('complete-site-removal-btn')?.addEventListener('click', async function() {
    const siteName = document.getElementById('danger-site-select').value;
    
    if (!siteName) {
        showToast('Please select a site first', 'error');
        return;
    }
    
    // First, show what will be removed
    const outputElement = document.getElementById('danger-zone-output');
    outputElement.innerHTML = '<div class="text-info"><i class="bi bi-hourglass-split"></i> Checking containers and folders...</div>';
    
    try {
        // Convert underscores to dots for domain name (JavaScript replacement)
        const siteDomain = siteName.replace(/_/g, '.');
        
        const checkCommand = `
BASE_DIR="${FRAPPE_BASE_DIR}"
echo " Base directory: $BASE_DIR"
echo ""
echo "=== Containers that will be removed ==="
docker ps -a --filter "name=^${siteName}-" --format "table {{.Names}}\\t{{.Status}}"
echo ""
echo "=== Folders that will be checked ==="
ls -ld "$BASE_DIR/Docker-Local/${siteName}" 2>/dev/null || echo "Docker-Local: Not found"
ls -ld "$BASE_DIR/Docker-on-VPS/${siteName}" 2>/dev/null || echo "Docker-on-VPS: Not found"
ls -ld ~/frappe-docker/${siteName}-frappe-bench 2>/dev/null || echo "Development folder: Not found"
echo ""
echo "=== Hosts file entries ==="
grep "${siteDomain}" /etc/hosts 2>/dev/null || echo "No hosts entry found"
        `;
        
        const checkData = await executeDangerCommand(checkCommand, 'danger-zone-output', false);
        
        // First confirmation
        const firstConfirm = await Swal.fire({
            title: ' COMPLETE SITE REMOVAL ',
            html: `
                <div class="text-start">
                    <div class="alert alert-danger">
                        <h5><i class="bi bi-exclamation-octagon-fill"></i> CRITICAL WARNING!</h5>
                        <p><strong>This will PERMANENTLY remove ALL data for:</strong></p>
                        <h4 class="text-center my-3">${siteName}</h4>
                    </div>
                    
                    <div class="alert alert-warning">
                        <h6>What will be deleted:</h6>
                        <ul>
                            <li> All Docker containers (app, db, redis)</li>
                            <li> All database data</li>
                            <li> Site folder: <code>${siteName}/</code></li>
                            <li> Development folder: <code>~/frappe-docker/${siteName}-frappe-bench/</code></li>
                            <li> Hosts file entries</li>
                        </ul>
                    </div>
                    
                    <div class="alert alert-danger">
                        <p class="mb-0"><strong> THIS ACTION CANNOT BE UNDONE!</strong></p>
                        <p class="mb-0">Make sure you have backups before proceeding.</p>
                    </div>
                    
                    <p class="text-center mt-3">Check the output below to see what will be removed.</p>
                </div>
            `,
            icon: 'error',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            confirmButtonText: 'I Understand, Continue',
            cancelButtonText: 'Cancel',
            width: '700px'
        });
        
        if (!firstConfirm.isConfirmed) {
            outputElement.innerHTML = '<div class="text-warning"><i class="bi bi-x-circle"></i> Operation cancelled by user</div>';
            return;
        }
        
        // Second confirmation - Type DELETE
        const secondConfirm = await Swal.fire({
            title: 'FINAL CONFIRMATION REQUIRED',
            html: `
                <div class="text-start">
                    <div class="alert alert-danger text-center">
                        <h4> LAST CHANCE TO CANCEL </h4>
                        <p class="mb-0">You are about to permanently delete:</p>
                        <h3 class="my-3">${siteName}</h3>
                    </div>
                    
                    <p class="text-danger text-center mb-3">
                        <strong>Type exactly:</strong> <code class="fs-5">DELETE</code>
                    </p>
                </div>
            `,
            input: 'text',
            inputPlaceholder: 'Type DELETE to confirm',
            icon: 'error',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            confirmButtonText: 'Permanently Delete Everything',
            cancelButtonText: 'Cancel',
            inputValidator: (value) => {
                if (value !== 'DELETE') {
                    return 'You must type DELETE exactly (in capital letters)';
                }
            },
            width: '600px'
        });
        
        if (!secondConfirm.isConfirmed) {
            outputElement.innerHTML = '<div class="text-warning"><i class="bi bi-x-circle"></i> Operation cancelled - confirmation failed</div>';
            return;
        }
        
        // Execute site removal with threading + polling
        outputElement.innerHTML = '<div class="text-danger"><i class="bi bi-trash-fill spin"></i> Starting complete site removal...</div>';
        LoaderManager.show('Removing site completely...');
        
        // Start removal task
        fetch('/api/frappe/remove-site', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({ site_name: siteName })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.task_id) {
                // Start polling for status
                pollDangerZoneStatus(data.task_id, 'site-removal', outputElement, siteName);
            } else {
                LoaderManager.hide();
                outputElement.innerHTML = `<div class="text-danger"> Error: ${data.error || 'Failed to start removal'}</div>`;
                showToast('Failed to start site removal', 'error');
            }
        })
        .catch(error => {
            LoaderManager.hide();
            outputElement.innerHTML = `<div class="text-danger"> Error: ${error.message}</div>`;
            showToast('Failed to start site removal', 'error');
        });
        
    } catch (error) {
        showToast('Error during site removal', 'error');
        LoaderManager.hide();
    }
});

console.log(' Danger Zone operations initialized');
{% endraw %}
</script>
{% endblock %}
