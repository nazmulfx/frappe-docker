
    <script>
        // Show/hide GitHub token field based on selected method
        document.addEventListener('DOMContentLoaded', function() {
            const authMethodSelect = document.getElementById('auth-method');
            const githubTokenRow = document.getElementById('github-token-row');
            
            function toggleAuthFields() {
                const method = authMethodSelect.value;
                
                if (method === 'token') {
                    githubTokenRow.style.display = 'block';
                } else {
                    githubTokenRow.style.display = 'none';
                }
            }
            
            // Initial toggle
            toggleAuthFields();
            
            // Add event listener
            authMethodSelect.addEventListener('change', toggleAuthFields);
        });
    </script>
{% extends "base.html" %}

{% block title %}App Installation - Web Docker Manager{% endblock %}

{% block custom_css %}
.app-installation-card {
    margin-bottom: 20px;
    transition: transform 0.2s ease-in-out;
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.app-installation-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.terminal-container {
    background-color: #1a1a1a;
    color: #00ff41;
    font-family: 'Courier New', monospace;
    padding: 0;
    border-radius: 8px;
    height: 600px;
    overflow: hidden;
    margin-bottom: 20px;
    border: 1px solid #333;
}

/* Frappe Cloud-like styling */
.frappe-cloud-card {
    border: 1px solid #e1e5e9;
    border-radius: 8px;
    background: #fff;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    transition: all 0.2s ease;
}

.frappe-cloud-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    border-color: #007bff;
}

.container-card {
    border-left: 4px solid #007bff;
    padding: 1rem;
    margin-bottom: 1rem;
}

.container-card.running {
    border-left-color: #28a745;
}

.container-card.stopped {
    border-left-color: #dc3545;
}

.app-operation-btn {
    margin: 0.25rem;
    min-width: 120px;
}

.status-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

.operation-log {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 1rem;
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
    max-height: 300px;
    overflow-y: auto;
}

.log-success {
    color: #28a745;
}

.log-error {
    color: #dc3545;
}

.log-warning {
    color: #ffc107;
}

.log-info {
    color: #17a2b8;
}

.log-message {
    white-space: pre-wrap; /* Preserve whitespace and line breaks */
    font-family: monospace; /* Use monospace font for better readability */
    margin-top: 2px;
}

.log-entry {
    margin-bottom: 8px;
    padding: 4px 0;
}

/* Include xterm.js CSS */
@import url('https://cdn.jsdelivr.net/npm/xterm@5.1.0/css/xterm.min.css');
<link rel="stylesheet" href="{{ url_for('static', filename='css/frappe-cloud.css') }}">
{% endblock %}

{% block custom_head %}
<!-- XTerm.js dependencies -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.1.0/css/xterm.min.css">
<script src="https://cdn.jsdelivr.net/npm/xterm@5.1.0/lib/xterm.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.7.0/lib/xterm-addon-fit.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links@0.8.0/lib/xterm-addon-web-links.min.js"></script>
<!-- Include XTermWS script -->
<script src="{{ url_for('static', filename='js/xterm-ws.js') }}"></script>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h1 class="h3 mb-4">
        <i class="bi bi-cloud-arrow-up me-2"></i>Frappe App Management
        <small class="text-muted">- Frappe Cloud-like Interface</small>
    </h1>

    <div class="row">
        <div class="col-md-12">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-tools me-2"></i> App Management Tools
                    </h5>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary btn-sm" id="refresh-containers">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                        <button type="button" class="btn btn-outline-success btn-sm" id="bulk-operations">
                            <i class="bi bi-layers"></i> Bulk Operations
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs" id="installTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="ui-panel-tab" data-bs-toggle="tab" data-bs-target="#ui-panel" type="button" role="tab" aria-controls="ui-panel" aria-selected="true">
                                <i class="bi bi-window"></i> App Management
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="console-panel-tab" data-bs-toggle="tab" data-bs-target="#console-panel" type="button" role="tab" aria-controls="console-panel" aria-selected="false">
                                <i class="bi bi-terminal"></i> Terminal Access
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="ssh-panel-tab" data-bs-toggle="tab" data-bs-target="#ssh-panel" type="button" role="tab" aria-controls="ssh-panel" aria-selected="false">
                                <i class="bi bi-shield-lock"></i> SSH Access
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content mt-3" id="installTabsContent">
                        <!-- UI Panel Tab - Frappe Cloud-like Interface -->
                        <div class="tab-pane fade show active" id="ui-panel" role="tabpanel">
                            <div class="row">
                                <!-- Container Selection -->
                                <div class="col-md-4">
                                    <div class="frappe-cloud-card">
                                        <div class="card-header bg-primary text-white">
                                            <h6 class="mb-0">
                                                <i class="bi bi-server"></i> Select Container
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label for="app-container-select" class="form-label fw-bold">
                                                    <i class="bi bi-terminal"></i> App Server Container
                                                </label>
                                                <select class="form-select" id="app-container-select">
                                                    <option value="">-- Choose a container --</option>
                                                    {% for project_name, project_containers in container_groups.items() %}
                                                        <optgroup label="{{ project_name }}">
                                                            {% for container in project_containers %}
                                                                {% if container.service_type == 'App Server' %}
                                                                    <option value="{{ container.name }}" 
                                                                            data-status="{{ container.status }}"
                                                                            data-image="{{ container.image }}">
                                                                        {{ container.name }}
                                                                    </option>
                                                                {% endif %}
                                                            {% endfor %}
                                                        </optgroup>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            
                                            <!-- Container Info -->
                                            <div id="container-info" class="mt-3" style="display: none;">
                                                <div class="alert alert-info">
                                                    <h6><i class="bi bi-info-circle"></i> Container Information</h6>
                                                    <div id="container-details"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Quick Actions -->
                                    <div class="frappe-cloud-card mt-3">
                                        <div class="card-header bg-success text-white">
                                            <h6 class="mb-0">
                                                <i class="bi bi-lightning"></i> Quick Actions
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="d-grid gap-2">
                                                <button class="btn btn-outline-primary app-operation-btn" id="bench-status">
                                                    <i class="bi bi-check-circle"></i> Bench Status
                                                </button>
                                                <button class="btn btn-outline-info app-operation-btn" id="bench-info">
                                                    <i class="bi bi-info-square"></i> Bench Info
                                                </button>
                                                <button class="btn btn-outline-warning app-operation-btn" id="bench-clear-cache">
                                                    <i class="bi bi-trash"></i> Clear Cache
                                                </button>
                                                <button class="btn btn-outline-secondary app-operation-btn" id="bench-migrate">
                                                    <i class="bi bi-arrow-up-circle"></i> Migrate
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- App Operations -->
                                <div class="col-md-8">
                                    <div class="frappe-cloud-card">
                                        <div class="card-header bg-warning text-dark">
                                            <h6 class="mb-0">
                                                <i class="bi bi-gear"></i> App Operations
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <!-- Get App Section -->
                                            <div class="mb-4">
                                                <h6 class="text-primary">
                                                    <i class="bi bi-download"></i> Get App
                                                </h6>
                                                <div class="row">
                                                    <div class="col-md-12">
                                                        <div class="mb-3">
                                                            <label for="app-repo-url" class="form-label">Repository URL</label>
                                                            <input type="url" class="form-control" id="app-repo-url" 
                                                                   placeholder="https://github.com/frappe/app-name">
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="mb-3">
                                                            <label for="app-branch" class="form-label">Branch (Optional)</label>
                                                            <input type="text" class="form-control" id="app-branch" 
                                                                   placeholder="main, develop, etc.">
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="mb-3">
                                                            <label for="auth-method" class="form-label">Auth Method</label>
                                                            <select class="form-select" id="auth-method">
                                                                <option value="none">Public</option>
                                                                <option value="token">Private (Token)</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <div class="mb-3">
                                                            <label class="form-label">&nbsp;</label>
                                                            <button class="btn btn-primary w-100" id="get-app-btn">
                                                                <i class="bi bi-download"></i> Get App
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                    <div class="col-md-2">
                                                        <div class="mb-3">
                                                            <label class="form-label">&nbsp;</label>
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="get-app-overwrite">
                                                                <label class="form-check-label" for="get-app-overwrite">
                                                                    Overwrite
                                                                </label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                <!-- GitHub Token Field (shown only when Private is selected) -->
                                                <div class="row" id="github-token-row" style="display: none;">
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label for="github-token" class="form-label">GitHub Personal Access Token</label>
                                                            <input type="password" class="form-control" id="github-token" 
                                                                   placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                                                            <div class="form-text">Required for private GitHub repositories</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <hr>
                                            
                                            <!-- Install App Section -->
                                            <div class="mb-4">
                                                <h6 class="text-success">
                                                    <i class="bi bi-install"></i> Install App
                                                </h6>
                                                <div class="row">
                                                    <div class="col-md-4">
                                                        <div class="mb-3">
                                                            <label for="install-app-name" class="form-label">App Name</label>
                                                            <div class="input-group">
                                                                <select class="form-select" id="install-app-name">
                                                                    <option value="">Select an app...</option>
                                                                </select>
                                                                <button class="btn btn-outline-secondary" type="button" id="refresh-apps-btn" title="Refresh Apps">
                                                                    <i class="bi bi-bootstrap-reboot"></i>
                                                                </button>
                                                            </div>
                                                            <div class="form-text">Apps will be loaded when you select a container</div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="mb-3">
                                                            <label for="install-site-name" class="form-label">Site Name</label>
                                                            <div class="input-group">
                                                                <select class="form-select" id="install-site-name">
                                                                    <option value="">Select a site...</option>
                                                                </select>
                                                                <button class="btn btn-outline-secondary" type="button" id="refresh-sites-btn" title="Refresh Sites">
                                                                    <i class="bi bi-bootstrap-reboot"></i>
                                                                </button>
                                                            </div>
                                                            <div class="form-text">Sites will be loaded when you select a container</div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="mb-3">
                                                            <label class="form-label">&nbsp;</label>
                                                            <button class="btn btn-success w-100" id="install-app-btn">
                                                                <i class="bi bi-install"></i> Install App
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                                <div class="row mt-2">
                                                    <div class="col-md-4">
                                                        <div class="mb-3">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="install-app-force">
                                                                <label class="form-check-label" for="install-app-force">
                                                                    Force Install (--force)
                                                                </label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            <!-- App Management Section -->
                                            <div class="mb-4">
                                                <h6 class="text-info">
                                                    <i class="bi bi-gear-fill"></i> App Management
                                                </h6>
                                                <div class="row">
                                                    <div class="col-md-3">
                                                        <button class="btn btn-outline-primary w-100 app-operation-btn" id="uninstall-app-btn">
                                                            <i class="bi bi-trash"></i> Uninstall App
                                                        </button>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <button class="btn btn-outline-warning w-100 app-operation-btn" id="update-app-btn">
                                                            <i class="bi bi-arrow-up"></i> Update App
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-3">
                                                        <button class="btn btn-outline-info w-100 app-operation-btn" id="list-apps-btn">
                                                            <i class="bi bi-list"></i> List Apps
                                                        </button>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <button class="btn btn-outline-secondary w-100 app-operation-btn" id="bench-restart-btn">
                                                            <i class="bi bi-arrow-clockwise"></i> Supervisor Bench
                                                        </button>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <button class="btn btn-outline-success w-100 app-operation-btn" id="supervisor-status-btn">
                                                            <i class="bi bi-activity"></i> Supervisor Status
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                        </div>
                                    </div>
                                    
                                </div>
                                <div class="col-md-12">
                                <!-- Bench Build Card -->
                                <div class="col-md-8">
                                    <div class="frappe-cloud-card mt-3">
                                        <div class="card-header bg-secondary text-white">
                                            <h6 class="mb-0">
                                                <i class="bi bi-hammer"></i> Bench Build
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label for="build-app-name" class="form-label">App Name (Optional)</label>
                                                        <div class="input-group">
                                                            <select class="form-select" id="build-app-name">
                                                                <option value="">Build All Apps</option>
                                                            </select>
                                                            <button class="btn btn-outline-secondary" type="button" id="refresh-build-apps-btn" title="Refresh Apps">
                                                                <i class="bi bi-bootstrap-reboot"></i>
                                                            </button>
                                                        </div>
                                                        <div class="form-text">Leave empty to build all apps, or select specific app</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="mb-3">
                                                        <label class="form-label">&nbsp;</label>
                                                        <button class="btn btn-secondary w-100" id="bench-build-btn">
                                                            <i class="bi bi-hammer"></i> Build
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="mb-3">
                                                        <label class="form-label">&nbsp;</label>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="build-force">
                                                            <label class="form-check-label" for="build-force">
                                                                Force Build
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                    <!-- Operation Log -->
                                    <div class="frappe-cloud-card mt-3">
                                        <div class="card-header bg-dark text-white">
                                            <h6 class="mb-0">
                                                <i class="bi bi-terminal"></i> Operation Log
                                                <button class="btn btn-sm btn-outline-light float-end" id="clear-log-btn">
                                                    <i class="bi bi-trash"></i> Clear
                                                </button>
                                            </h6>
                                        </div>
                                        <div class="card-body p-0">
                                            <div id="operation-log" class="operation-log">
                                                <div class="text-muted text-center py-3">
                                                    <i class="bi bi-info-circle"></i> Select a container and perform operations to see logs here
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Console Panel Tab -->
                        <div class="tab-pane fade" id="console-panel" role="tabpanel">
                            <ul class="nav nav-pills nav-fill mb-3" id="terminalTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="terminal-console-tab" data-bs-toggle="pill" data-bs-target="#terminal-console" type="button" role="tab" aria-controls="terminal-console" aria-selected="true">
                                        <i class="bi bi-terminal"></i> Terminal Console
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="terminal-logs-tab" data-bs-toggle="pill" data-bs-target="#terminal-logs" type="button" role="tab" aria-controls="terminal-logs" aria-selected="false">
                                        <i class="bi bi-journal-text"></i> Terminal Logs
                                    </button>
                                </li>
                            </ul>
                            
                            <div class="tab-content" id="terminalTabsContent">
                                <div class="tab-pane fade show active" id="terminal-console" role="tabpanel">
                                    <div class="container-selector mb-3">
                                        <label for="container-select" class="form-label fw-bold">
                                            <i class="bi bi-terminal"></i> Select Container for Terminal Access
                                        </label>
                                        <select class="form-select form-select-lg" id="container-select">
                                            <option value="">-- Choose a container --</option>
                                            {% for project_name, project_containers in container_groups.items() %}
                                                <optgroup label="{{ project_name }}">
                                                    {% for container in project_containers %}
                                                        {% if container.service_type == 'App Server' %}
                                                            <option value="{{ container.name }}">{{ container.name }}</option>
                                                        {% endif %}
                                                    {% endfor %}
                                                </optgroup>
                                            {% endfor %}
                                        </select>
                                        <div class="form-text">
                                            <i class="bi bi-info-circle"></i> Select a container to access its terminal for advanced operations
                                        </div>
                                    </div>
                                    
                                    <div class="card">
                                        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                                            <div>
                                                <i class="bi bi-terminal-fill me-2"></i>
                                                <span id="terminal-title">AWS Console-like Terminal</span>
                                            </div>
                                            <div>
                                                <button class="btn btn-sm btn-outline-light" id="terminal-clear-btn">
                                                    <i class="bi bi-eraser"></i> Clear
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body p-0">
                                            <div id="terminal-container" class="terminal-container"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="tab-pane fade" id="terminal-logs" role="tabpanel">
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="card">
                                                <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <i class="bi bi-journal-text me-2"></i>
                                                        <span class="fw-bold">Terminal Access Error Logs</span>
                                                    </div>
                                                    <div>
                                                        <button class="btn btn-sm btn-outline-dark" id="refresh-logs-btn">
                                                            <i class="bi bi-arrow-clockwise"></i> Refresh
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-dark" id="clear-logs-btn">
                                                            <i class="bi bi-trash"></i> Clear
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="card-body p-0">
                                                    <div class="table-responsive">
                                                        <table class="table table-striped table-hover mb-0" id="terminal-logs-table">
                                                            <thead class="table-dark">
                                                                <tr>
                                                                    <th width="5%">
                                                                        <i class="bi bi-hash"></i>
                                                                    </th>
                                                                    <th width="15%">
                                                                        <i class="bi bi-clock"></i> Timestamp
                                                                    </th>
                                                                    <th width="15%">
                                                                        <i class="bi bi-terminal"></i> Container
                                                                    </th>
                                                                    <th width="20%">
                                                                        <i class="bi bi-code-square"></i> Command
                                                                    </th>
                                                                    <th width="25%">
                                                                        <i class="bi bi-exclamation-triangle"></i> Error Message
                                                                    </th>
                                                                    <th width="10%">
                                                                        <i class="bi bi-x-circle"></i> Exit Code
                                                                    </th>
                                                                    <th width="10%">
                                                                        <i class="bi bi-person"></i> User
                                                                    </th>
                                                                </tr>
                                                            </thead>
                                                            <tbody id="terminal-logs-tbody">
                                                                <tr>
                                                                    <td colspan="7" class="text-center text-muted py-4">
                                                                        <i class="bi bi-info-circle me-2"></i>
                                                                        No terminal error logs found. Terminal errors will appear here.
                                                                    </td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                                <div class="card-footer bg-light">
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <small class="text-muted">
                                                                <i class="bi bi-info-circle me-1"></i>
                                                                Showing terminal command errors and failures
                                                            </small>
                                                        </div>
                                                        <div class="col-md-6 text-end">
                                                            <small class="text-muted">
                                                                <span id="logs-count">0</span> error(s) found
                                                            </small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- SSH Panel Tab -->
                        <div class="tab-pane fade" id="ssh-panel" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">
                                                <i class="bi bi-shield-lock me-2"></i> Temporary SSH Access Setup
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <form id="temp-ssh-form">
                                                <div class="mb-3">
                                                    <label for="temp-container-select" class="form-label">
                                                        <i class="bi bi-terminal"></i> Select Container
                                                    </label>
                                                    <select class="form-select" id="temp-container-select">
                                                        <option value="">-- Choose a container --</option>
                                                        {% for project_name, project_containers in container_groups.items() %}
                                                            <optgroup label="{{ project_name }}">
                                                                {% for container in project_containers %}
                                                                    {% if container.service_type == 'App Server' %}
                                                                        <option value="{{ container.name }}">{{ container.name }}</option>
                                                                    {% endif %}
                                                                {% endfor %}
                                                            </optgroup>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label for="temp-username" class="form-label">
                                                        <i class="bi bi-person"></i> SSH Username
                                                    </label>
                                                    <input type="text" class="form-control" id="temp-username" value="frappe" placeholder="e.g., frappe, root, ubuntu">
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label for="temp-duration" class="form-label">
                                                        <i class="bi bi-clock"></i> Access Duration
                                                    </label>
                                                    <select class="form-select" id="temp-duration">
                                                        <option value="1">1 Hour</option>
                                                        <option value="6">6 Hours</option>
                                                        <option value="24" selected>24 Hours</option>
                                                        <option value="72">3 Days</option>
                                                        <option value="168">1 Week</option>
                                                    </select>
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label for="temp-port" class="form-label">
                                                        <i class="bi bi-ethernet"></i> SSH Port (Auto-assigned if empty)
                                                    </label>
                                                    <input type="number" class="form-control" id="temp-port" placeholder="e.g., 2222, 2223">
                                                    <div class="form-text">Leave empty for auto-assignment</div>
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label for="temp-description" class="form-label">
                                                        <i class="bi bi-chat-text"></i> Description (Optional)
                                                    </label>
                                                    <input type="text" class="form-control" id="temp-description" placeholder="e.g., Development access, Debug session">
                                                </div>
                                                
                                                <div class="d-grid gap-2">
                                                    <button type="submit" class="btn btn-success">
                                                        <i class="bi bi-key"></i> Generate Temporary Access
                                                    </button>
                                                    <button type="button" class="btn btn-outline-info" id="check-ssh-status">
                                                        <i class="bi bi-check-circle"></i> Check SSH Status
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">
                                                <i class="bi bi-info-circle"></i> Access Information
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="access-info" class="alert alert-info">
                                                <i class="bi bi-info-circle"></i> No active SSH access configured
                                            </div>
                                            
                                            <div id="ssh-connection-details" style="display: none;">
                                                <h6><i class="bi bi-terminal"></i> SSH Connection Details:</h6>
                                                <div class="bg-dark text-light p-3 rounded mb-3" style="font-family: monospace;">
                                                    <div id="ssh-host-info"></div>
                                                    <div id="ssh-port-info"></div>
                                                    <div id="ssh-username-info"></div>
                                                    <div id="ssh-key-info"></div>
                                                </div>
                                                
                                                <h6><i class="bi bi-download"></i> Download SSH Key:</h6>
                                                <div class="d-grid gap-2">
                                                    <button class="btn btn-outline-primary" id="download-private-key">
                                                        <i class="bi bi-download"></i> Download Private Key (.pem)
                                                    </button>
                                                    <button class="btn btn-outline-secondary" id="copy-ssh-command">
                                                        <i class="bi bi-clipboard"></i> Copy SSH Command
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <div class="mt-3">
                                                <button class="btn btn-outline-danger btn-sm" id="revoke-access" style="display: none;">
                                                    <i class="bi bi-x-circle"></i> Revoke Access
                                                </button>
                                                <button class="btn btn-outline-warning btn-sm" id="extend-access" style="display: none;">
                                                    <i class="bi bi-clock"></i> Extend Access
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">
                                                <i class="bi bi-list-check"></i> Active SSH Sessions
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-striped" id="ssh-sessions-table">
                                                    <thead>
                                                        <tr>
                                                            <th>Container</th>
                                                            <th>Username</th>
                                                            <th>Port</th>
                                                            <th>Created</th>
                                                            <th>Expires</th>
                                                            <th>Status</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="ssh-sessions-tbody">
                                                        <tr>
                                                            <td colspan="7" class="text-center text-muted">No active SSH sessions</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="confirmationMessage">Are you sure you want to execute this command?</p>
                <p id="confirmationWarning" class="text-warning">This operation may take several minutes to complete.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmActionBtn">Confirm</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
<script src="{{ url_for('static', filename='js/ssh-manager.js') }}"></script>
<script>
// Frappe Cloud-like App Management JavaScript
class FrappeAppManager {
    constructor() {
        this.selectedContainer = null;
        this.operationLog = [];
        this.init();
    }
    
    init() {
        this.initializeEventListeners();
        this.initializeTerminal();
        this.initializeSSH();
        this.initializeTerminalLogs();
    }
    
    initializeEventListeners() {
        
        // Container selection
        const containerSelect = document.getElementById('app-container-select');
        if (containerSelect) {
            containerSelect.addEventListener('change', (e) => {
                this.selectedContainer = e.target.value;
                this.updateContainerInfo();
                this.updateOperationButtons();
                
                if (this.selectedContainer) {
                    this.loadAppsForContainer();
                    this.loadSitesForContainer(); // Add this line
                } else {
                    this.clearAppsDropdown();
                    this.clearSitesDropdown(); // Add this line
                }
            });
        }
        
        // App operations
        document.getElementById('get-app-btn')?.addEventListener('click', () => this.getApp());
        const installBtn = document.getElementById('install-app-btn');
        
        if (installBtn) {
            installBtn.addEventListener('click', () => {
                this.installApp();
            });
        }
        
        document.getElementById('uninstall-app-btn')?.addEventListener('click', () => this.uninstallApp());
        document.getElementById('update-app-btn')?.addEventListener('click', () => this.updateApp());
        document.getElementById('list-apps-btn')?.addEventListener('click', () => this.listApps());
        document.getElementById('bench-restart-btn')?.addEventListener('click', () => this.restartBench());
        document.getElementById('supervisor-status-btn')?.addEventListener('click', () => this.supervisorStatus());
        document.getElementById('bench-build-btn')?.addEventListener('click', () => this.benchBuild());
        
        
        // Quick actions
        document.getElementById('bench-status')?.addEventListener('click', () => this.benchStatus());
        document.getElementById('bench-info')?.addEventListener('click', () => this.benchInfo());
        document.getElementById('bench-clear-cache')?.addEventListener('click', () => this.clearCache());
        document.getElementById('bench-migrate')?.addEventListener('click', () => this.migrate());
        
        // Log management
        document.getElementById('clear-log-btn')?.addEventListener('click', () => this.clearOperationLog());
        document.getElementById('refresh-containers')?.addEventListener('click', () => this.refreshContainers());
        
        // Terminal operations
        const terminalContainerSelect = document.getElementById('container-select');
        if (terminalContainerSelect) {
            terminalContainerSelect.addEventListener('change', function() {
                const selectedContainer = this.value;
                if (selectedContainer && window.terminal) {
                    console.log('Connecting to container from dropdown:', selectedContainer);
                    window.terminal.connectToContainer(selectedContainer);
                    
                    const terminalTitle = document.getElementById('terminal-title');
                    if (terminalTitle) {
                        terminalTitle.textContent = `Terminal: ${selectedContainer}`;
                    }
                }
            });
        }
        
        const clearButton = document.getElementById('terminal-clear-btn');
        if (clearButton) {
            clearButton.addEventListener('click', function() {
                if (window.terminal) {
                    window.terminal.clear();
                }
            });
        }

        // Add a refresh apps button or method
        document.getElementById('refresh-apps-btn')?.addEventListener('click', () => this.refreshApps());
        document.getElementById('refresh-sites-btn')?.addEventListener('click', () => this.refreshSites());
    }
    
    updateContainerInfo() {
        const containerInfo = document.getElementById('container-info');
        const containerDetails = document.getElementById('container-details');
        
        if (!this.selectedContainer) {
            containerInfo.style.display = 'none';
            return;
        }
        
        const option = document.querySelector(`#app-container-select option[value="${this.selectedContainer}"]`);
        if (option) {
            const status = option.dataset.status || 'Unknown';
            const image = option.dataset.image || 'Unknown';
            const isRunning = status.includes('Up');
            
            containerDetails.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <strong>Container:</strong> ${this.selectedContainer}<br>
                        <strong>Status:</strong> 
                        <span class="badge ${isRunning ? 'bg-success' : 'bg-danger'} status-badge">
                            ${isRunning ? 'Running' : 'Stopped'}
                        </span>
                    </div>
                    <div class="col-md-6">
                        <strong>Image:</strong> ${image}<br>
                        <strong>Type:</strong> App Server
                    </div>
                </div>
            `;
            containerInfo.style.display = 'block';
        }
    }
    
    updateOperationButtons() {
        const buttons = document.querySelectorAll('.app-operation-btn');
        const isEnabled = !!this.selectedContainer;
        
        buttons.forEach(btn => {
            btn.disabled = !isEnabled;
            if (isEnabled) {
                btn.classList.remove('disabled');
            } else {
                btn.classList.add('disabled');
            }
        });
    }
    
    async executeCommand(command, description) {
        if (!this.selectedContainer) {
            this.addToLog('error', 'Please select a container first');
            return;
        }
        
        this.addToLog('info', `Executing: ${description}`);
        
        try {
            const response = await fetch('/api/frappe/execute-command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({
                    container: this.selectedContainer,
                    command: command
                })
            });
            
            const data = await response.json();
            
            if (data.error) {
                this.addToLog('error', `Error: ${data.error}`);
            } else {
                this.addToLog('success', `Success: ${description}`);
                if (data.output) {
                    this.addToLog('info', data.output);
                }
            }
        } catch (error) {
            this.addToLog('error', `Network error: ${error.message}`);
        }
    }
    
    addToLog(type, message) {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = {
            timestamp,
            type,
            message
        };
        
        this.operationLog.unshift(logEntry);
        if (this.operationLog.length > 100) {
            this.operationLog = this.operationLog.slice(0, 100);
        }
        
        this.updateOperationLogDisplay();
    }
    
    updateOperationLogDisplay() {
        const logContainer = document.getElementById('operation-log');
        
        if (this.operationLog.length === 0) {
            logContainer.innerHTML = `
                <div class="text-muted text-center py-3">
                    <i class="bi bi-info-circle"></i> Select a container and perform operations to see logs here
                </div>
            `;
            return;
        }
        
        const logHTML = this.operationLog.map(entry => {
            const typeClass = `log-${entry.type}`;
            const icon = this.getLogIcon(entry.type);
            
            // Convert line breaks and preserve formatting
            const formattedMessage = entry.message
                .replace(/\r\n/g, '<br>')
                .replace(/\n/g, '<br>')
                .replace(/\r/g, '<br>');
            
            return `
                <div class="log-entry ${typeClass}">
                    <span class="text-muted">[${entry.timestamp}]</span>
                    <i class="${icon}"></i>
                    <div class="log-message">${formattedMessage}</div>
                </div>
            `;
        }).join('');
        
        logContainer.innerHTML = logHTML;
        logContainer.scrollTop = 0;
    }
    
    getLogIcon(type) {
        const icons = {
            'success': 'bi bi-check-circle-fill',
            'error': 'bi bi-x-circle-fill',
            'warning': 'bi bi-exclamation-triangle-fill',
            'info': 'bi bi-info-circle-fill'
        };
        return icons[type] || 'bi bi-info-circle-fill';
    }
    
    clearOperationLog() {
        this.operationLog = [];
        this.updateOperationLogDisplay();
    }
    
    getCSRFToken() {
        return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || 
               document.querySelector('input[name="csrf_token"]')?.value || '';
    }
    
    // App Operations
    async getApp() {
        const repoUrl = document.getElementById('app-repo-url').value;
        const branch = document.getElementById('app-branch').value;
        const authMethod = document.getElementById('auth-method').value;
        const githubToken = document.getElementById('github-token').value;
        const overwrite = document.getElementById('get-app-overwrite').checked;
        
        if (!repoUrl) {
            this.addToLog('error', 'Repository URL is required');
            return;
        }
        
        if (!this.selectedContainer) {
            this.addToLog('error', 'Please select a container first');
            return;
        }
        
        // Validate authentication for private repositories
        if (authMethod === 'token' && !githubToken) {
            this.addToLog('error', 'GitHub Personal Access Token is required for private repositories');
            return;
        }
        
        try {
            this.addToLog('info', `Getting app from ${repoUrl} (auth: ${authMethod})...`);
            
            let command;
            
            if (authMethod === 'token' && githubToken) {
                // For private repos, modify the URL to include the token
                const repoPath = repoUrl.replace('https://github.com/', '').replace('.git', '');
                const authenticatedUrl = `https://${githubToken}@github.com/${repoPath}.git`;
                command = `bench get-app ${authenticatedUrl}`;
            } else {
                // For public repos, use bench get-app
                command = `bench get-app ${repoUrl}`;
            }
            if (branch) {
                command += ` --branch ${branch}`;
            }
            
            if (overwrite) {
                command += ` --overwrite`;
            }
            
            this.addToLog('info', `Executing command: ${command}`);
            
            const response = await fetch('/api/frappe/execute-command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({
                    container: this.selectedContainer,
                    command: command
                })
            });
            
            const result = await response.json();
            
            this.addToLog('info', `Command result: ${JSON.stringify(result)}`);
            
            // Check if we have output and no error (streaming responses don't have success field)
            if (result.output && !result.error) {
                this.addToLog('success', `Successfully got app from ${repoUrl}`);
                if (result.output) {
                    this.addToLog('info', result.output);
                }
                // Refresh the apps list to show the newly installed app
                await this.loadAppsForContainer();
            } else {
                this.addToLog('error', `Failed to get app: ${result.error || 'Unknown error'}`);
                if (result.error) {
                    this.addToLog('error', result.error);
                }
                // Also log the raw result for debugging
                this.addToLog('error', `Raw result: ${JSON.stringify(result)}`);
            }
        } catch (error) {
            this.addToLog('error', `Error getting app: ${error.message}`);
        }
    }
    
    async installApp() {
        try {
            const appName = document.getElementById('install-app-name').value;
            const siteName = document.getElementById('install-site-name').value;
            const force = document.getElementById('install-app-force').checked;
            
            if (!appName || !siteName) {
                this.addToLog('error', 'Please select an app and a site');
                return;
            }
            
            if (!this.selectedContainer) {
                this.addToLog('error', 'Please select a container first');
                return;
            }
            
            try {
                this.addToLog('info', `Installing app ${appName} on site ${siteName}...`);
                
                // Build the bench install-app command
                const command = `bench --site ${siteName} install-app ${appName}`;
                
                if (force) {
                    command += ` --force`;
                }
                
                this.addToLog('info', `Executing command: ${command}`);
                
                const response = await fetch('/api/frappe/execute-command', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCSRFToken()
                    },
                    body: JSON.stringify({
                        container: this.selectedContainer,
                        command: command
                    })
                });
                
                const result = await response.json();
                
                this.addToLog('info', `Command result: ${JSON.stringify(result)}`);
                
                // Check if we have output and no error (streaming responses don't have success field)
                if (result.output && !result.error) {
                    this.addToLog('success', `Successfully installed app ${appName} on site ${siteName}`);
                    if (result.output) {
                        this.addToLog('info', result.output);
                    }
                } else {
                    this.addToLog('error', `Failed to install app: ${result.error || 'Unknown error'}`);
                    if (result.error) {
                        this.addToLog('error', result.error);
                    }
                    // Also log the raw result for debugging
                    this.addToLog('error', `Raw result: ${JSON.stringify(result)}`);
                }
            } catch (error) {
                this.addToLog('error', `Error installing app: ${error.message}`);
            }
        } catch (error) {
            this.addToLog('error', `Error installing app: ${error.message}`);
        }
    }
    
    async uninstallApp() {
        const appName = prompt('Enter app name to uninstall:');
        if (!appName) return;
        
        const siteName = prompt('Enter site name:');
        if (!siteName) return;
        
        if (confirm(`Are you sure you want to uninstall ${appName} from ${siteName}?`)) {
            const command = `bench --site ${siteName} uninstall-app ${appName}`;
            await this.executeCommand(command, `Uninstalling app ${appName} from site ${siteName}`);
        }
    }
    
    async updateApp() {
        const appName = prompt('Enter app name to update:');
        if (!appName) return;
        
        const command = `bench update --patch`;
        await this.executeCommand(command, `Updating app ${appName}`);
    }
    
    async listApps() {
        // Use safe commands to list apps
        const commands = [
            "cat /home/frappe/frappe-bench/sites/apps.txt",
            "ls -la /home/frappe/frappe-bench/apps/",
            "cat /home/frappe/frappe-bench/sites/apps.json"
        ];
        
        
        for (const cmd of commands) {
            await this.executeCommand(cmd, `Listing apps: ${cmd}`);
        }
        const command = 'bench list-apps';
        await this.executeCommand(command, 'Listing installed apps');
    }
    
    async restartBench() {
        if (!this.selectedContainer) {
            this.showError('Please select a container first');
            return;
        }
        if (confirm('Are you sure you want to restart the bench? This will restart all services.')) {
            const command = '/home/frappe/.local/bin/supervisorctl -c /home/frappe/supervisor/supervisord.conf restart all';
            await this.executeCommand(command, 'Restarting bench services via Supervisor');
        }
    }
    
    async supervisorStatus() {
        if (!this.selectedContainer) {
            this.showError('Please select a container first');
            return;
        }
        const command = '/home/frappe/.local/bin/supervisorctl -c /home/frappe/supervisor/supervisord.conf status';
        await this.executeCommand(command, 'Checking Supervisor status');
    }
    
    async benchBuild() {
        if (!this.selectedContainer) {
            this.showError('Please select a container first');
            return;
        }
        
        const appName = document.getElementById('build-app-name').value;
        const force = document.getElementById('build-force').checked;
        
        let command;
        if (appName) {
            command = `bench build --app ${appName}`;
        } else {
            command = 'bench build';
        }
        
        if (force) {
            command += ` --force`;
        }
        
        const description = appName ? `Building app: ${appName}` : 'Building all apps';
        await this.executeCommand(command, description);
    }
    
    
    // Quick Actions
    async benchStatus() {
        // Use safe version of bench status
        const benchVersionCommand = "bench --version";
        await this.executeCommand(benchVersionCommand, "Checking bench version");
        
        // Also try to get basic info
        const infoCommand = "ls -la /home/frappe/frappe-bench/apps/";
        await this.executeCommand(infoCommand, "Listing installed apps directory");
        
        const sitesCommand = "ls -la /home/frappe/frappe-bench/sites/";
        await this.executeCommand(sitesCommand, "Listing sites directory");
        const benchStatusCommand = 'bench doctor';
        await this.executeCommand(benchStatusCommand, 'Checking bench status');
    }
    
    async benchInfo() {
        // Use safe commands instead of bench info
        const commands = [
            "bench --version",
            "cat /home/frappe/frappe-bench/sites/apps.txt",
            "cat /home/frappe/frappe-bench/sites/currentsite.txt",
            "ls -la /home/frappe/frappe-bench/apps/"
        ];
        
        for (const cmd of commands) {
            await this.executeCommand(cmd, `Getting bench info: ${cmd}`);
        }
        const command = 'bench version';
        await this.executeCommand(command, 'Getting bench information');
    }
    
    async clearCache() {
        const commands = [
            'bench clear-cache',
            'bench clear-website-cache',
        ];
        for (const cmd of commands) {
            await this.executeCommand(cmd, `Clearing cache with website`);
        }
    }
    
    async migrate() {
        const command = 'bench migrate';
        await this.executeCommand(command, 'Running migrations');
    }
    
    async refreshContainers() {
        this.addToLog('info', 'Refreshing container list...');
        window.location.reload();
    }
    
    initializeTerminal() {
        const terminalContainer = document.getElementById('terminal-container');
        if (terminalContainer) {
            try {
                console.log('Creating terminal instance...');
                window.terminal = new XTermWS(terminalContainer, {
                    theme: {
                        background: '#1a1a1a',
                        foreground: '#ffffff',
                        cursor: '#ffffff',
                        selection: 'rgba(255, 255, 255, 0.3)',
                        black: '#000000',
                        red: '#cc0000',
                        green: '#4e9a06',
                        yellow: '#c4a000',
                        blue: '#3465a4',
                        magenta: '#75507b',
                        cyan: '#06989a',
                        white: '#d3d7cf',
                        brightBlack: '#555753',
                        brightRed: '#ef2929',
                        brightGreen: '#8ae234',
                        brightYellow: '#fce94f',
                        brightBlue: '#729fcf',
                        brightMagenta: '#ad7fa8',
                        brightCyan: '#34e2e2',
                        brightWhite: '#eeeeec'
                    }
                });
                
                const containerSelect = document.getElementById('container-select');
                if (containerSelect && containerSelect.value) {
                    setTimeout(() => {
                        if (window.terminal) {
                            console.log('Auto-connecting to container:', containerSelect.value);
                            window.terminal.connectToContainer(containerSelect.value);
                            
                            const terminalTitle = document.getElementById('terminal-title');
                            if (terminalTitle) {
                                terminalTitle.textContent = `Terminal: ${containerSelect.value}`;
                            }
                        }
                    }, 1000);
                }
            } catch (error) {
                console.error('Error initializing terminal:', error);
            }
        }
    }
    
    initializeSSH() {
        if (window.SSHManager) {
            window.SSHManager.initializeSSHEventListeners();
        } else {
            console.error('SSHManager not loaded');
        }
    }
    
    initializeTerminalLogs() {
        const refreshBtn = document.getElementById('refresh-logs-btn');
        const clearBtn = document.getElementById('clear-logs-btn');
        
        if (refreshBtn) {
            refreshBtn.addEventListener('click', loadTerminalLogs);
        }
        
        if (clearBtn) {
            clearBtn.addEventListener('click', clearTerminalLogs);
        }
        
        const terminalLogsTab = document.getElementById('terminal-logs-tab');
        if (terminalLogsTab) {
            terminalLogsTab.addEventListener('shown.bs.tab', function() {
                loadTerminalLogs();
                startPeriodicRefresh();
            });
            
            terminalLogsTab.addEventListener('hidden.bs.tab', function() {
                stopPeriodicRefresh();
            });
        }
        
        loadTerminalLogs();
        setupRealTimeErrorTracking();
    }

    // Updated loadAppsForContainer method:
    async loadAppsForContainer() {
        if (!this.selectedContainer) {
            this.clearAppsDropdown();
            return;
        }
        
        
        try {
            // Show loading state
            this.setAppsDropdownLoading(true);
            
            const response = await fetch('/api/frappe/execute-command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({
                    container: this.selectedContainer,
                    command: 'cat ~/frappe-bench/sites/apps.txt'
                })
            });
            
            const result = await response.json();
            
            // Check if we have output and no error (streaming responses don't have success field)
            if (result.output && !result.error) {
                // Use the raw output directly since it's already in the correct format
                this.populateAppsDropdown(result.output);
            } else {
                this.addToLog('error', `Failed to load apps: ${result.error || 'Unknown error'}`);
                this.clearAppsDropdown();
            }
        } catch (error) {
            this.addToLog('error', `Error loading apps: ${error.message}`);
            this.clearAppsDropdown();
        } finally {
            this.setAppsDropdownLoading(false);
        }
    }

    // Updated populateAppsDropdown method:
    populateAppsDropdown(appsOutput) {
        const appsSelect = document.getElementById('install-app-name');
        const buildAppsSelect = document.getElementById('build-app-name');
        if (!appsSelect) {
            return;
        }
        
        // Clear existing options except the first one
        appsSelect.innerHTML = '<option value="">Select an app...</option>';
        if (buildAppsSelect) {
            buildAppsSelect.innerHTML = '<option value="">Build All Apps</option>';
        }
        
        if (!appsOutput || appsOutput.trim() === '') {
            return;
        }
        
        // Parse the apps output - bench list-apps shows: "appname version status"
        const lines = appsOutput.trim().split('\n').filter(line => line.trim() !== '');
        
        const apps = [];
        
        lines.forEach(line => {
            const trimmed = line.trim();
            if (trimmed) {
                // Extract just the app name (first word before spaces)
                const appName = trimmed.split(/\s+/)[0];
                if (appName && !apps.includes(appName)) {
                    apps.push(appName);
                }
            }
        });
        
        apps.forEach(app => {
            const option = document.createElement('option');
            option.value = app;
            option.textContent = app;
            appsSelect.appendChild(option);
            
            // Also add to build apps dropdown
            const buildAppsSelect = document.getElementById('build-app-name');
            if (buildAppsSelect) {
                const buildOption = document.createElement('option');
                buildOption.value = app;
                buildOption.textContent = app;
                buildAppsSelect.appendChild(buildOption);
            }
        });
    }

    // Method to clear the apps dropdown
    clearAppsDropdown() {
        const appsSelect = document.getElementById('install-app-name');
        const buildAppsSelect = document.getElementById('build-app-name');
        if (appsSelect) {
            appsSelect.innerHTML = '<option value="">Select an app...</option>';
        if (buildAppsSelect) {
            buildAppsSelect.innerHTML = '<option value="">Build All Apps</option>';
        }
        }
    }

    // Method to set loading state for apps dropdown
    setAppsDropdownLoading(isLoading) {
        const appsSelect = document.getElementById('install-app-name');
        const buildAppsSelect = document.getElementById('build-app-name');
        if (!appsSelect) return;
        
        if (isLoading) {
            appsSelect.innerHTML = '<option value="">Loading apps...</option>';
            if (buildAppsSelect) buildAppsSelect.innerHTML = '<option value="">Loading apps...</option>';
            if (buildAppsSelect) buildAppsSelect.disabled = true;
            appsSelect.disabled = true;
        } else {
            appsSelect.disabled = false;
            if (buildAppsSelect) buildAppsSelect.disabled = false;
        }
    }

    // Add a refresh apps button or method
    async refreshApps() {
        if (!this.selectedContainer) {
            this.addToLog('error', 'Please select a container first');
            return;
        }
        
        await this.loadAppsForContainer();
        await this.loadSitesForContainer(); // Also refresh sites
        this.addToLog('info', 'Apps and sites list refreshed');
    }

    // Add method to load sites for the selected container
    async loadSitesForContainer() {
        if (!this.selectedContainer) {
            this.clearSitesDropdown();
            return;
        }
        
        try {
            // Show loading state
            this.setSitesDropdownLoading(true);
            
            const response = await fetch('/api/frappe/execute-command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({
                    container: this.selectedContainer,
                    command: 'cat ~/frappe-bench/sites/currentsite.txt'
                })
            });
            
            const result = await response.json();
            
            // Check if we have output and no error (streaming responses don't have success field)
            if (result.output && !result.error) {
                // Use the raw output directly since it's already in the correct format
                this.populateSitesDropdown(result.output);
            } else {
                this.addToLog('error', `Failed to load sites: ${result.error || 'Unknown error'}`);
                this.clearSitesDropdown();
            }
        } catch (error) {
            this.addToLog('error', `Error loading sites: ${error.message}`);
            this.clearSitesDropdown();
        } finally {
            this.setSitesDropdownLoading(false);
        }
    }

    // Method to populate the sites dropdown
    populateSitesDropdown(sitesOutput) {
        const sitesSelect = document.getElementById('install-site-name');
        if (!sitesSelect) {
            return;
        }
        
        // Clear existing options except the first one
        sitesSelect.innerHTML = '<option value="">Select a site...</option>';
        
        if (!sitesOutput || sitesOutput.trim() === '') {
            return;
        }
        
        // Parse the sites output - remove leading/trailing whitespace and split by newlines
        const allItems = sitesOutput.trim().split('\n').filter(item => item.trim() !== '');
        
        // Filter out non-site files and directories
        const sites = allItems.filter(item => {
            const trimmed = item.trim();
            // Include files that look like site names (contain dots or are typical site names)
            return trimmed && 
                   !trimmed.includes('common_site_config.json') && 
                   !trimmed.includes('currentsite.txt') &&
                   !trimmed.startsWith('.') &&
                   (trimmed.includes('.') || trimmed.match(/^[a-zA-Z0-9_-]+$/));
        });
        
        sites.forEach(site => {
            const siteName = site.trim();
            if (siteName) {
                const option = document.createElement('option');
                option.value = siteName;
                option.textContent = siteName;
                sitesSelect.appendChild(option);
            }
        });
    }

    // Method to clear the sites dropdown
    clearSitesDropdown() {
        const sitesSelect = document.getElementById('install-site-name');
        if (sitesSelect) {
            sitesSelect.innerHTML = '<option value="">Select a site...</option>';
        }
    }

    // Method to set loading state for sites dropdown
    setSitesDropdownLoading(isLoading) {
        const sitesSelect = document.getElementById('install-site-name');
        if (!sitesSelect) return;
        
        if (isLoading) {
            sitesSelect.innerHTML = '<option value="">Loading sites...</option>';
            sitesSelect.disabled = true;
        } else {
            sitesSelect.disabled = false;
        }
    }

    // Method to refresh sites
    async refreshSites() {
        if (!this.selectedContainer) {
            this.addToLog('error', 'Please select a container first');
            return;
        }
        
        await this.loadSitesForContainer();
        this.addToLog('info', 'Sites list refreshed');
    }

    // Add this debug method to test the endpoint:
    async testListAppsEndpoint() {
        
        try {
            const response = await fetch('/api/frappe/list-apps', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({
                    container: this.selectedContainer
                })
            });
            
            if (response.status === 404) {
                this.addToLog('error', 'API endpoint /api/frappe/list-apps not found');
                return false;
            }
            
            const result = await response.json();
            
            return result;
        } catch (error) {
            this.addToLog('error', `Error testing endpoint: ${error.message}`);
            return false;
        }
    }
}

// Global variables for terminal logs
let lastErrorCount = 0;
let logsRefreshInterval = null;

// Initialize the app manager when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    if (typeof window === 'undefined' || typeof document === 'undefined') {
        console.error('Not in a browser environment');
        return;
    }
    
    
    // Wait a bit to ensure all DOM elements are ready
    setTimeout(() => {
        try {
            window.frappeAppManager = new FrappeAppManager();
        } catch (error) {
            console.error('Error initializing FrappeAppManager:', error);
        }
    }, 100);
});

// Terminal logs functions (keeping existing functionality)
function loadTerminalLogs() {
    console.log('Loading terminal logs...');
    fetch('/api/frappe/terminal-logs')
        .then(response => response.json())
        .then(data => {
            console.log('Terminal logs data:', data);
            const logs = data.logs || [];
            updateTerminalLogsTable(logs);
            updateLogsCount(logs.length);
            checkForNewErrors(logs.length);
        })
        .catch(error => {
            console.error('Error loading terminal logs:', error);
            showToast('Failed to load terminal logs', 'error');
        });
}

function updateTerminalLogsTable(logs) {
    console.log("Updating terminal logs table with", logs.length, "logs");
    const tbody = document.getElementById("terminal-logs-tbody");
    
    if (logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">No logs available</td></tr>';
        return;
    }
    
    tbody.innerHTML = logs.map((log, index) => `
        <tr>
            <td>${index + 1}</td>
            <td>${log.timestamp || ""}</td>
            <td>${log.container || ""}</td>
            <td><code>${log.command || ""}</code></td>
            <td>${log.full_error || ""}</td>
            <td>${log.exit_code}</td>
            <td>${log.username || ""}</td>
        </tr>
        <tr>
            <td colspan="7" style="white-space:pre-wrap; font-family:monospace; background:#f8f9fa; padding:5px;">
                ${log.full_error || log.error || ""}
            </td>
        </tr>
    `).join("");
}

function updateLogsCount(count) {
    const countElement = document.getElementById('logs-count');
    if (countElement) {
        countElement.textContent = count;
    }
}

function clearTerminalLogs() {
    if (confirm('Are you sure you want to clear all terminal error logs?')) {
        fetch('/api/frappe/clear-terminal-logs', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Terminal logs cleared successfully', 'success');
                loadTerminalLogs();
            } else {
                showToast('Failed to clear terminal logs', 'error');
            }
        })
        .catch(error => {
            console.error('Error clearing terminal logs:', error);
            showToast('Failed to clear terminal logs', 'error');
        });
    }
}

function startPeriodicRefresh() {
    console.log('Starting periodic refresh...');
    logsRefreshInterval = setInterval(() => {
        loadTerminalLogs();
    }, 50000);
}

function stopPeriodicRefresh() {
    console.log('Stopping periodic refresh...');
    if (logsRefreshInterval) {
        clearInterval(logsRefreshInterval);
        logsRefreshInterval = null;
    }
}

function setupRealTimeErrorTracking() {
    console.log('Setting up real-time error tracking...');
    
    const originalFetch = window.fetch;
    window.fetch = function(...args) {
        return originalFetch.apply(this, args).then(response => {
            if (args[0] && args[0].includes('/api/frappe/execute-command')) {
                return response.clone().json().then(data => {
                    console.log('Command execution response:', data);
                    
                    if (data && (data.success === false || data.error || data.exit_code > 0)) {
                        console.log('Command failed, refreshing logs...');
                        loadTerminalLogs();
                    }
                    return response;
                }).catch(() => response);
            }
            return response;
        });
    };
}

function checkForNewErrors(currentCount) {
    console.log('Checking for new errors. Current:', currentCount, 'Last:', lastErrorCount);
    
    if (currentCount > lastErrorCount && lastErrorCount > 0) {
        const newErrors = currentCount - lastErrorCount;
        console.log('New errors detected:', newErrors);
        showErrorNotification(newErrors);
        
        const terminalLogsTab = document.getElementById('terminal-logs-tab');
        const terminalConsoleTab = document.getElementById('terminal-console-tab');
        
        if (terminalConsoleTab && terminalConsoleTab.classList.contains('active')) {
            showToast(' ' + newErrors + ' new error(s) detected! Click Terminal Logs tab to view.', 'warning');
        }
    }
    lastErrorCount = currentCount;
}

function showErrorNotification(errorCount) {
    console.log('Showing error notification for', errorCount, 'errors');
    
    const terminalLogsTab = document.getElementById('terminal-logs-tab');
    if (terminalLogsTab) {
        const existingBadge = terminalLogsTab.querySelector('.badge');
        if (existingBadge) {
            existingBadge.remove();
        }
        
        const badge = document.createElement('span');
        badge.className = 'badge bg-danger ms-2';
        badge.textContent = errorCount;
        badge.style.fontSize = '0.7em';
        terminalLogsTab.appendChild(badge);
        
        terminalLogsTab.addEventListener('click', function() {
            setTimeout(() => {
                if (badge.parentNode) {
                    badge.remove();
                }
            }, 100);
        });
    }
}

function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toastContainer') || createToastContainer();
    
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'primary'} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toastContainer';
    container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
    container.style.zIndex = '11';
    document.body.appendChild(container);
    return container;
}
</script>
{% endblock %}
