{% extends "base.html" %}

{% block title %}App Installation - Web Docker Manager{% endblock %}

{% block custom_css %}
.app-installation-card {
    margin-bottom: 20px;
    transition: transform 0.2s ease-in-out;
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.app-installation-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.terminal-container {
    background-color: #1a1a1a;
    color: #00ff41;
    font-family: 'Courier New', monospace;
    padding: 15px;
    border-radius: 8px;
    height: 400px;
    overflow-y: auto;
    margin-bottom: 20px;
    border: 1px solid #333;
    font-size: 14px;
    line-height: 1.4;
}

.terminal-input {
    background-color: #1a1a1a;
    color: #00ff41;
    font-family: 'Courier New', monospace;
    border: none;
    width: 100%;
    padding: 8px;
    outline: none;
    font-size: 14px;
}

.terminal-input-container {
    display: flex;
    background-color: #1a1a1a;
    padding: 8px;
    border-radius: 0 0 8px 8px;
    border: 1px solid #333;
    border-top: none;
}

.terminal-prompt {
    color: #00ff41;
    font-family: 'Courier New', monospace;
    margin-right: 8px;
    font-weight: bold;
}

.command-history {
    margin-top: 10px;
    font-size: 0.9em;
    max-height: 200px;
    overflow-y: auto;
}

.command-history-item {
    padding: 8px 12px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    transition: background-color 0.2s;
}

.command-history-item:hover {
    background-color: #f8f9fa;
}

.nav-tabs .nav-link {
    font-weight: 500;
    padding: 12px 20px;
}

.container-selector {
    margin-bottom: 25px;
}

.form-floating {
    margin-bottom: 15px;
}

.btn-loading {
    position: relative;
    pointer-events: none;
}

.btn-loading::after {
    content: "";
    position: absolute;
    width: 16px;
    height: 16px;
    margin: auto;
    border: 2px solid transparent;
    border-top-color: #ffffff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.output-container {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    min-height: 200px;
}

.output-container pre {
    background-color: #f8f9fa;
    border: none;
    padding: 0;
    margin: 0;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.status-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 8px;
}

.status-success {
    background-color: #28a745;
}

.status-error {
    background-color: #dc3545;
}

.status-running {
    background-color: #ffc107;
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.quick-actions {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}

.quick-action-btn {
    background: rgba(255,255,255,0.2);
    border: 1px solid rgba(255,255,255,0.3);
    color: white;
    margin: 5px;
    transition: all 0.3s ease;
}

.quick-action-btn:hover {
    background: rgba(255,255,255,0.3);
    border-color: rgba(255,255,255,0.5);
    color: white;
    transform: translateY(-2px);
}

.progress-container {
    margin-top: 15px;
    display: none;
}

.step-indicator {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
}

.step {
    flex: 1;
    text-align: center;
    padding: 10px;
    border-radius: 8px;
    margin: 0 5px;
    background-color: #f8f9fa;
    border: 2px solid #dee2e6;
    transition: all 0.3s ease;
}

.step.active {
    background-color: #007bff;
    color: white;
    border-color: #007bff;
}

.step.completed {
    background-color: #28a745;
    color: white;
    border-color: #28a745;
}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="bi bi-box-seam"></i> Frappe App Installation</h2>
                    <p class="text-muted mb-0">Install and manage custom apps for your Frappe/ERPNext instances</p>
                </div>
                <div class="text-end">
                    <span class="badge bg-success fs-6">Ready</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions Section -->
    <div class="quick-actions">
        <h5 class="mb-3"><i class="bi bi-lightning"></i> Quick Actions</h5>
        <div class="row">
            <div class="col-md-3">
                <button class="btn quick-action-btn w-100" onclick="quickInstall('erpnext')">
                    <i class="bi bi-building"></i> Install ERPNext
                </button>
            </div>
            <div class="col-md-3">
                <button class="btn quick-action-btn w-100" onclick="quickInstall('frappe')">
                    <i class="bi bi-gear"></i> Install Frappe
                </button>
            </div>
            <div class="col-md-3">
                <button class="btn quick-action-btn w-100" onclick="quickInstall('hrms')">
                    <i class="bi bi-people"></i> Install HRMS
                </button>
            </div>
            <div class="col-md-3">
                <button class="btn quick-action-btn w-100" onclick="quickInstall('education')">
                    <i class="bi bi-mortarboard"></i> Install Education
                </button>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <ul class="nav nav-tabs card-header-tabs" id="appInstallTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="ui-tab" data-bs-toggle="tab" data-bs-target="#ui-panel" type="button" role="tab">
                                <i class="bi bi-window"></i> Guided Installation
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="console-tab" data-bs-toggle="tab" data-bs-target="#console-panel" type="button" role="tab">
                                <i class="bi bi-terminal"></i> Terminal Access
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="appInstallTabContent">
                        <!-- Guided Installation -->
                        <div class="tab-pane fade show active" id="ui-panel" role="tabpanel">
                            <!-- Step Indicator -->
                            <div class="step-indicator">
                                <div class="step active" id="step-1">
                                    <i class="bi bi-server"></i><br>
                                    <small>Select Container</small>
                                </div>
                                <div class="step" id="step-2">
                                    <i class="bi bi-cloud-download"></i><br>
                                    <small>Get App</small>
                                </div>
                                <div class="step" id="step-3">
                                    <i class="bi bi-box-seam"></i><br>
                                    <small>Install App</small>
                                </div>
                                <div class="step" id="step-4">
                                    <i class="bi bi-check-circle"></i><br>
                                    <small>Complete</small>
                                </div>
                            </div>

                            <!-- Container Selection -->
                            <div class="container-selector">
                                <label for="app-container-select" class="form-label fw-bold">
                                    <i class="bi bi-server"></i> Select App Container
                                </label>
                                <select class="form-select form-select-lg" id="app-container-select">
                                    <option value="">-- Choose a container --</option>
                                    {% for project_name, project_containers in container_groups.items() %}
                                        <optgroup label="{{ project_name }}">
                                            {% for container in project_containers %}
                                                {% if container.service_type == 'App Server' %}
                                                    <option value="{{ container.name }}" 
                                                            data-status="{{ container.status }}"
                                                            data-image="{{ container.image }}">
                                                        {{ container.name }} 
                                                        <span class="text-muted">({{ container.status }})</span>
                                                    </option>
                                                {% endif %}
                                            {% endfor %}
                                        </optgroup>
                                    {% endfor %}
                                </select>
                                <div class="form-text">
                                    <i class="bi bi-info-circle"></i> Select the Frappe app container where you want to install the app
                                </div>
                            </div>

                            <div class="row">
                                <!-- Get App Form -->
                                <div class="col-md-6">
                                    <div class="card app-installation-card h-100">
                                        <div class="card-header bg-primary text-white">
                                            <h5 class="card-title mb-0">
                                                <i class="bi bi-cloud-download"></i> Step 1: Get App
                                            </h5>
                                        </div>
                                        <div class="card-body">
                                            <form id="get-app-form">
                                                <div class="form-floating mb-3">
                                                    <input type="url" class="form-control" id="app-repo-url" 
                                                           placeholder="https://github.com/frappe/erpnext" required>
                                                    <label for="app-repo-url">Git Repository URL</label>
                                                </div>
                                                <div class="form-floating mb-3">
                                                    <input type="text" class="form-control" id="app-branch" 
                                                           placeholder="version-14">
                                                    <label for="app-branch">Branch (Optional)</label>
                                                </div>
                                                <button type="submit" class="btn btn-primary w-100" id="get-app-btn">
                                                    <i class="bi bi-download"></i> Download App
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Install App Form -->
                                <div class="col-md-6">
                                    <div class="card app-installation-card h-100">
                                        <div class="card-header bg-success text-white">
                                            <h5 class="card-title mb-0">
                                                <i class="bi bi-box-seam"></i> Step 2: Install App
                                            </h5>
                                        </div>
                                        <div class="card-body">
                                            <form id="install-app-form">
                                                <div class="form-floating mb-3">
                                                    <input type="text" class="form-control" id="app-name" 
                                                           placeholder="erpnext" required>
                                                    <label for="app-name">App Name</label>
                                                </div>
                                                <div class="form-floating mb-3">
                                                    <input type="text" class="form-control" id="site-name" 
                                                           placeholder="site1.local" required>
                                                    <label for="site-name">Site Name</label>
                                                </div>
                                                <button type="submit" class="btn btn-success w-100" id="install-app-btn">
                                                    <i class="bi bi-box-seam"></i> Install App
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Progress Indicator -->
                            <div class="progress-container" id="progress-container">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="fw-bold">Operation Progress</span>
                                    <span id="progress-status">Preparing...</span>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" style="width: 0%" id="progress-bar"></div>
                                </div>
                            </div>
                            
                            <!-- Results Panel -->
                            <div class="card mt-4">
                                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                                    <h5 class="card-title mb-0">
                                        <i class="bi bi-terminal"></i> Command Output
                                    </h5>
                                    <div>
                                        <span class="status-indicator" id="status-indicator"></span>
                                        <span id="status-text">Ready</span>
                                    </div>
                                </div>
                                <div class="card-body p-0">
                                    <div class="output-container">
                                        <pre id="command-output">Select a container and run a command to see output here...</pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Terminal Access -->
                        <div class="tab-pane fade" id="console-panel" role="tabpanel">
                            <div class="container-selector">
                                <label for="console-container-select" class="form-label fw-bold">
                                    <i class="bi bi-terminal"></i> Select Container for Terminal Access
                                </label>
                                <select class="form-select form-select-lg" id="console-container-select">
                                    <option value="">-- Choose a container --</option>
                                    {% for project_name, project_containers in container_groups.items() %}
                                        <optgroup label="{{ project_name }}">
                                            {% for container in project_containers %}
                                                {% if container.service_type == 'App Server' %}
                                                    <option value="{{ container.name }}">{{ container.name }}</option>
                                                {% endif %}
                                            {% endfor %}
                                        </optgroup>
                                    {% endfor %}
                                </select>
                                <div class="form-text">
                                    <i class="bi bi-info-circle"></i> Select a container to access its terminal for advanced operations
                                </div>
                            </div>
                            
                            <div class="terminal-container" id="terminal-output">
                                <div class="text-center text-muted">
                                    <i class="bi bi-terminal fs-1"></i><br>
                                    <h5>Frappe Docker Terminal</h5>
                                    <p>Select a container to start terminal session...</p>
                                </div>
                            </div>
                            
                            <div class="terminal-input-container">
                                <span class="terminal-prompt" id="terminal-prompt">frappe@container:~$</span>
                                <input type="text" class="terminal-input" id="terminal-input" 
                                       placeholder="Select a container first..." disabled>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0"><i class="bi bi-lightning"></i> Common Commands</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="d-grid gap-2">
                                                <button class="btn btn-outline-primary btn-sm" 
                                                        onclick="insertCommand('bench get-app https://github.com/frappe/erpnext')">
                                                    <i class="bi bi-download"></i> Get ERPNext
                                                </button>
                                                <button class="btn btn-outline-success btn-sm" 
                                                        onclick="insertCommand('bench --site site1.local install-app erpnext')">
                                                    <i class="bi bi-box-seam"></i> Install ERPNext
                                                </button>
                                                <button class="btn btn-outline-info btn-sm" 
                                                        onclick="insertCommand('bench update')">
                                                    <i class="bi bi-arrow-clockwise"></i> Update Bench
                                                </button>
                                                <button class="btn btn-outline-warning btn-sm" 
                                                        onclick="insertCommand('bench migrate')">
                                                    <i class="bi bi-arrow-right"></i> Migrate
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0"><i class="bi bi-clock-history"></i> Command History</h6>
                                        </div>
                                        <div class="card-body p-0">
                                            <div class="command-history" id="command-history">
                                                <div class="text-center text-muted p-3">
                                                    <i class="bi bi-clock-history"></i><br>
                                                    <small>No commands executed yet</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmationModalLabel">
                    <i class="bi bi-exclamation-triangle"></i> Confirm Action
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="confirmationMessage">Are you sure you want to perform this action?</p>
                <div class="alert alert-warning">
                    <i class="bi bi-info-circle"></i> 
                    <span id="confirmationWarning">This operation may take several minutes to complete.</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmActionBtn">Confirm</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
<script>
// Global variables
let selectedContainer = '';
let commandHistory = [];
let currentHistoryIndex = -1;
let currentStep = 1;
let currentWorkingDir = '/home/frappe';

// Initialize UI
document.addEventListener('DOMContentLoaded', function() {
    initializeEventListeners();
    updateStepIndicator();
});

function initializeEventListeners() {
    // Container selection for UI panel
    document.getElementById('app-container-select').addEventListener('change', function() {
        selectedContainer = this.value;
        if (selectedContainer) {
            appendToTerminal(`Connected to container: ${selectedContainer}`);
            appendToTerminal(`Ready for commands...`);
        } else {
            appendToTerminal('Disconnected from container');
        }
    });
    
    // Console container selection for terminal access
    document.getElementById('console-container-select').addEventListener('change', function() {
        selectedContainer = this.value;
        const terminalInput = document.getElementById('terminal-input');
        
        if (selectedContainer) {
            terminalInput.disabled = false;
            terminalInput.placeholder = `Enter command for ${selectedContainer}...`;
            appendToTerminal(`Connected to container: ${selectedContainer}`);
            appendToTerminal(`Ready for commands...`);
            getCurrentDirectory();
        } else {
            terminalInput.disabled = true;
            terminalInput.placeholder = 'Select a container first...';
            appendToTerminal('Disconnected from container');
        }
    });
    
    // Terminal input handling
    const terminalInput = document.getElementById('terminal-input');
    terminalInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && this.value.trim() !== '') {
            const command = this.value.trim();
            executeCommand(command);
            this.value = '';
        } else if (e.key === 'ArrowUp') {
            navigateHistory('up');
            e.preventDefault();
        } else if (e.key === 'ArrowDown') {
            navigateHistory('down');
            e.preventDefault();
        }
    });
    
    // Get App form submission
    document.getElementById('get-app-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const container = document.getElementById('app-container-select').value;
        if (!container) {
            showToast('Please select a container first', 'error');
            return;
        }
        
        const repoUrl = document.getElementById('app-repo-url').value.trim();
        if (!repoUrl) {
            showToast('Please enter a repository URL', 'error');
            return;
        }
        
        const branch = document.getElementById('app-branch').value.trim();
        let command = `bench get-app ${repoUrl}`;
        if (branch) {
            command += ` --branch ${branch}`;
        }
        
        showConfirmationModal(container, command, function() {
            executeApiCommand('get-app', container, {
                repo_url: repoUrl,
                branch: branch
            });
        });
    });
    
    // Install App form submission
    document.getElementById('install-app-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const container = document.getElementById('app-container-select').value;
        if (!container) {
            showToast('Please select a container first', 'error');
            return;
        }
        
        const appName = document.getElementById('app-name').value.trim();
        if (!appName) {
            showToast('Please enter an app name', 'error');
            return;
        }
        
        const siteName = document.getElementById('site-name').value.trim();
        if (!siteName) {
            showToast('Please enter a site name', 'error');
            return;
        }
        
        const command = `bench --site ${siteName} install-app ${appName}`;
        
        showConfirmationModal(container, command, function() {
            executeApiCommand('install-app', container, {
                app_name: appName,
                site_name: siteName
            });
        });
    });
}

// Quick install function for common apps
function quickInstall(appName) {
    const container = document.getElementById('app-container-select').value;
    if (!container) {
        showToast('Please select a container first', 'error');
        return;
    }
    
    const appUrls = {
        'erpnext': 'https://github.com/frappe/erpnext',
        'frappe': 'https://github.com/frappe/frappe',
        'hrms': 'https://github.com/frappe/hrms',
        'education': 'https://github.com/frappe/education'
    };
    
    const repoUrl = appUrls[appName];
    if (!repoUrl) {
        showToast('App not found in quick install list', 'error');
        return;
    }
    
    // Pre-fill the form
    document.getElementById('app-repo-url').value = repoUrl;
    document.getElementById('app-name').value = appName;
    
    showToast(`Pre-filled ${appName} installation form`, 'success');
}

// Update step indicator
function updateStep(step) {
    currentStep = step;
    updateStepIndicator();
}

function updateStepIndicator() {
    for (let i = 1; i <= 4; i++) {
        const stepElement = document.getElementById(`step-${i}`);
        stepElement.classList.remove('active', 'completed');
        
        if (i < currentStep) {
            stepElement.classList.add('completed');
        } else if (i === currentStep) {
            stepElement.classList.add('active');
        }
    }
}

// Execute command via API
async function executeApiCommand(action, container, params) {
    const commandOutput = document.getElementById('command-output');
    const statusIndicator = document.getElementById('status-indicator');
    const statusText = document.getElementById('status-text');
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');
    const progressStatus = document.getElementById('progress-status');
    
    // Show loading state
    commandOutput.textContent = 'Executing command, please wait...';
    statusIndicator.className = 'status-indicator status-running';
    statusText.textContent = 'Running';
    progressContainer.style.display = 'block';
    progressBar.style.width = '30%';
    progressStatus.textContent = 'Executing command...';
    
    try {
        const response = await fetch(`/api/frappe/${action}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                container: container,
                ...params
            })
        });
        
        const result = await response.json();
        
        progressBar.style.width = '100%';
        progressStatus.textContent = 'Complete';
        
        if (result.success) {
            commandOutput.textContent = result.output || 'Command executed successfully';
            statusIndicator.className = 'status-indicator status-success';
            statusText.textContent = 'Success';
            showToast('Command executed successfully', 'success');
            
            if (action === 'get-app') {
                updateStep(3);
            } else if (action === 'install-app') {
                updateStep(4);
            }
        } else {
            commandOutput.textContent = `Error: ${result.error || 'Unknown error occurred'}`;
            statusIndicator.className = 'status-indicator status-error';
            statusText.textContent = 'Error';
            showToast(`Error: ${result.error}`, 'error');
        }
    } catch (error) {
        console.error('Error executing command:', error);
        commandOutput.textContent = `Error: ${error.message}`;
        statusIndicator.className = 'status-indicator status-error';
        statusText.textContent = 'Error';
        showToast(`Error: ${error.message}`, 'error');
    } finally {
        setTimeout(() => {
            progressContainer.style.display = 'none';
            progressBar.style.width = '0%';
        }, 2000);
    }
}

// Execute command in terminal
async function executeCommand(command) {
    if (!selectedContainer) {
        appendToTerminal('Error: No container selected');
        return;
    }
    
    appendToTerminal(`$ ${command}`);
    addToHistory(command);
    
    try {
        const response = await fetch('/api/frappe/execute-command', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                container: selectedContainer,
                command: command
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Update current working directory if provided
            if (result.current_dir) {
                currentWorkingDir = result.current_dir;
                updateTerminalPrompt();
            }
            appendToTerminal(result.output || 'Command executed successfully');
        } else {
            appendToTerminal(`Error: ${result.error || 'Unknown error occurred'}`);
        }
    } catch (error) {
        console.error('Error executing command:', error);
        appendToTerminal(`Error: ${error.message}`);
    }
}

// Update terminal prompt to show current directory
function updateTerminalPrompt() {
    const prompt = document.getElementById('terminal-prompt');
    if (prompt) {
        prompt.textContent = `frappe@${selectedContainer}:${currentWorkingDir}$`;
    }
}

// Get current directory when container is selected
async function getCurrentDirectory() {
    if (!selectedContainer) return;
    
    try {
        const response = await fetch('/api/frappe/get-current-dir', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                container: selectedContainer
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            currentWorkingDir = result.current_dir;
            updateTerminalPrompt();
        }
    } catch (error) {
        console.error('Error getting current directory:', error);
    }
}

// Append text to terminal output
function appendToTerminal(text) {
    const terminal = document.getElementById('terminal-output');
    const timestamp = new Date().toLocaleTimeString();
    terminal.innerHTML += `\n[${timestamp}] ${text}`;
    terminal.scrollTop = terminal.scrollHeight;
}

// Add command to history
function addToHistory(command) {
    // Don't add duplicates consecutively
    if (commandHistory.length === 0 || commandHistory[commandHistory.length - 1] !== command) {
        commandHistory.push(command);
    }
    currentHistoryIndex = commandHistory.length;
    
    // Update history UI
    updateHistoryUI();
}

// Update command history UI
function updateHistoryUI() {
    const historyContainer = document.getElementById('command-history');
    
    if (commandHistory.length === 0) {
        historyContainer.innerHTML = `
            <div class="text-center text-muted p-3">
                <i class="bi bi-clock-history"></i><br>
                <small>No commands executed yet</small>
            </div>
        `;
        return;
    }
    
    historyContainer.innerHTML = '';
    
    // Show most recent commands first
    const recentCommands = [...commandHistory].reverse().slice(0, 10);
    
    recentCommands.forEach(cmd => {
        const item = document.createElement('div');
        item.className = 'command-history-item';
        item.textContent = cmd;
        item.onclick = function() {
            document.getElementById('terminal-input').value = cmd;
        };
        historyContainer.appendChild(item);
    });
}

// Navigate command history
function navigateHistory(direction) {
    if (commandHistory.length === 0) return;
    
    if (direction === 'up') {
        currentHistoryIndex = Math.max(0, currentHistoryIndex - 1);
    } else {
        currentHistoryIndex = Math.min(commandHistory.length, currentHistoryIndex + 1);
    }
    
    const input = document.getElementById('terminal-input');
    if (currentHistoryIndex < commandHistory.length) {
        input.value = commandHistory[currentHistoryIndex];
    } else {
        input.value = '';
    }
}

// Insert predefined command
function insertCommand(command) {
    const input = document.getElementById('terminal-input');
    input.value = command;
    input.focus();
}

// Show confirmation modal
function showConfirmationModal(container, command, callback) {
    const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
    document.getElementById('confirmationMessage').textContent = `Are you sure you want to execute: ${command}`;
    document.getElementById('confirmationWarning').textContent = 'This operation may take several minutes to complete.';
    
    const confirmBtn = document.getElementById('confirmActionBtn');
    confirmBtn.onclick = function() {
        modal.hide();
        if (typeof callback === 'function') {
            callback();
        }
    };
    
    modal.show();
}

// Show toast notification
function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toastContainer') || createToastContainer();
    
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'primary'} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

// Create toast container
function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toastContainer';
    container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
    container.style.zIndex = '11';
    document.body.appendChild(container);
    return container;
}
</script>
{% endblock %}
